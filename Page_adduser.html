<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="fw-bold text-dark mb-1">
                <i class="fas fa-users-cog me-2 text-primary"></i>จัดการผู้ใช้งาน (User Management)
            </h5>
            <small class="text-muted">เพิ่ม ลบ หรือแก้ไขสิทธิ์การใช้งานของพนักงาน</small>
        </div>
        <button class="btn btn-primary rounded-pill shadow-sm fw-bold px-4" onclick="openUserModal()">
            <i class="fas fa-user-plus me-2"></i> เพิ่มพนักงานใหม่
        </button>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-secondary" width="5%">#</th>
                        <th class="py-3 text-secondary" width="30%">User Profile</th>
                        <th class="py-3 text-secondary" width="10%">Role</th>
                        <th class="py-3 text-secondary" width="15%">Team</th>
                        <th class="py-3 text-secondary" width="15%">Status</th>
                        <th class="py-3 text-secondary text-end pe-4" width="25%">Actions</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    <tr><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i> กำลังโหลดข้อมูล...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h6 class="modal-title fw-bold" id="userModalTitle">เพิ่มพนักงานใหม่</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-3">
                <form id="userForm">
                    <input type="hidden" id="original-email">
                    
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">ชื่อ-นามสกุล</label>
                        <input type="text" class="form-control" id="u-name" required placeholder="เช่น สมชาย ใจดี">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">อีเมล (Email)</label>
                        <input type="email" class="form-control" id="u-email" required placeholder="email@company.com">
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="small fw-bold text-muted">ตำแหน่ง (Role)</label>
                            <select class="form-select" id="u-role">
                                <option value="User">User</option>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold text-muted">ทีม (Team)</label>
                            <select class="form-select" id="u-team">
                                <option value="General">General</option>
                                <option value="Content">Content</option>
                                <option value="Graphic">Graphic</option>
                                <option value="VDO">VDO</option>
                                <option value="Ads">Ads</option>
                                <option value="Web">Web</option>
                                <option value="Management">Management</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">สถานะ</label>
                        <select class="form-select" id="u-status">
                            <option value="Active">Active (ใช้งานปกติ)</option>
                            <option value="Inactive">Inactive (ระงับสิทธิ์)</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="small fw-bold text-muted">รูปโปรไฟล์ (URL)</label>
                        <input type="text" class="form-control form-control-sm" id="u-photo" placeholder="https://...">
                        <div class="form-text x-small">ถ้าเว้นว่าง ระบบจะสร้างรูปจากชื่อให้เอง</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="submitUser()" id="btn-save-user">บันทึก</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. ฟังก์ชันโหลดข้อมูล (แบบใหม่: เรียก HTML จากหลังบ้านโดยตรง)
   // ในไฟล์ Page_adduser (ส่วน Script)

    function loadUsers() {
        const tbody = document.getElementById('user-table-body');

        // ✅ เช็คว่ามี HTML ที่เตรียมไว้แล้วหรือไม่
        if (globalData && globalData.userTableHtml) {
            // ถ้ามี: แปะลงไปเลย (เร็วมาก 0 วินาที)
            tbody.innerHTML = globalData.userTableHtml;
        } else {
            // ถ้าไม่มี: ค่อยหมุนติ้วๆ หรือเรียก Server (กรณีกันเหนียว)
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i> กำลังโหลดข้อมูล...</td></tr>';
            
            // กรณีเผื่อโหลดข้อมูลไม่ทัน (Fallback)
            if(typeof google !== 'undefined') {
                 google.script.run.withSuccessHandler(html => {
                     if(globalData) globalData.userTableHtml = html; // เก็บเข้า Cache
                     tbody.innerHTML = html;
                 }).getUserTableHtml();
            }
        }
    }

    // 2. ฟังก์ชันเปิด Modal (ใช้ได้ทั้งเพิ่มใหม่ และ แก้ไข)
    function openUserModal(userEncoded = null) {
        // เคลียร์ฟอร์มให้ว่างก่อน
        document.getElementById('userForm').reset();
        document.getElementById('original-email').value = "";
        
        if (userEncoded) {
            // โหมดแก้ไข (Edit): ถอดรหัสข้อมูล JSON ที่ส่งมาแล้วใส่ลงฟอร์ม
            const user = JSON.parse(decodeURIComponent(userEncoded));
            
            document.getElementById('userModalTitle').innerText = "แก้ไขข้อมูลพนักงาน";
            document.getElementById('original-email').value = user.email; // เก็บ Email เดิมไว้อ้างอิง
            
            document.getElementById('u-name').value = user.name;
            document.getElementById('u-email').value = user.email;
            document.getElementById('u-role').value = user.role;
            document.getElementById('u-team').value = user.team;
            document.getElementById('u-photo').value = user.photoUrl || "";
            document.getElementById('u-status').value = user.status || "Active";
        } else {
            // โหมดเพิ่มใหม่ (Add)
            document.getElementById('userModalTitle').innerText = "เพิ่มพนักงานใหม่";
            document.getElementById('u-status').value = "Active";
        }

        // แสดง Modal
        new bootstrap.Modal(document.getElementById('userModal')).show();
    }

    // 3. ฟังก์ชันบันทึกข้อมูล (Save)
    function submitUser() {
        const btn = document.getElementById('btn-save-user');
        const originalText = btn.innerHTML;
        
        // เปลี่ยนปุ่มเป็นสถานะกำลังโหลด
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> บันทึก...';
        btn.disabled = true;

        // รวบรวมข้อมูลจากฟอร์ม
        const formData = {
            originalEmail: document.getElementById('original-email').value, // ถ้ามีค่า = แก้ไข
            name: document.getElementById('u-name').value,
            email: document.getElementById('u-email').value,
            role: document.getElementById('u-role').value,
            team: document.getElementById('u-team').value,
            photoUrl: document.getElementById('u-photo').value,
            status: document.getElementById('u-status').value
        };

        // ตรวจสอบค่าว่าง (Validation)
        if(!formData.name || !formData.email) {
            alert("กรุณากรอกชื่อและอีเมล");
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }

        // ส่งข้อมูลไปบันทึกที่ Server
        google.script.run.withSuccessHandler(function(res) {
            if(res.success) {
                // 1. ปิด Modal
                bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                
                // ✅ 2. ล้างค่า HTML เก่าทิ้ง (สำคัญมาก! เพื่อให้ระบบรู้ว่าต้องโหลดใหม่)
                if(globalData) globalData.userTableHtml = null; 

                // 3. รีโหลดตารางใหม่ (ซึ่งรอบนี้จะวิ่งไปดึงข้อมูลจริงจาก Server)
                loadUsers(); 
            } else {
                alert("เกิดข้อผิดพลาด: " + res.message);
            }
            
            // คืนค่าปุ่มให้กลับมาเหมือนเดิม
            btn.innerHTML = originalText;
            btn.disabled = false;

        }).saveUserDB(formData);
    }
    // 4. ฟังก์ชันลบผู้ใช้ (Delete)
function deleteUser(email) {
        if(confirm("คุณต้องการลบผู้ใช้งาน " + email + " ใช่หรือไม่?\n(สถานะจะถูกเปลี่ยนเป็น Inactive)")) {
            google.script.run.withSuccessHandler(function(res) {
                if(res.success) {
                    // ✅ 1. ล้างค่า HTML เก่าทิ้ง (เพื่อให้ระบบรู้ว่าข้อมูลเปลี่ยนแล้ว)
                    if(globalData) globalData.userTableHtml = null;

                    // 2. รีโหลดตารางทันที (มันจะไปดึงข้อมูลใหม่จาก Server มาแสดง)
                    loadUsers(); 
                } else {
                    alert("ลบไม่สำเร็จ: " + res.message);
                }
            }).deleteUserDB(email);
        }
    }
</script>
