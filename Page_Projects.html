<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
  :root {
    --primary-color: #0f172a;       
    --accent-color: #2563eb;        
    --bg-light: #f8fafc;            
    --text-main: #334155;
    --text-muted: #64748b;
    --border-color: #e2e8f0;
  }

  .page-header-title { font-weight: 800; color: var(--primary-color); letter-spacing: -0.5px; }
  .search-box { border-radius: 50px; background: #fff; padding-left: 15px; border: 1px solid var(--border-color); }
  
  .project-card {
    background: #fff; border: 1px solid var(--border-color); border-radius: 12px;
    transition: all 0.3s; position: relative; overflow: hidden; height: 100%; display: flex; flex-direction: column;
  }
  .project-card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px -10px rgba(0,0,0,0.1); border-color: #cbd5e1; }

  .card-top-accent { height: 4px; width: 100%; background: var(--border-color); position: absolute; top: 0; left: 0; }
  .card-top-accent.active { background: #10b981; }
  .card-top-accent.pending { background: #64748b; }
  .card-top-accent.hold { background: #f59e0b; }
  .card-top-accent.completed { background: #334155; }

  .project-header { padding: 20px 20px 10px; display: flex; justify-content: space-between; align-items: start; }
  .project-title { font-size: 1.1rem; font-weight: 700; color: var(--primary-color); margin-bottom: 2px; cursor: pointer; }
  .project-title:hover { color: var(--accent-color); text-decoration: underline; }
  .project-body { padding: 10px 20px; flex-grow: 1; }
  
  /* Metrics Grid */
  .metrics-container { display: flex; flex-direction: column; gap: 6px; margin-top: 15px; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #f1f5f9; }
  .metric-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; border-bottom: 1px dashed #e2e8f0; padding-bottom: 4px; }
  .metric-row:last-child { border-bottom: none; padding-bottom: 0; }
  .metric-label { color: var(--text-muted); font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .metric-val { font-weight: 700; color: var(--text-main); }

  /* ‚úÖ Remark Section */
  .remark-section {
    background-color: #fffbeb; border: 1px solid #fef3c7; border-radius: 6px; 
    padding: 8px 12px; margin-top: 10px; font-size: 0.75rem; color: #92400e; line-height: 1.4;
    cursor: pointer; transition: 0.2s; position: relative;
    white-space: pre-wrap; /* ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
    word-break: break-word; /* ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡πÜ */
  }
  .remark-section:hover { background-color: #fef9c3; border-color: #fde68a; }
  .remark-edit-icon { position: absolute; top: 5px; right: 5px; opacity: 0; transition: 0.2s; color: #b45309; }
  .remark-section:hover .remark-edit-icon { opacity: 1; }

  .project-footer { padding: 12px 20px; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
  .status-pill { font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
  .status-active { background: #ecfdf5; color: #047857; } .status-pending { background: #f1f5f9; color: #475569; } .status-hold { background: #fffbeb; color: #b45309; } .status-completed { background: #e2e8f0; color: #1e293b; }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
  
  .btn-view { font-size: 0.8rem; font-weight: 600; color: var(--accent-color); padding: 5px 12px; border-radius: 6px; background: #eff6ff; border:none; transition: 0.2s; }
  .btn-view:hover { background: #dbeafe; color: #1e40af; }
  .mini-progress { width: 60px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 6px; }
  .mini-bar { height: 100%; border-radius: 3px; }
  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô <style> ‡∏Ñ‡∏£‡∏±‡∏ö */
.project-scroll-area {
    /* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏à‡∏≠‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header) ‡∏≠‡∏≠‡∏Å */
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 160px ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á Header ‡∏Ñ‡∏∏‡∏ì */
    height: calc(100vh - 160px); 
    
    /* ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    overflow-y: auto; 
    
    /* ‡∏ã‡πà‡∏≠‡∏ô Scrollbar ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
    overflow-x: hidden; 
    
    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏Ç‡∏≠‡∏ö */
    padding-bottom: 80px; 
    
    /* ‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
    padding-right: 5px; 
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Scrollbar ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Chrome/Safari) */
.project-scroll-area::-webkit-scrollbar {
    width: 8px;
}
.project-scroll-area::-webkit-scrollbar-thumb {
    background-color: #cbd5e1;
    border-radius: 10px;
}
.project-scroll-area::-webkit-scrollbar-track {
    background-color: transparent;
}

/* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö */
.ad-spend-badge {
    background-color: #fff7ed; /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÜ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç */
    color: #c2410c;            /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏° */
    border: 1px solid #ffedd5;
    padding: 4px 10px;
    border-radius: 50px;       /* ‡∏ó‡∏≥‡∏°‡∏ô‡πÜ */
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
    
    /* üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏° */
    max-width: 150px;          /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î */
    white-space: nowrap;       /* ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
    overflow: hidden;          /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô */
}

.ad-spend-text {
    overflow: hidden;
    text-overflow: ellipsis;   /* ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ... ‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
}
</style>

<div class="row align-items-center mb-5 g-3">
  <div class="col-md-5">
    <h3 class="mb-1 page-header-title"><i class="fas fa-layer-group me-2 text-primary opacity-75"></i>‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</h3>
    <small class="text-muted">Dashboard ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</small>
  </div>
  <div class="col-md-7">
    <div class="d-flex gap-2 justify-content-md-end flex-wrap align-items-center">
      <input type="text" class="form-control search-box" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ..." style="width: 200px;" onkeyup="renderProjects()">
      
      <select class="form-select shadow-sm border-0 bg-white fw-bold text-secondary" id="status-filter" style="width: 140px; border-radius: 8px;" onchange="renderProjects()">
        <option value="All">All Status</option>
        <option value="Active">Active</option>
        <option value="Pending">Pending</option>
        <option value="Hold">Hold</option>
        <option value="Completed">Completed</option>
      </select>

      <select class="form-select shadow-sm border-0 bg-white fw-bold text-secondary" id="ae-filter" style="width: 140px; border-radius: 8px;" onchange="renderProjects()">
        <option value="All">All AE</option>
        </select>

      <select class="form-select shadow-sm border-0 bg-white fw-bold text-secondary" id="service-filter" style="width: 140px; border-radius: 8px;" onchange="renderProjects()">
        <option value="All">All Services</option>
        <option value="Content">Content</option>
        <option value="Graphic">Graphic</option>
        <option value="VDO">VDO</option>
        <option value="Ads">Ads</option>
        <option value="Web">Website</option>
        <option value="Admin">Admin</option>
      </select>

      <button id="btn-add-project" class="btn btn-primary shadow px-4 d-none" style="border-radius: 50px;" data-bs-toggle="modal" data-bs-target="#addProjectModal" onclick="prepareProjectModal()">
        <i class="fas fa-plus">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÉ‡∏´‡∏°‡πà</i>
      </button>
    </div>
  </div>
</div>

<div class="project-scroll-area">
    <div class="row g-4" id="project-container"></div>
</div>
<div class="modal fade" id="addProjectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-white border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold text-primary">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÉ‡∏´‡∏°‡πà</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-4">
        <form id="create-project-form">
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *</label><input type="text" class="form-control bg-light border-0" name="customerName" required></div>
            <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label><input type="text" class="form-control bg-light border-0" name="product" required></div>
            <div class="col-md-6"><label class="form-label small fw-bold text-muted">AE ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• *</label><select class="form-select bg-light border-0" name="aeOwner" id="project-ae-select" required></select></div>
            <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label><input type="text" class="form-control bg-light border-0" name="period" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1 ‡∏°.‡∏Ñ. - 31 ‡∏ò.‡∏Ñ."></div>
            
            <div class="col-md-12">
              <label class="form-label text-primary fw-bold small"><i class="fas fa-coins me-1"></i>‡∏á‡∏ö‡∏¢‡∏¥‡∏á‡πÅ‡∏≠‡∏î (Ad Spend)</label>
              <input type="text" class="form-control bg-light border-0" name="budget" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏á‡∏ö‡∏¢‡∏¥‡∏á‡πÅ‡∏≠‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
            </div>

            <div class="col-md-12">
               <label class="form-label text-warning fw-bold small"><i class="fas fa-sticky-note me-1"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Remark)</label>
               <textarea class="form-control bg-light border-0" name="remark" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 1 ‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß..."></textarea>
            </div>

            <div class="col-md-12 border-top pt-3 mt-2">
                <h6 class="fw-bold text-dark mb-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡πÉ‡∏™‡πà 0 ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ)</h6>
                <div class="row g-2">
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text bg-white border"><i class="fas fa-pen-nib text-primary"></i></span><input type="number" class="form-control" name="targetContent" placeholder="Content"></div></div>
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text bg-white border"><i class="fas fa-palette text-purple" style="color:#6f42c1;"></i></span><input type="number" class="form-control" name="targetGraphic" placeholder="Graphic"></div></div>
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text bg-white border"><i class="fas fa-video text-danger"></i></span><input type="number" class="form-control" name="targetVDO" placeholder="VDO"></div></div>
                    
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text bg-white border"><i class="fas fa-comments text-success"></i></span><input type="number" class="form-control" name="targetAdmin" placeholder="Admin"></div></div>
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text bg-white border"><i class="fas fa-ad text-warning"></i></span><input type="number" class="form-control" name="targetAds" placeholder="Ads"></div></div>
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text bg-white border"><i class="fas fa-globe text-info"></i></span><input type="text" class="form-control" name="targetWeb" placeholder="Web"></div></div>
                </div>
            </div>
            
            <div class="col-md-12 mt-3">
              <label class="form-label small fw-bold text-muted">Google Sheet Link</label>
              <input type="url" class="form-control bg-light border-0" name="sheetLink">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-top-0 bg-white pb-4 pe-4">
        <button type="button" class="btn btn-light text-muted fw-bold px-4" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-primary px-4 shadow-sm" style="border-radius: 50px;" onclick="submitNewProject()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="projectUpdateRemarkModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark border-0">
        <h6 class="modal-title fw-bold"><i class="fas fa-edit me-2"></i>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="project-remark-id">
        <label class="form-label small text-muted">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°</label>
        <div id="project-old-remark" class="p-2 bg-light border rounded mb-3 text-muted small" style="white-space: pre-wrap; word-break: break-word;"></div>
        <label class="form-label fw-bold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà</label>
        <textarea id="project-new-remark" class="form-control" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö..."></textarea>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
        <button type="button" class="btn btn-warning btn-sm fw-bold" onclick="saveProjectRemark()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editProjectModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning text-dark border-bottom-0">
        <h5 class="modal-title fw-bold"><i class="fas fa-edit me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-4">
        <form id="edit-project-form">
          <input type="hidden" id="edit-p-id"> <div class="row g-3">
            <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" class="form-control bg-light" id="edit-p-name"></div>
            <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" class="form-control bg-light" id="edit-p-product"></div>
            <div class="col-md-6"><label class="form-label small fw-bold text-muted">AE ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</label><select class="form-select bg-light" id="edit-p-ae"></select></div>
            <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label><input type="text" class="form-control bg-light" id="edit-p-period"></div>
            
            <div class="col-md-12">
              <label class="form-label text-primary fw-bold small">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì / Ad Spend</label>
              <input type="text" class="form-control bg-light" id="edit-p-budget">
            </div>

            <div class="col-md-12 border-top pt-3 mt-2">
                <h6 class="fw-bold text-dark mb-2">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Targets)</h6>
                <div class="row g-2">
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text"><i class="fas fa-pen-nib"></i></span><input type="number" class="form-control" id="edit-t-content" placeholder="Content"></div></div>
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text"><i class="fas fa-palette"></i></span><input type="number" class="form-control" id="edit-t-graphic" placeholder="Graphic"></div></div>
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text"><i class="fas fa-video"></i></span><input type="number" class="form-control" id="edit-t-vdo" placeholder="VDO"></div></div>
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text"><i class="fas fa-comments"></i></span><input type="number" class="form-control" id="edit-t-admin" placeholder="Admin"></div></div>
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text"><i class="fas fa-ad"></i></span><input type="number" class="form-control" id="edit-t-ads" placeholder="Ads"></div></div>
                    <div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text"><i class="fas fa-globe"></i></span><input type="text" class="form-control" id="edit-t-web" placeholder="Web"></div></div>
                </div>
            </div>
            
            <div class="col-md-12 mt-3">
              <label class="form-label small fw-bold text-muted">Google Sheet Link</label>
              <input type="url" class="form-control bg-light" id="edit-p-link">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-top-0 pb-4 pe-4">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-warning fw-bold px-4 shadow-sm" onclick="submitEditProject()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>
  </div>
</div>

<script>
  function renderProjects() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!globalData || !globalData.projects) return;
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏° Dropdown AE (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ï‡∏¥‡∏°)
    initAEFilter();

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ
    const currentUser = globalData.currentUser;
    const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'Manager' || currentUser.role === 'Management';
    if(isAdmin) {
        const btnAdd = document.getElementById('btn-add-project');
        if(btnAdd) btnAdd.classList.remove('d-none');
    }

    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const searchText = document.getElementById('search-input').value.toLowerCase().trim();
    const statusFilter = document.getElementById('status-filter').value;
    const aeFilter = document.getElementById('ae-filter').value;           
    const serviceFilter = document.getElementById('service-filter').value; 

    const container = document.getElementById('project-container');
    
    // 2. Logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Filter Logic)
    let filteredProjects = globalData.projects.filter(p => {
       // --- ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status) ---
       if (statusFilter !== 'All' && p[9] !== statusFilter) return false;
       
       // --- ‡∏Å‡∏£‡∏≠‡∏á AE Owner (p[3]) ---
       if (aeFilter !== 'All' && p[3] !== aeFilter) return false;

       // --- ‡∏Å‡∏£‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Service Type) ---
       // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Target) ‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
       if (serviceFilter !== 'All') {
           let hasService = false;
           // p[6]=Content, p[15]=Graphic, p[7]=VDO, p[12]=Ads, p[13]=Web, p[11]=Admin
           if (serviceFilter === 'Content' && (parseInt(p[6]) > 0)) hasService = true;
           else if (serviceFilter === 'Graphic' && (parseInt(p[15]) > 0)) hasService = true;
           else if (serviceFilter === 'VDO' && (parseInt(p[7]) > 0)) hasService = true;
           else if (serviceFilter === 'Ads' && (parseInt(p[12]) > 0)) hasService = true;
           else if (serviceFilter === 'Web' && (p[13] && p[13] !== '0' && p[13] !== '-')) hasService = true; // Web ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô Text
           else if (serviceFilter === 'Admin' && (parseInt(p[11]) > 0)) hasService = true;
           
           if (!hasService) return false;
       }

       // --- ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search Text) ---
       if (searchText !== '') {
         // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ, ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠ AE
         const searchString = `${p[1]} ${p[2]} ${p[3]}`.toLowerCase();
         if (!searchString.includes(searchText)) return false;
       }
       
       return true; // ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
    });

    // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Sort): Active -> Pending -> Hold -> Completed
    filteredProjects.sort((a,b) => {
      const statusOrder = { 'Active': 1, 'Pending': 2, 'Hold': 3, 'Completed': 4 };
      return (statusOrder[a[9]] || 5) - (statusOrder[b[9]] || 5);
    });

    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (filteredProjects.length === 0) {
      container.innerHTML = `<div class="col-12 text-center mt-5 text-muted py-5"><h5><i class="fas fa-search me-2"></i>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h5></div>`;
      return;
    }

    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML Cards
    let html = '';
    filteredProjects.forEach(p => {
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (Helper Functions ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô Script)
      const contentStats = calculateWorkStats(p[0], ['Content', 'Graphic'], p[6]); 
      const graphicStats = calculateWorkStats(p[0], ['Graphic'], p[15] || 0); 
      const vdoStats = calculateWorkStats(p[0], 'VDO', p[7]);
      const adminStats = calculateWorkStats(p[0], 'Admin', p[11] || 0); 
      const adsStats = calculateWorkStats(p[0], 'Ads', p[12] || 0);     
      const webStats = calculateWorkStats(p[0], 'Web', p[13] || 0);     

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Remark (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô XSS ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)
      let rawRemark = p[14] || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏';
      let safeRemarkDisplay = rawRemark.replace(/</g, "&lt;").replace(/>/g, "&gt;");

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Progress ‡∏£‡∏ß‡∏°
      const overall = calculateOverallProgress(p[0]);
      
      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
      let statusClass = 'active';
      if(p[9] === 'Pending') statusClass = 'pending';
      if(p[9] === 'Hold') statusClass = 'hold';
      if(p[9] === 'Completed') statusClass = 'completed';

      html += `
        <div class="col-xl-4 col-lg-6 col-md-6">
          <div class="project-card h-100">
            <div class="card-top-accent ${statusClass}"></div>
            
            <div class="project-header">
               <div style="flex: 1; padding-right: 10px;">
                  <h5 class="project-title text-truncate" title="${p[1]}" onclick="openProjectDetail('${p[0]}')">${p[1]}</h5>
                  <div class="text-muted small"><i class="fas fa-box me-1"></i> ${p[2]}</div>
               </div>
               
               ${isAdmin ? 
                 `<select class="form-select form-select-sm border-0 bg-light fw-bold text-secondary" style="width:auto; font-size:0.75rem;" onchange="changeStatus('${p[0]}', this.value)">
                    <option value="Active" ${p[9]=='Active'?'selected':''}>Active</option>
                    <option value="Pending" ${p[9]=='Pending'?'selected':''}>Pending</option>
                    <option value="Hold" ${p[9]=='Hold'?'selected':''}>Hold</option>
                    <option value="Completed" ${p[9]=='Completed'?'selected':''}>Done</option>
                  </select>` : 
                 `<span class="status-pill status-${statusClass}"><span class="status-dot"></span>${p[9]}</span>`
               }
            </div>
            
            <div class="project-body">
               <div class="d-flex justify-content-between mb-3 small text-muted">
                  <span><i class="fas fa-user-tie me-1"></i> ${p[3]}</span>
                  <span><i class="far fa-clock me-1"></i> ${p[5]||'-'}</span>
               </div>

               <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-end mb-1">
                     <span class="text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Overall Progress</span>
                     <span class="fw-bold text-primary" style="font-size: 0.8rem;">${overall.percent}%</span>
                  </div>
                  <div class="progress-minimal"><div class="progress-bar-minimal" style="width: ${overall.percent}%"></div></div>
               </div>

               <div class="metrics-container">
                  ${renderMetricRow('Content', 'fa-pen-nib text-primary', contentStats)}
                  ${renderMetricRow('Graphic', 'fa-palette text-purple', graphicStats)}
                  ${renderMetricRow('VDO', 'fa-video text-danger', vdoStats)}
                  ${renderMetricRow('Admin', 'fa-comments text-success', adminStats)}
                  ${renderMetricRow('Ads', 'fa-ad text-warning', adsStats, true)}
                  ${renderMetricRow('Web', 'fa-globe text-info', webStats, true)}
                  
                  ${/* ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏¢‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */ 
                    (contentStats.target==0 && graphicStats.target==0 && vdoStats.target==0 && adminStats.target==0 && adsStats.target==0 && webStats.target==0) 
                    ? '<div class="text-center text-muted small py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>' : ''
                  }
               </div>

               <div class="remark-section" onclick="openProjectRemarkModal('${p[0]}')">
                  <i class="fas fa-pen-square remark-edit-icon"></i>
                  <div>
                     <i class="fas fa-info-circle me-1"></i> 
                     <span>${safeRemarkDisplay}</span>
                  </div>
               </div>
            </div>

            <div class="project-footer">
               <div class="ad-spend-badge" title="‡∏á‡∏ö‡∏¢‡∏¥‡∏á‡πÅ‡∏≠‡∏î: ${p[4] || '-'}">
                  <i class="fas fa-coins text-warning"></i> 
                  <span class="ad-spend-text">${p[4] || '-'}</span>
               </div>
               
               <div class="d-flex gap-2 flex-shrink-0">
                   <button class="btn btn-white btn-sm border text-secondary shadow-sm" 
                           onclick="event.stopPropagation(); openEditProjectModal('${p[0]}')" 
                           title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                       <i class="fas fa-pen"></i>
                   </button>

                   <button class="btn-view" onclick="openProjectDetail('${p[0]}')">
                     Manage <i class="fas fa-arrow-right ms-1"></i>
                   </button>
               </div>
            </div>
          </div>
        </div>`;
    });

    container.innerHTML = html;
  }

  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö Page_Detail
  function openProjectRemarkModal(projectId) {
      const p = globalData.projects.find(x => x[0] === projectId);
      const oldText = p ? (p[14] || '') : '';

      // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ID ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      document.getElementById('project-remark-id').value = projectId;
      document.getElementById('project-old-remark').innerText = oldText || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°';
      document.getElementById('project-new-remark').value = '';
      
      new bootstrap.Modal(document.getElementById('projectUpdateRemarkModal')).show();
  }

  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
  function saveProjectRemark() {
      const pid = document.getElementById('project-remark-id').value;
      const newText = document.getElementById('project-new-remark').value;
      if(!newText) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°');

      const btn = event.target;
      btn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;

      const user = globalData.currentUser.name || 'Admin';
      const time = new Date().toLocaleString('th-TH', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'});
      const fullText = `${newText} (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢ ${user} ${time})`;

      google.script.run.withSuccessHandler(() => {
          const p = globalData.projects.find(x => x[0] === pid);
          if(p) p[14] = fullText;
          renderProjects();
          bootstrap.Modal.getInstance(document.getElementById('projectUpdateRemarkModal')).hide();
          btn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; btn.disabled = false;
      }).updateProjectRemark(pid, fullText); 
  }

  // --- Helper Functions ---
  function calculateWorkStats(projectId, taskTypes, targetQty) {
    let target = 0;
    if (targetQty) target = parseInt(targetQty) || 0;
    if (target === 0) return { target: 0, done: 0, percent: 0, total: 0 };
    if(!globalData.tasks) return { target, done: 0, percent: 0, total: 0 };
    const tasks = globalData.tasks.filter(t => t[1] === projectId && (Array.isArray(taskTypes) ? taskTypes.includes(t[2]) : t[2] === taskTypes));
    const done = tasks.filter(t => t[5] === 'Done').length;
    const total = tasks.length;
    let avgProgress = 0;
    if (total > 0) {
       let sumPct = 0; tasks.forEach(t => sumPct += (parseInt(t[6]) || 0));
       avgProgress = Math.round(sumPct / total);
    }
    return { target, done, total, percent: avgProgress };
  }

  function renderMetricRow(label, iconClass, stats, isWeb = false) {
    if (!stats.target || stats.target === 0) return '';
    let valueHtml = '';
    if (isWeb) {
        valueHtml = `<div class="d-flex align-items-center"><div class="mini-progress"><div class="mini-bar bg-info" style="width: ${stats.percent}%"></div></div><span class="small fw-bold text-dark">${stats.percent}%</span></div>`;
    } else {
        const isComplete = stats.done >= stats.target;
        const colorClass = isComplete ? 'text-success' : 'text-dark';
        valueHtml = `<span class="${colorClass}">${stats.done}</span> <span class="text-muted fw-normal small">/ ${stats.target}</span>`;
    }
    return `<div class="metric-row"><span class="metric-label"><i class="fas ${iconClass}" style="width:16px;"></i> ${label}</span><span class="metric-val">${valueHtml}</span></div>`;
  }

  function calculateOverallProgress(pid) {
    if(!globalData.tasks) return { percent: 0 };
    const t = globalData.tasks.filter(x => x[1] === pid);
    const d = t.filter(x => x[5] === 'Done').length;
    return { percent: t.length ? Math.round((d/t.length)*100) : 0, done:d, total:t.length };
  }

  function prepareProjectModal() {
    const select = document.getElementById('project-ae-select');
    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å AE --</option>';
    if(globalData.allUsers) globalData.allUsers.forEach(u => select.innerHTML+=`<option value="${u.name || u}">${u.name || u}</option>`);
  }

  function submitNewProject() {
    const f = document.getElementById('create-project-form');
    
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
    if(!f.customerName.value || !f.product.value || !f.aeOwner.value) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (*) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
        return;
    }

    // 2. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."
    const btn = event.target; // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ ID ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    btn.disabled = true;

    const data = {
        customerName: f.customerName.value, product: f.product.value, aeOwner: f.aeOwner.value,
        period: f.period.value, budget: f.budget.value, sheetLink: f.sheetLink.value,
        targetContent: f.targetContent.value, targetGraphic: f.targetGraphic.value,
        targetVDO: f.targetVDO.value, targetAdmin: f.targetAdmin.value, 
        targetAds: f.targetAds.value, targetWeb: f.targetWeb.value,
        remark: f.remark.value
    };

    google.script.run.withSuccessHandler((res) => {
        // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ Server ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ô res.data (‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô)
        // ‡∏ñ‡πâ‡∏≤ Server ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£ push ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• dummy ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ reload ‡πÉ‡∏´‡∏°‡πà
        
        if(res && res.success) {
             // 3.1 ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ globalData ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ renderProjects ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà)
             if(res.data) {
                 globalData.projects.push(res.data);
             } else {
                 // ‡∏Å‡∏£‡∏ì‡∏µ Server ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á data ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢)
                 // loadSystemData(); return; 
             }

             // 3.2 ‡∏õ‡∏¥‡∏î Modal
             bootstrap.Modal.getInstance(document.getElementById('addProjectModal')).hide();
             
             // 3.3 ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
             f.reset();

             // 3.4 ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà
             renderProjects();

             // 3.5 ‚úÖ ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏•‡∏á‡πÑ‡∏õ‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î (Scroll to Bottom)
             setTimeout(() => {
                 const container = document.getElementById('project-container');
                 // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà element ‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                 if(container.lastElementChild) {
                     container.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     
                     // ‡πÄ‡∏û‡∏¥‡πà‡∏° Effect ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (Optional)
                     container.lastElementChild.style.transition = "0.5s";
                     container.lastElementChild.style.transform = "scale(1.02)";
                     setTimeout(() => container.lastElementChild.style.transform = "scale(1)", 500);
                 }
             }, 300); // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ HTML render ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
             
        } else {
             alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (res ? res.message : 'Unknown Error'));
        }

        // 4. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
        btn.innerHTML = originalText;
        btn.disabled = false;

    }).createProject(data); 
}
  function changeStatus(pid, status) {
      google.script.run.updateProjectStatus(pid, status);
      const p = globalData.projects.find(x=>x[0]===pid); if(p) p[9]=status;
      renderProjects();
  }

  // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà
  function openEditProjectModal(pid) {
      const p = globalData.projects.find(x => x[0] === pid);
      if(!p) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Dropdown AE
      const aeSelect = document.getElementById('edit-p-ae');
      aeSelect.innerHTML = '';
      if(globalData.allUsers) globalData.allUsers.forEach(u => {
          let name = u.name || u;
          aeSelect.innerHTML += `<option value="${name}" ${name===p[3]?'selected':''}>${name}</option>`;
      });

      // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô Input (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Index ‡∏ï‡∏≤‡∏° CSV)
      document.getElementById('edit-p-id').value = p[0];
      document.getElementById('edit-p-name').value = p[1];
      document.getElementById('edit-p-product').value = p[2];
      // document.getElementById('edit-p-ae').value = p[3]; // ‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á option
      document.getElementById('edit-p-budget').value = p[4];
      document.getElementById('edit-p-period').value = p[5];
      document.getElementById('edit-t-content').value = p[6];
      document.getElementById('edit-t-vdo').value = p[7];
      document.getElementById('edit-p-link').value = p[8];
      
      document.getElementById('edit-t-admin').value = p[11] || 0;
      document.getElementById('edit-t-ads').value = p[12] || 0;
      document.getElementById('edit-t-web').value = p[13] || 0;
      document.getElementById('edit-t-graphic').value = p[15] || 0;

      new bootstrap.Modal(document.getElementById('editProjectModal')).show();
  }

  // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  function submitEditProject() {
      const pid = document.getElementById('edit-p-id').value;
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
      btn.disabled = true;

      const updateData = {
          id: pid,
          customerName: document.getElementById('edit-p-name').value,
          product: document.getElementById('edit-p-product').value,
          aeOwner: document.getElementById('edit-p-ae').value,
          budget: document.getElementById('edit-p-budget').value,
          period: document.getElementById('edit-p-period').value,
          sheetLink: document.getElementById('edit-p-link').value,
          targetContent: document.getElementById('edit-t-content').value,
          targetGraphic: document.getElementById('edit-t-graphic').value,
          targetVDO: document.getElementById('edit-t-vdo').value,
          targetAdmin: document.getElementById('edit-t-admin').value,
          targetAds: document.getElementById('edit-t-ads').value,
          targetWeb: document.getElementById('edit-t-web').value
      };

      google.script.run.withSuccessHandler((res) => {
          if(res.success) {
              // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ globalData ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
              const idx = globalData.projects.findIndex(x => x[0] === pid);
              if(idx !== -1) {
                  globalData.projects[idx] = res.data;
              }
              
              // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
              renderProjects();
              bootstrap.Modal.getInstance(document.getElementById('editProjectModal')).hide();
              // alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          } else {
              alert('Error: ' + res.message);
          }
          btn.innerHTML = originalText;
          btn.disabled = false;
      }).updateProjectDB(updateData);
  }

  function initAEFilter() {
      const aeSelect = document.getElementById('ae-filter');
      
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ã‡πâ‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 option ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß)
      if (aeSelect && aeSelect.options.length > 1) return; 

      if (globalData.allUsers) {
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å-‡∏Æ
          const sortedUsers = [...globalData.allUsers].sort((a, b) => {
              const nameA = (a.name || a).toLowerCase();
              const nameB = (b.name || b).toLowerCase();
              return nameA.localeCompare(nameB);
          });

          sortedUsers.forEach(u => {
              let name = u.name || u;
              // ‡∏™‡∏£‡πâ‡∏≤‡∏á Option
              const opt = document.createElement('option');
              opt.value = name;
              opt.innerText = name;
              aeSelect.appendChild(opt);
          });
      }
  }
</script>
