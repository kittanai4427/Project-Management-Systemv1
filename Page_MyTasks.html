<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<style>
  /* --- Modern Formal Theme --- */
  :root {
    --f-bg: #f3f4f6;
    --f-card-bg: #ffffff;
    --f-border: #e5e7eb;
    --f-text-head: #1e293b;
    --f-text-body: #475569;
    --f-primary: #0f172a;
    --f-accent: #2563eb;
    --f-success: #10b981;
    --f-warning: #f59e0b;
    --f-danger: #ef4444;
  }

  body { background-color: var(--f-bg); font-family: 'Sarabun', sans-serif; color: var(--f-text-body); }

  /* Navigation */
  .my-toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
  .my-btn-nav { background: white; padding: 4px; border-radius: 50px; border: 1px solid var(--f-border); display: inline-flex; }
  .my-btn-nav .btn { border: none; border-radius: 50px; color: #64748b; font-size: 0.85rem; font-weight: 500; padding: 6px 16px; transition: 0.2s; }
  .my-btn-nav .btn:hover { background-color: #f1f5f9; color: var(--f-primary); }
  .my-btn-nav .btn.active { background-color: var(--f-primary); color: white; box-shadow: 0 2px 4px rgba(15, 23, 42, 0.2); }

  .my-search-box { position: relative; width: 220px; }
  .my-search-box input { padding-left: 35px; border-radius: 50px; font-size: 0.85rem; border-color: var(--f-border); height: 36px; }
  .my-search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
  .my-filter-select { border-radius: 50px; font-size: 0.85rem; border-color: var(--f-border); height: 36px; padding-left: 15px; width: 140px; }

  /* --- Task Card (List View) --- */
  .my-task-card {
    background: var(--f-card-bg); border: 1px solid var(--f-border); border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.02); transition: all 0.2s ease-in-out;
    position: relative; overflow: hidden; height: 100%; cursor: pointer; display: flex; flex-direction: column;
  }
  .my-task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-color: #cbd5e1; }
  
  .my-status-strip { position: absolute; top: 0; bottom: 0; left: 0; width: 5px; background-color: #94a3b8; }
  .my-status-strip.doing { background-color: var(--f-accent); }
  .my-status-strip.revise { background-color: var(--f-danger); } 
  .my-status-strip.new { background-color: var(--f-success); }   
  
  .my-card-content { padding: 20px 20px 20px 28px; display: flex; flex-direction: column; height: 100%; justify-content: space-between; }
  .my-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .my-project-label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; background: #f8fafc; padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0; max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .my-task-title { font-size: 1.1rem; font-weight: 700; color: var(--f-text-head); margin-bottom: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  
  .my-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 0.85rem; }
  .my-info-block { display: flex; flex-direction: column; }
  .my-info-label { font-size: 0.7rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
  .my-info-value { font-weight: 600; color: var(--f-text-head); }
  .my-info-value.overdue { color: var(--f-danger); }

  .my-step-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-bottom: 15px; font-size: 0.85rem; display: flex; gap: 8px; align-items: flex-start; }
  .my-step-icon { color: var(--f-accent); margin-top: 2px; }
  .my-step-text { color: #475569; line-height: 1.4; }
  .my-action-area { margin-top: auto; }
  .my-btn-action { width: 100%; border-radius: 8px; font-weight: 600; padding: 8px; font-size: 0.9rem; letter-spacing: 0.3px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .my-btn-action:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

  /* View Container Setup */
  .my-view-section { height: calc(100vh - 160px); overflow-y: auto; padding-bottom: 120px; padding-right: 5px; }
  .my-view-section::-webkit-scrollbar { width: 6px; }
  .my-view-section::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

  /* --- Other Views --- */
  .my-board-container { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; height: 100%; align-items: flex-start; }
  .my-board-col { flex: 1; min-width: 320px; max-width: 400px; background: #f1f5f9; border-radius: 12px; padding: 12px; max-height: 100%; display: flex; flex-direction: column; }
  .my-calendar-wrapper { background: white; border-radius: 12px; border: 1px solid var(--f-border); padding: 20px; }
  
  /* --- Content Plan Agenda --- */
  .my-agenda-container { display: flex; flex-direction: column; gap: 15px; }
  .my-agenda-block { background: white; border: 1px solid var(--f-border); border-radius: 10px; overflow: hidden; }
  .my-agenda-header { background: #f8fafc; padding: 10px 15px; border-bottom: 1px solid var(--f-border); display: flex; justify-content: space-between; align-items: center; }
  .my-agenda-row { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 15px; transition: 0.1s; cursor: pointer; }
  .my-agenda-row:hover { background-color: #f8faff; }

  /* Badges */
  .my-badge-media { font-weight: normal; border: 1px solid; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
  .my-badge-video { background-color: #fae8ff; color: #86198f; border-color: #f0abfc; }
  .my-badge-single { background-color: #e0f2fe; color: #0369a1; border-color: #bae6fd; }
  .my-badge-default { background-color: #f1f5f9; color: #475569; border-color: #e2e8f0; }

  /* FullCalendar Custom */
  #my-task-calendar { font-family: 'Sarabun', sans-serif; background: white; padding: 15px; border-radius: 12px; border: 1px solid var(--f-border); min-height: 600px; }
</style>

<div class="row mb-4 align-items-center g-3">
  <div class="col-lg-4">
    <h4 class="mb-1 fw-bold" style="color:var(--f-primary); letter-spacing: -0.5px;">
      <i class="fas fa-user-check me-2 text-primary"></i>‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (My Tasks)
    </h4>
    <small class="text-muted d-block ps-1">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</small>
  </div>
  
  <div class="col-lg-8">
    <div class="my-toolbar">
       <div class="my-search-box">
          <i class="fas fa-search"></i>
          <input type="text" class="form-control" id="my-task-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô..." onkeyup="myRenderTasks()">
       </div>
       <select class="form-select my-filter-select" id="my-task-filter" onchange="myRenderTasks()">
          <option value="All">All Status</option>
          <option value="Pending">New / Pending</option>
          <option value="Doing">Doing</option>
          <option value="Revise">Revise</option>
       </select>

       <div class="my-btn-nav shadow-sm">
          <button class="btn active" id="btn-my-list" onclick="mySwitchView('list')"><i class="fas fa-list-ul me-2"></i>List</button>
          <button class="btn" id="btn-my-board" onclick="mySwitchView('board')"><i class="fas fa-columns me-2"></i>Board</button>
          <button class="btn" id="btn-my-calendar" onclick="mySwitchView('calendar')"><i class="far fa-calendar-alt me-2"></i>Calendar</button>
          <button class="btn" id="btn-my-content" onclick="mySwitchView('content')"><i class="fas fa-photo-video me-2"></i>Content Plan</button>
       </div>
    </div>
  </div>
</div>

<div id="view-my-list" class="my-view-section">
  <div id="my-todo-container" class="row g-4"></div>
</div>

<div id="view-my-board" class="my-view-section" style="display:none;">
  <div class="my-board-container">
    <div class="my-board-col">
       <div class="d-flex justify-content-between align-items-center bg-secondary text-white p-3 rounded-top mb-3 fw-bold shadow-sm">
          <span><i class="fas fa-inbox me-2"></i>‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (Pending)</span>
          <span class="badge bg-white text-dark rounded-pill" id="my-count-todo">0</span>
       </div>
       <div style="overflow-y:auto; flex-grow:1; padding-right:5px;" id="my-board-todo"></div>
    </div>
    <div class="my-board-col">
       <div class="d-flex justify-content-between align-items-center bg-primary text-white p-3 rounded-top mb-3 fw-bold shadow-sm">
          <span><i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ (Doing)</span>
          <span class="badge bg-white text-dark rounded-pill" id="my-count-doing">0</span>
       </div>
       <div style="overflow-y:auto; flex-grow:1; padding-right:5px;" id="my-board-doing"></div>
    </div>
  </div>
</div>

<div id="view-my-calendar" class="my-view-section" style="display:none;">
    <div id='my-task-calendar'></div>
</div>

<div id="view-my-content" class="my-view-section" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
         <div>
             <h5 class="fw-bold text-primary mb-0"><i class="fas fa-calendar-day me-2"></i>Content Plan</h5>
             <small class="text-muted" id="my-content-subtitle">...</small>
         </div>
         <div class="btn-group shadow-sm rounded-pill">
            <button class="btn btn-white border btn-sm" onclick="myChangeContentMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <button class="btn btn-white border btn-sm fw-bold px-3" onclick="myContentDate = new Date(); myRenderContentPlan();">Today</button>
            <button class="btn btn-white border btn-sm" onclick="myChangeContentMonth(1)"><i class="fas fa-chevron-right"></i></button>
         </div>
    </div>
    <div class="my-agenda-container" id="my-content-container"></div>
</div>

<div class="modal fade" id="mySubmitModal" tabindex="-1" style="z-index: 1060;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
      <div class="modal-header text-white" style="background-color: var(--f-primary);">
        <h6 class="modal-title fw-bold"><i class="fas fa-paper-plane me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏≥‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (Submit)</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <input type="hidden" id="my-submit-tid"> <input type="hidden" id="my-submit-pid"> 
        <input type="hidden" id="my-submit-sidx"> <input type="hidden" id="my-submit-sname">

        <div class="d-flex align-items-center mb-4 p-3 bg-light rounded border border-primary-subtle">
           <div class="bg-white rounded-circle p-2 shadow-sm me-3 text-primary"><i class="fas fa-info-circle fs-4"></i></div>
           <div>
              <div class="small text-muted text-uppercase fw-bold" style="font-size:0.65rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</div>
              <strong class="text-dark fs-6" id="my-submit-display">-</strong>
           </div>
        </div>
        <div class="mb-3">
          <label class="form-label small fw-bold text-muted">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à <span class="text-danger">*</span></label>
          <textarea id="my-submit-msg" class="form-control bg-light" rows="3"></textarea>
        </div>
        <div class="mb-3">
           <label class="form-label small fw-bold text-muted">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå</label>
           <input type="file" id="my-submit-file" class="form-control form-control-sm">
        </div>
        <div class="mb-2">
           <label class="form-label small fw-bold text-muted">‡∏•‡∏¥‡∏á‡∏Å‡πå (URL)</label>
           <input type="url" id="my-submit-link" class="form-control form-control-sm bg-light">
        </div>
      </div>
      <div class="modal-footer border-0 pt-0 pb-4 px-4">
        <button type="button" class="btn btn-light btn-sm rounded-pill px-4" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-primary btn-sm px-4 fw-bold rounded-pill shadow-sm" onclick="myConfirmSubmit()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="myTaskDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
      <div id="my-modal-header" class="modal-header text-white" style="border-top-left-radius: 12px; border-top-right-radius: 12px;">
        <div>
            <div class="badge bg-white/20 text-white border border-white/30 mb-2" id="my-modal-state">STATE</div>
            <h5 class="modal-title fw-bold" id="my-modal-title">Task Name</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row mb-4">
            <div class="col-8 border-end">
                <small class="text-muted d-block text-uppercase fw-bold mb-1" style="font-size:0.65rem;">Project</small>
                <div class="fw-bold text-primary text-truncate" id="my-modal-project">-</div>
            </div>
            <div class="col-4 ps-3">
                <small class="text-muted d-block text-uppercase fw-bold mb-1" style="font-size:0.65rem;">Due Date</small>
                <div class="fw-bold" id="my-modal-due">-</div>
            </div>
        </div>
        <div class="bg-light p-3 rounded-3 border mb-4">
            <h6 class="fw-bold text-dark mb-2 small text-uppercase"><i class="fas fa-shoe-prints me-2 text-secondary"></i>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h6>
            <div class="d-flex align-items-center text-dark mb-2 ms-1">
                <i class="fas fa-tag me-2 text-primary"></i> <span id="my-modal-step" class="fw-bold fs-6">-</span>
            </div>
            <div class="small text-muted p-2 bg-white border rounded ms-1">
                <i class="fas fa-info-circle me-1"></i> <span id="my-modal-desc">-</span>
            </div>
        </div>
        <div class="mb-4">
            <h6 class="small fw-bold text-muted text-uppercase mb-2">Attachments</h6>
            <div id="my-modal-attach" class="d-flex flex-column gap-2"></div>
        </div>
        <div id="my-modal-remark-box" style="display:none;">
            <h6 class="small fw-bold text-muted text-uppercase mb-2">Note / Remark</h6>
            <div class="alert alert-warning small mb-0 text-break" id="my-modal-remark" style="white-space: pre-wrap;"></div>
        </div>
      </div>
      <div class="modal-footer bg-light border-0 justify-content-between py-3 px-4" style="border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;">
         <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill px-3" onclick="myGoToProject()">
            <i class="fas fa-external-link-alt me-1"></i> Project Detail
         </button>
         <div id="my-modal-action"></div>
      </div>
    </div>
  </div>
</div>

<script>
  let myViewDate = new Date();
  let myContentDate = new Date();
  let myActiveView = 'list';
  let myTempPid = null;
  let myCalInstance = null;

  function renderMyTasks() { 
      // Changed function name to myRenderTasks to avoid conflict
      myRenderTasks();
  }
  
  function myRenderTasks() {
      const filterStatus = document.getElementById('my-task-filter').value;
      const searchText = document.getElementById('my-task-search').value.toLowerCase();
      
      if(myActiveView === 'list') myRenderList(filterStatus, searchText); 
      else if(myActiveView === 'board') myRenderBoard(filterStatus, searchText);
      else if(myActiveView === 'calendar') setTimeout(() => myRenderCalendar(), 100);
      else if(myActiveView === 'content') myRenderContentPlan();
  }

  // --- Logic ---
  function myGetTasks(filterStatus, searchText) {
      const myName = globalData.currentUser.name;
      let tasks = [];
      globalData.tasks.forEach(t => {
          if (t[5] === 'Done') return; 
          let steps = []; try { steps = t[12] ? JSON.parse(t[12]) : []; } catch(e) { steps = []; }
          const mySteps = steps.filter(s => s.assignee === myName && s.status !== 'done');
          
          if (mySteps.length > 0) {
              let cur = mySteps[0]; 
              let data = [...t];
              data.stepName = cur.name;
              data.stepDetails = cur.details || '';
              data.effectiveDue = cur.dueDate ? cur.dueDate : (t[7] || ''); 
              data.stepIdx = steps.indexOf(cur);
              data.stepStat = cur.status; 
              
              let match = true;
              if (filterStatus && filterStatus !== 'All') {
                  if (filterStatus === 'Doing' && data.stepStat !== 'doing') match = false;
                  else if (filterStatus === 'Pending' && (data.stepStat !== 'pending' || t[5] === 'Revise')) match = false;
                  else if (filterStatus === 'Revise' && t[5] !== 'Revise') match = false;
              }
              if (searchText) {
                  const txt = (t[3] + t[1]).toLowerCase();
                  if (!txt.includes(searchText)) match = false;
              }
              if (match) tasks.push(data);
          }
      });
      return tasks;
  }

  // --- 1. LIST ---
  function myRenderList(fs, st) {
    const con = document.getElementById('my-todo-container');
    const tasks = myGetTasks(fs, st);
    tasks.sort((a, b) => new Date(a.effectiveDue || '2999-12-31') - new Date(b.effectiveDue || '2999-12-31'));

    if (tasks.length === 0) { con.innerHTML = `<div class="col-12 text-center py-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô</div>`; return; }

    const groups = { overdue: [], today: [], upcoming: [], noDate: [] };
    const today = new Date(); today.setHours(0,0,0,0);
    
    tasks.forEach(t => {
      if (!t.effectiveDue) { groups.noDate.push(t); return; }
      const d = new Date(t.effectiveDue); d.setHours(0,0,0,0);
      if (d < today) groups.overdue.push(t); else if (d.getTime() === today.getTime()) groups.today.push(t); else groups.upcoming.push(t);
    });

    let html = '';
    html += myGenGroup('‚ö†Ô∏è Overdue', groups.overdue, 'text-danger');
    html += myGenGroup('üìÖ Today', groups.today, 'text-primary');
    html += myGenGroup('üîú Upcoming', groups.upcoming, 'text-dark');
    html += myGenGroup('üìå No Date', groups.noDate, 'text-secondary');
    con.innerHTML = html;
  }

  function myGenGroup(title, tasks, color) {
    if (tasks.length === 0) return '';
    let html = `<div class="col-12 mt-4"><h6 class="fw-bold border-bottom pb-2 mb-3 ${color}">${title} <span class="badge bg-light text-dark border ms-2 rounded-pill">${tasks.length}</span></h6></div>`;
    tasks.forEach(t => html += myCreateCard(t));
    return html;
  }

  function myCreateCard(t) {
      const p = globalData.projects.find(x => x[0] === t[1]);
      const cName = p ? p[1] : '-';
      let typeClass = t[14] ? 'my-badge-video' : 'my-badge-default';
      let strip = t.stepStat === 'doing' ? 'doing' : 'new';
      if(t[5] === 'Revise') strip = 'revise';
      let isOver = t.effectiveDue && new Date(t.effectiveDue) < new Date().setHours(0,0,0,0);
      if(isOver && t[5] !== 'Revise') strip = 'revise'; // Use revise color for overdue

      let btn = '';
      if (t.stepStat === 'doing') btn = `<button class="btn btn-primary my-btn-action text-white" onclick="event.stopPropagation(); myOpenSubmit('${t[0]}', '${t[1]}', ${t.stepIdx}, '${t.stepName}')">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>`;
      else btn = `<button class="btn btn-outline-primary my-btn-action" onclick="event.stopPropagation(); myStartStep('${t[0]}', ${t.stepIdx})">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥</button>`;

      return `
        <div class="col-md-6 col-xl-4">
          <div class="my-task-card" onclick="myOpenDetail('${t[0]}')">
            <div class="my-status-strip ${strip}"></div>
            <div class="my-card-content">
              <div>
                  <div class="my-card-header">
                     <div class="my-project-label text-truncate">${cName}</div>
                     <span class="badge ${typeClass} my-badge-media ms-2">${t[14] || t[2]}</span>
                  </div>
                  <h6 class="my-task-title">${t[3]}</h6>
                  <div class="my-info-grid">
                      <div class="my-info-block"><span class="my-info-label">Due</span><span class="my-info-value ${isOver?'overdue':''}">${t.effectiveDue || '-'}</span></div>
                      <div class="my-info-block text-end"><span class="my-info-label">Step</span><span class="my-info-value text-primary">${t.stepName}</span></div>
                  </div>
              </div>
              <div class="my-action-area">${btn}</div>
            </div>
          </div>
        </div>`;
  }

  // ================= 2. BOARD =================
  function myRenderBoard(fs, st) {
      const tasks = myGetTasks(fs, st);
      const todo = tasks.filter(t => t.stepStat === 'pending');
      const doing = tasks.filter(t => t.stepStat === 'doing');
      document.getElementById('my-count-todo').innerText = todo.length;
      document.getElementById('my-count-doing').innerText = doing.length;
      document.getElementById('my-board-todo').innerHTML = todo.length ? todo.map(t => myCreateBoardCard(t)).join('') : '<div class="text-center text-muted mt-5 small">Empty</div>';
      document.getElementById('my-board-doing').innerHTML = doing.length ? doing.map(t => myCreateBoardCard(t)).join('') : '<div class="text-center text-muted mt-5 small">Empty</div>';
  }

  function myCreateBoardCard(t) {
      const p = globalData.projects.find(x => x[0] === t[1]);
      const cName = p ? p[1] : '-';
      let btn = t.stepStat === 'doing' ? `<button class="btn btn-sm btn-primary w-100 rounded-pill mt-2 shadow-sm" onclick="event.stopPropagation(); myOpenSubmit('${t[0]}', '${t[1]}', ${t.stepIdx}, '${t.stepName}')">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>` : `<button class="btn btn-sm btn-outline-primary w-100 rounded-pill mt-2" onclick="event.stopPropagation(); myStartStep('${t[0]}', ${t.stepIdx})">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥</button>`;
      return `
        <div class="my-task-card mb-2" onclick="myOpenDetail('${t[0]}')" style="box-shadow:none; border:1px solid #e2e8f0;">
           <div class="p-3">
              <div class="d-flex justify-content-between mb-2">
                  <span class="badge bg-light text-secondary border fw-normal" style="font-size:0.65rem;">${t[2]}</span>
                  <span class="small text-muted fw-bold text-truncate" style="max-width:100px;">${cName}</span>
              </div>
              <h6 class="fw-bold mb-2 text-dark" style="font-size:0.9rem; line-height:1.3;">${t[3]}</h6>
              <div class="small text-secondary mb-2">${t.stepName}</div>
              ${t.effectiveDue ? `<div class="small text-danger fw-bold mb-2">${t.effectiveDue}</div>` : ''}
              ${btn}
           </div>
        </div>`;
  }

  // ================= 3. CALENDAR =================
  function myRenderCalendar() {
      const el = document.getElementById('my-task-calendar');
      if (!el || typeof FullCalendar === 'undefined') return;
      if (myCalInstance) myCalInstance.destroy();

      const tasks = myGetTasks('All', '');

      myCalInstance = new FullCalendar.Calendar(el, {
          initialView: 'dayGridMonth',
          headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
          height: '100%',
          events: tasks.map(t => {
              let cls = 'pending';
              if (t.stepStat === 'doing') cls = 'doing';
              if (t[5] === 'Revise') cls = 'revise';
              if (t.stepStat === 'pending' && t[5] !== 'Revise') cls = 'new';
              return { id: t[0], title: t[3], start: t.effectiveDue || new Date(), extendedProps: { classType: cls } };
          }),
          eventClick: function(info) { myOpenDetail(info.event.id); },
          eventContent: function(arg) {
              return { html: `<div class="fc-event-content-box ${arg.event.extendedProps.classType}">${arg.event.title}</div>` };
          }
      });
      myCalInstance.render();
  }

  // ================= 4. CONTENT PLAN =================
  function myChangeContentMonth(step) {
    myContentDate.setMonth(myContentDate.getMonth() + step);
    myRenderContentPlan(); 
  }

  function myRenderContentPlan() {
    const container = document.getElementById('my-content-container');
    const year = myContentDate.getFullYear();
    const month = myContentDate.getMonth();
    const mNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    document.getElementById('my-content-subtitle').innerText = `${mNames[month]} ${year}`;
    
    const tasks = myGetTasks('All', ''); 
    const tasksInMonth = tasks.filter(t => {
        if(!t.effectiveDue) return false;
        let d = new Date(t.effectiveDue);
        return d.getMonth() === month && d.getFullYear() === year;
    });

    if (tasksInMonth.length === 0) { container.innerHTML = `<div class="text-center py-5 text-muted">No Plan</div>`; return; }

    tasksInMonth.sort((a,b) => new Date(a.effectiveDue) - new Date(b.effectiveDue));
    const grouped = {};
    tasksInMonth.forEach(t => { if(!grouped[t.effectiveDue]) grouped[t.effectiveDue] = []; grouped[t.effectiveDue].push(t); });

    let html = '';
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    for (const [dStr, items] of Object.entries(grouped)) {
        let d = new Date(dStr);
        html += `
        <div class="my-agenda-block">
            <div class="my-agenda-header">
                <span class="agenda-date">${d.getDate()} ${mNames[month]}</span>
                <span class="agenda-day-name">${days[d.getDay()]}</span>
            </div>`;
        
        items.forEach(t => {
             const p = globalData.projects.find(x => x[0] === t[1]);
             const cName = p ? p[1] : '-';
             let stBadge = '<span class="badge bg-success">NEW</span>';
             if(t[5] === 'Revise') stBadge = '<span class="badge bg-danger">REVISE</span>';
             else if(t.stepStat === 'doing') stBadge = '<span class="badge bg-primary">DOING</span>';

             html += `
             <div class="my-agenda-row" onclick="myOpenDetail('${t[0]}')">
                 <div class="col-project"><span class="badge bg-light text-dark border">${cName}</span></div>
                 <div class="col-task">
                     <div class="task-name-text">${t[3]}</div>
                     <div class="task-meta text-muted small">${t.stepName}</div>
                 </div>
                 <div class="col-status">${stBadge}</div>
             </div>`;
        });
        html += `</div>`; 
    }
    container.innerHTML = html;
  }

  // ================= UTILS & ACTIONS =================
  function mySwitchView(v) {
      myActiveView = v;
      document.getElementById('view-my-list').style.display = v==='list'?'block':'none';
      document.getElementById('view-my-board').style.display = v==='board'?'block':'none';
      document.getElementById('view-my-calendar').style.display = v==='calendar'?'block':'none';
      document.getElementById('view-my-content').style.display = v==='content'?'block':'none';
      
      document.querySelectorAll('.my-btn-nav .btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`btn-my-${v}`).classList.add('active');
      myRenderTasks(); 
  }

  function myStartStep(tid, idx) {
      google.script.run.withSuccessHandler(res => {
         const t = globalData.tasks.find(x => x[0] === tid); 
         if(t) { t[12] = res.workflowJson; if (res.newMainStatus) t[5] = res.newMainStatus; }
         bootstrap.Modal.getInstance(document.getElementById('myTaskDetailModal'))?.hide();
         myRenderTasks(); 
      }).updateTaskWorkflowStatus(tid, idx);
  }

  function myOpenSubmit(tid, pid, idx, sname) {
      document.getElementById('my-submit-tid').value = tid;
      document.getElementById('my-submit-pid').value = pid;
      document.getElementById('my-submit-sidx').value = idx;
      document.getElementById('my-submit-sname').value = sname;
      document.getElementById('my-submit-display').innerText = sname;
      document.getElementById('my-submit-msg').value = ''; 
      document.getElementById('my-submit-link').value = ''; 
      document.getElementById('my-submit-file').value = '';
      bootstrap.Modal.getInstance(document.getElementById('myTaskDetailModal'))?.hide();
      new bootstrap.Modal(document.getElementById('mySubmitModal')).show();
  }

  function myConfirmSubmit() {
      const tid = document.getElementById('my-submit-tid').value;
      const pid = document.getElementById('my-submit-pid').value;
      const idx = document.getElementById('my-submit-sidx').value;
      const name = document.getElementById('my-submit-sname').value;
      const msg = document.getElementById('my-submit-msg').value;
      const link = document.getElementById('my-submit-link').value;
      const file = document.getElementById('my-submit-file').files[0];
      
      if(!msg && !file && !link) return alert('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
      
      const btn = event.target; btn.innerHTML = 'Sending...'; btn.disabled = true;
      let log = `‚úÖ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô: "${name}"`; if(msg) log += `\nüí¨ ${msg}`; if(link) log += `\nüîó ${link}`;
      const me = globalData.currentUser.name;
      const payload = file ? {name:file.name, mimeType:file.type} : null;

      const cb = (res) => {
           const t = globalData.tasks.find(x => x[0] === tid); 
           if(t) { t[12] = res.workflowJson; if (res.newMainStatus) t[5] = res.newMainStatus; }
           bootstrap.Modal.getInstance(document.getElementById('mySubmitModal')).hide();
           myRenderTasks();
           btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'; btn.disabled = false;
      };

      if(file) {
          const r = new FileReader();
          r.onload = e => { 
              payload.data = e.target.result.split(',')[1]; 
              google.script.run.withSuccessHandler(res => { google.script.run.withSuccessHandler(cb).updateTaskWorkflowStatus(tid, idx); }).postProjectUpdate(pid, log, me, payload); 
          };
          r.readAsDataURL(file);
      } else {
          google.script.run.withSuccessHandler(res => { google.script.run.withSuccessHandler(cb).updateTaskWorkflowStatus(tid, idx); }).postProjectUpdate(pid, log, me, null);
      }
  }

  function myOpenDetail(tid) {
      const t = globalData.tasks.find(x => x[0] === tid); if(!t) return;
      myTempPid = t[1];
      const p = globalData.projects.find(x => x[0] === t[1]);
      const myName = globalData.currentUser.name;
      let steps = []; try { steps = JSON.parse(t[12]); } catch(e){ }
      const cur = steps.find(s => s.assignee === myName && s.status !== 'done') || {};
      const idx = steps.indexOf(cur);

      let stText = "ONGOING"; let bg = "bg-primary"; 
      if (t[5] === 'Revise') { stText = "REVISE"; bg = "bg-danger"; }
      else if (t[5] === 'Pending' || cur.status === 'pending') { stText = "NEW TASK"; bg = "bg-success"; }

      document.getElementById('my-modal-header').className = `modal-header text-white ${bg}`;
      document.getElementById('my-modal-state').innerText = stText;
      document.getElementById('my-modal-title').innerText = t[3];
      document.getElementById('my-modal-project').innerText = p ? p[1] : '-';
      document.getElementById('my-modal-due').innerText = cur.dueDate || t[7] || '-';
      document.getElementById('my-modal-step').innerText = cur.name || '-';
      document.getElementById('my-modal-desc').innerText = cur.details || '-';

      const att = document.getElementById('my-modal-attach'); att.innerHTML = '';
      if (t[8]) att.innerHTML += `<a href="${t[8]}" target="_blank" class="btn btn-sm btn-outline-primary text-start w-100">Link</a>`;
      if (t[9]) att.innerHTML += `<a href="${t[9]}" target="_blank" class="btn btn-sm btn-outline-dark text-start w-100 mt-1">File</a>`;
      
      const rmk = document.getElementById('my-modal-remark-box');
      if (t[15]) { rmk.style.display = 'block'; document.getElementById('my-modal-remark').innerText = t[15]; } else rmk.style.display = 'none';

      const act = document.getElementById('my-modal-action');
      if (cur.status === 'doing') act.innerHTML = `<button class="btn btn-primary btn-sm rounded-pill px-4" onclick="myOpenSubmit('${t[0]}', '${t[1]}', ${idx}, '${cur.name}')">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>`;
      else act.innerHTML = `<button class="btn btn-success btn-sm rounded-pill px-4" onclick="myStartStep('${t[0]}', ${idx})">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥</button>`;

      new bootstrap.Modal(document.getElementById('myTaskDetailModal')).show();
  }

  function myGoToProject() {
      if(myTempPid) {
          bootstrap.Modal.getInstance(document.getElementById('myTaskDetailModal')).hide();
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Index.html (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á)
          if(typeof openProjectDetail === 'function') openProjectDetail(myTempPid);
          else alert("Function not found");
      }
  }
  
</script>
