<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<style>
  /* --- Modern Formal Theme --- */
  :root {
    --f-bg: #f3f4f6;
    --f-card-bg: #ffffff;
    --f-border: #e5e7eb;
    --f-text-head: #1e293b;
    --f-text-body: #475569;
    --f-primary: #0f172a;
    --f-accent: #2563eb;
    --f-success: #10b981;
    --f-warning: #f59e0b;
    --f-danger: #ef4444;
  }

  body { background-color: var(--f-bg); font-family: 'Sarabun', sans-serif; color: var(--f-text-body); }

  /* Navigation & Inputs */
  .toolbar-container { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
  .btn-group-nav { background: white; padding: 4px; border-radius: 50px; border: 1px solid var(--f-border); display: inline-flex; }
  .btn-group-nav .btn { border: none; border-radius: 50px; color: #64748b; font-size: 0.85rem; font-weight: 500; padding: 6px 16px; transition: 0.2s; }
  .btn-group-nav .btn:hover { background-color: #f1f5f9; color: var(--f-primary); }
  .btn-group-nav .btn.active { background-color: var(--f-primary); color: white; box-shadow: 0 2px 4px rgba(15, 23, 42, 0.2); }

  .search-box { position: relative; width: 220px; }
  .search-box input { padding-left: 35px; border-radius: 50px; font-size: 0.85rem; border-color: var(--f-border); height: 36px; }
  .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
  .filter-select { border-radius: 50px; font-size: 0.85rem; border-color: var(--f-border); height: 36px; padding-left: 15px; width: 140px; }

  /* --- Task Card (List View) --- */
  .task-card {
    background: var(--f-card-bg); border: 1px solid var(--f-border); border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.02); transition: all 0.2s ease-in-out;
    position: relative; overflow: hidden; height: 100%; cursor: pointer; display: flex; flex-direction: column;
  }
  .task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-color: #cbd5e1; }
  
  .status-strip { position: absolute; top: 0; bottom: 0; left: 0; width: 5px; background-color: #94a3b8; }
  .status-strip.doing { background-color: var(--f-accent); }
  .status-strip.revise { background-color: var(--f-danger); } 
  .status-strip.new { background-color: var(--f-success); }   
  
  .card-content { padding: 20px 20px 20px 28px; display: flex; flex-direction: column; height: 100%; justify-content: space-between; }
  .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .project-label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; background: #f8fafc; padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0; max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  
  .task-title { font-size: 1.1rem; font-weight: 700; color: var(--f-text-head); margin-bottom: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 0.85rem; }
  .info-label { font-size: 0.7rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
  .info-value { font-weight: 600; color: var(--f-text-head); }
  .info-value.overdue { color: var(--f-danger); }
  .step-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-bottom: 15px; font-size: 0.85rem; display: flex; gap: 8px; align-items: flex-start; }
  .step-icon { color: var(--f-accent); margin-top: 2px; }
  .step-text { color: #475569; line-height: 1.4; }
  .action-area { margin-top: auto; }
  .btn-action { width: 100%; border-radius: 8px; font-weight: 600; padding: 8px; font-size: 0.9rem; letter-spacing: 0.3px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

  /* View Container Setup */
  .view-section { height: calc(100vh - 160px); overflow-y: auto; padding-bottom: 120px; padding-right: 5px; }
  .view-section::-webkit-scrollbar { width: 6px; }
  .view-section::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

  /* --- Board View --- */
  .board-container { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; height: 100%; align-items: flex-start; }
  .board-col { flex: 1; min-width: 320px; max-width: 400px; background: #f1f5f9; border-radius: 12px; padding: 12px; max-height: 100%; display: flex; flex-direction: column; }
  
  /* --- Content Plan Agenda --- */
  .agenda-container { display: flex; flex-direction: column; gap: 15px; }
  .agenda-day-block { background: white; border: 1px solid var(--f-border); border-radius: 10px; overflow: hidden; }
  .agenda-header { background: #f8fafc; padding: 10px 15px; border-bottom: 1px solid var(--f-border); display: flex; justify-content: space-between; align-items: center; }
  .agenda-date { font-weight: 700; color: var(--f-primary); font-size: 0.95rem; }
  .agenda-row { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 15px; transition: 0.1s; cursor: pointer; }
  .agenda-row:hover { background-color: #f8faff; }
  .col-project { width: 140px; flex-shrink: 0; }
  .project-badge { font-size: 0.7rem; background: #e2e8f0; color: #334155; padding: 3px 8px; border-radius: 4px; font-weight: 600; display: inline-block; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .col-task { flex-grow: 1; min-width: 0; }
  .task-name-text { font-weight: 600; color: var(--f-text-head); font-size: 0.9rem; margin-bottom: 4px; }
  .col-status { width: 100px; text-align: center; flex-shrink: 0; }
  .status-badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 50px; font-weight: 600; width: 100%; display: block; }
  .status-new { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
  .status-revise { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
  .status-doing { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }

  /* --- FullCalendar Overrides --- */
  #my-task-calendar { font-family: 'Sarabun', sans-serif; background: white; padding: 15px; border-radius: 12px; border: 1px solid var(--f-border); min-height: 600px; }
  
  .fc-toolbar-title { font-size: 1.25rem !important; font-weight: 800; color: var(--f-primary); }
  .fc-button { background-color: white !important; color: #475569 !important; border-color: #e2e8f0 !important; font-weight: 600 !important; text-transform: capitalize; }
  .fc-button-active { background-color: #f1f5f9 !important; color: var(--f-primary) !important; }
  .fc-day-today { background-color: #eff6ff !important; }
  .fc-event { border: none !important; margin-bottom: 2px; cursor: pointer; }
  
  .fc-event-content-box { 
      padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; border-left: 3px solid transparent;
      background: #f1f5f9; color: #334155; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .fc-event-content-box.doing { background: #dbeafe; color: #1e40af; border-left-color: var(--f-accent); }
  .fc-event-content-box.revise { background: #fee2e2; color: #991b1b; border-left-color: var(--f-danger); }
  .fc-event-content-box.new { background: #dcfce7; color: #166534; border-left-color: var(--f-success); }
  
  /* Badges */
  .badge-media { font-weight: normal; border: 1px solid; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
  .badge-media-video { background-color: #fae8ff; color: #86198f; border-color: #f0abfc; }
  .badge-media-single { background-color: #e0f2fe; color: #0369a1; border-color: #bae6fd; }
  .badge-media-default { background-color: #f1f5f9; color: #475569; border-color: #e2e8f0; }
</style>

<div class="row mb-4 align-items-center g-3">
  <div class="col-lg-4">
    <h4 class="mb-1 fw-bold" style="color:var(--f-primary); letter-spacing: -0.5px;">
      <i class="fas fa-user-check me-2 text-primary"></i>‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (My Tasks)
    </h4>
    <small class="text-muted d-block ps-1">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</small>
  </div>
  
  <div class="col-lg-8">
    <div class="toolbar-container">
       <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" class="form-control" id="task-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô..." onkeyup="renderMyTasks()">
       </div>
       <select class="form-select filter-select" id="task-filter" onchange="renderMyTasks()">
          <option value="All">All Status</option>
          <option value="Pending">New / Pending</option>
          <option value="Doing">Doing</option>
          <option value="Revise">Revise</option>
       </select>

       <div class="btn-group-nav shadow-sm">
       
          <button class="btn active" id="btn-view-list" onclick="switchView('list')"><i class="fas fa-list-ul me-2"></i>List</button>
           <button class="btn" id="btn-view-content" onclick="switchView('content')"><i class="fas fa-photo-video me-2"></i>Content Plan</button>
          <button class="btn" id="btn-view-board" onclick="switchView('board')"><i class="fas fa-columns me-2"></i>Board</button>
          <button class="btn" id="btn-view-calendar" onclick="switchView('calendar')"><i class="far fa-calendar-alt me-2"></i>Calendar</button>
          
       </div>
    </div>
  </div>
</div>

<div id="view-list" class="view-section">
  <div id="todo-container" class="row g-4"></div>
</div>

<div id="view-board" class="view-section" style="display:none;">
  <div class="board-container">
    <div class="board-col col-todo">
       <div class="d-flex justify-content-between align-items-center bg-secondary text-white p-3 rounded-top mb-3 fw-bold shadow-sm">
          <span><i class="fas fa-inbox me-2"></i>‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (Pending)</span>
          <span class="badge bg-white text-dark rounded-pill" id="count-todo">0</span>
       </div>
       <div class="board-content" id="board-todo-content" style="overflow-y:auto; flex-grow:1; padding-right:5px;"></div>
    </div>
    <div class="board-col col-doing">
       <div class="d-flex justify-content-between align-items-center bg-primary text-white p-3 rounded-top mb-3 fw-bold shadow-sm">
          <span><i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ (Doing)</span>
          <span class="badge bg-white text-dark rounded-pill" id="count-doing">0</span>
       </div>
       <div class="board-content" id="board-doing-content" style="overflow-y:auto; flex-grow:1; padding-right:5px;"></div>
    </div>
  </div>
</div>

<div id="view-calendar" class="view-section" style="display:none;">
    <div id='my-task-calendar'></div> </div>

<div id="view-content" class="view-section" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
         <div>
             <h5 class="fw-bold text-primary mb-0"><i class="fas fa-calendar-day me-2"></i>Content Plan</h5>
             <small class="text-muted" id="content-plan-subtitle">...</small>
         </div>
         <div class="btn-group shadow-sm rounded-pill">
            <button class="btn btn-white border btn-sm" onclick="changeContentMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <button class="btn btn-white border btn-sm fw-bold px-3" onclick="currentContentDate = new Date(); renderContentPlan();">Today</button>
            <button class="btn btn-white border btn-sm" onclick="changeContentMonth(1)"><i class="fas fa-chevron-right"></i></button>
         </div>
    </div>
    <div class="agenda-container" id="content-plan-container"></div>
</div>

<div class="modal fade" id="submitWorkModal" tabindex="-1" style="z-index: 1060;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
      <div class="modal-header text-white" style="background-color: var(--f-primary); border-top-left-radius: 12px; border-top-right-radius: 12px;">
        <h6 class="modal-title fw-bold"><i class="fas fa-paper-plane me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏≥‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (Submit)</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <input type="hidden" id="submit-task-id"> <input type="hidden" id="submit-project-id"> 
        <input type="hidden" id="submit-step-index"> <input type="hidden" id="submit-step-name">

        <div class="d-flex align-items-center mb-4 p-3 bg-light rounded border border-primary-subtle">
           <div class="bg-white rounded-circle p-2 shadow-sm me-3 text-primary"><i class="fas fa-info-circle fs-4"></i></div>
           <div>
              <div class="small text-muted text-uppercase fw-bold" style="font-size:0.65rem; letter-spacing:0.5px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</div>
              <strong class="text-dark fs-6" id="submit-step-display">-</strong>
           </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label small fw-bold text-muted text-uppercase">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à <span class="text-danger">*</span></label>
          <textarea id="submit-msg" class="form-control bg-light" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß..."></textarea>
        </div>
        
        <div class="mb-3">
           <label class="form-label small fw-bold text-muted text-uppercase">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (Optional)</label>
           <input type="file" id="submit-file" class="form-control form-control-sm">
        </div>
        <div class="mb-2">
           <label class="form-label small fw-bold text-muted text-uppercase">‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏¥‡∏á‡∏Å‡πå (URL)</label>
           <input type="url" id="submit-link" class="form-control form-control-sm bg-light" placeholder="https://...">
        </div>
      </div>
      <div class="modal-footer border-0 pt-0 pb-4 px-4">
        <button type="button" class="btn btn-light btn-sm rounded-pill px-4" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-primary btn-sm px-4 fw-bold rounded-pill shadow-sm" onclick="confirmSubmit()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="myTaskDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
      
      <div id="modal-header-bg" class="modal-header text-white" style="border-top-left-radius: 12px; border-top-right-radius: 12px;">
        <div>
            <div class="badge bg-white/20 text-white border border-white/30 mb-2" id="modal-task-state" style="font-weight:500;">STATE</div>
            <h5 class="modal-title fw-bold" id="modal-detail-title" style="line-height:1.4;">Task Name</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-4">
        <div class="row mb-4">
            <div class="col-8 border-end">
                <small class="text-muted d-block text-uppercase fw-bold mb-1" style="font-size:0.65rem;">Project</small>
                <div class="fw-bold text-primary text-truncate" id="modal-detail-project">-</div>
            </div>
            <div class="col-4 ps-3">
                <small class="text-muted d-block text-uppercase fw-bold mb-1" style="font-size:0.65rem;">Due Date</small>
                <div class="fw-bold" id="modal-detail-due">-</div>
            </div>
        </div>

        <div class="bg-light p-3 rounded-3 border mb-4">
            <h6 class="fw-bold text-dark mb-2 small text-uppercase"><i class="fas fa-shoe-prints me-2 text-secondary"></i>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Current Step)</h6>
            <div class="d-flex align-items-center text-dark mb-2 ms-1">
                <i class="fas fa-tag me-2 text-primary"></i> <span id="modal-detail-step-name" class="fw-bold fs-6">-</span>
            </div>
            <div class="small text-muted p-2 bg-white border rounded ms-1">
                <i class="fas fa-info-circle me-1"></i> <span id="modal-detail-desc">-</span>
            </div>
        </div>

        <div class="mb-4">
            <h6 class="small fw-bold text-muted text-uppercase mb-2">Attachments / Resources</h6>
            <div id="modal-detail-attachments" class="d-flex flex-column gap-2"></div>
        </div>

        <div id="modal-detail-remark-box" style="display:none;">
            <h6 class="small fw-bold text-muted text-uppercase mb-2">Note / Remark</h6>
            <div class="alert alert-warning small mb-0 text-break" id="modal-detail-remark" style="white-space: pre-wrap; word-wrap: break-word;"></div>
        </div>
      </div>

      <div class="modal-footer bg-light border-0 justify-content-between py-3 px-4" style="border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;">
         <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill px-3" onclick="goToFullProject()">
            <i class="fas fa-external-link-alt me-1"></i> Project Detail
         </button>
         <div id="modal-action-btn"></div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentViewDate = new Date();
  let currentContentDate = new Date();
  let activeView = 'list';
  let tempDetailProjectId = null;
  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥
  let myTaskCalendarInstance = null; 

  function renderMyTasks() { 
      // 1. Get Filters
      const filterStatus = document.getElementById('task-filter').value;
      const searchText = document.getElementById('task-search').value.toLowerCase();
      
      // 2. Render based on active view
      if(activeView === 'list') renderTodoList(filterStatus, searchText); 
      else if(activeView === 'board') renderBoardView(filterStatus, searchText);
      else if(activeView === 'calendar') {
           setTimeout(() => renderMyCalendar(), 100); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß
      }
      else if(activeView === 'content') renderContentPlan();
  }

  // ================= DATA LOGIC =================
  function getMyActiveWorkflowTasks(filterStatus, searchText) {
      if(!globalData.currentUser) return [];
      const myName = globalData.currentUser.name;
      let tasks = [];
      
      globalData.tasks.forEach(t => {
          if (t[5] === 'Done') return; 
          
          let steps = [];
          try { steps = t[12] ? JSON.parse(t[12]) : []; } catch(e) { steps = []; }
          
          const myActiveSteps = steps.filter(step => step.assignee === myName && step.status !== 'done');
          
          if (myActiveSteps.length > 0) {
              let currentStep = myActiveSteps[0]; 
              let taskData = [...t];
              taskData.stepName = currentStep.name;
              taskData.stepDetails = currentStep.details || '';
              taskData.effectiveDueDate = currentStep.dueDate ? currentStep.dueDate : (t[7] || ''); 
              taskData.stepIndex = steps.indexOf(currentStep);
              taskData.stepStatus = currentStep.status; 
              
              // Filter Logic
              let statusMatch = true;
              if (filterStatus && filterStatus !== 'All') {
                  if (filterStatus === 'Doing' && taskData.stepStatus !== 'doing') statusMatch = false;
                  else if (filterStatus === 'Pending' && (taskData.stepStatus !== 'pending' || t[5] === 'Revise')) statusMatch = false;
                  else if (filterStatus === 'Revise' && t[5] !== 'Revise') statusMatch = false;
              }

              // Search Logic
              let searchMatch = true;
              if (searchText) {
                  const content = (t[3] + t[1]).toLowerCase(); 
                  if (!content.includes(searchText)) searchMatch = false;
              }

              if (statusMatch && searchMatch) tasks.push(taskData);
          }
      });
      return tasks;
  }

  // ================= 1. LIST VIEW =================
  function renderTodoList(filterStatus, searchText) {
    const container = document.getElementById('todo-container');
    const myTasks = getMyActiveWorkflowTasks(filterStatus, searchText);
    
    myTasks.sort((a, b) => new Date(a.effectiveDueDate || '2999-12-31') - new Date(b.effectiveDueDate || '2999-12-31'));

    if (myTasks.length === 0) { container.innerHTML = `<div class="col-12 text-center py-5 text-muted"><i class="fas fa-search-minus fa-3x mb-3 text-light"></i><br><h5>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h5></div>`; return; }

    const groups = { overdue: [], today: [], upcoming: [], noDate: [] };
    const today = new Date(); today.setHours(0,0,0,0);
    
    myTasks.forEach(t => {
      if (!t.effectiveDueDate) { groups.noDate.push(t); return; }
      const d = new Date(t.effectiveDueDate); d.setHours(0,0,0,0);
      if (d < today) groups.overdue.push(t); else if (d.getTime() === today.getTime()) groups.today.push(t); else groups.upcoming.push(t);
    });

    let html = '';
    html += generateListGroup('‚ö†Ô∏è Overdue (‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î)', groups.overdue, 'text-danger');
    html += generateListGroup('üìÖ Today (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)', groups.today, 'text-primary');
    html += generateListGroup('üîú Upcoming (‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ)', groups.upcoming, 'text-dark');
    html += generateListGroup('üìå No Date (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô)', groups.noDate, 'text-secondary');
    container.innerHTML = html;
  }

  function generateListGroup(title, tasks, colorClass) {
    if (tasks.length === 0) return '';
    let html = `<div class="col-12 mt-4"><h6 class="fw-bold border-bottom pb-2 mb-3 ${colorClass}" style="letter-spacing:-0.5px;">${title} <span class="badge bg-light text-dark border ms-2 rounded-pill">${tasks.length}</span></h6></div>`;
    tasks.forEach(t => html += createCardHtml(t));
    return html;
  }

  function createCardHtml(t) {
      const project = globalData.projects.find(p => p[0] === t[1]);
      const clientName = project ? project[1] : '-';
      
      let showType = t[14] || t[2];
      let typeBadgeClass = t[14] ? 'badge-media-video' : 'badge-media-default';
      if(t[14] && t[14].toLowerCase().includes('single')) typeBadgeClass = 'badge-media-single';
      
      let stripClass = t.stepStatus === 'doing' ? 'doing' : 'new';
      if(t[5] === 'Revise') stripClass = 'revise';
      
      let isOverdue = t.effectiveDueDate && new Date(t.effectiveDueDate) < new Date().setHours(0,0,0,0);
      if(isOverdue && t[5] !== 'Revise') stripClass = 'overdue';

      let actionBtn = '';
      if (t.stepStatus === 'doing') actionBtn = `<button class="btn btn-primary btn-action text-white" onclick="event.stopPropagation(); openSubmitWorkModal('${t[0]}', '${t[1]}', ${t.stepIndex}, '${t.stepName}')"><i class="fas fa-paper-plane me-2"></i> ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (Submit)</button>`;
      else actionBtn = `<button class="btn btn-outline-primary btn-action" onclick="event.stopPropagation(); startMyStep('${t[0]}', ${t.stepIndex})"><i class="fas fa-play me-2"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥ (Start)</button>`;

      return `
        <div class="col-md-6 col-xl-4">
          <div class="task-card" onclick="openMyTaskDetail('${t[0]}')">
            <div class="status-strip ${stripClass}"></div>
            <div class="card-content">
              <div>
                  <div class="card-header-row">
                     <div class="project-label text-truncate" title="${clientName}"><i class="fas fa-folder me-1"></i> ${clientName}</div>
                     <span class="badge ${typeBadgeClass} badge-media ms-2">${showType}</span>
                  </div>
                  <h6 class="task-title" title="${t[3]}">${t[3]}</h6>
                  <div class="info-grid">
                      <div class="info-block"><span class="info-label">Due Date</span><span class="info-value ${isOverdue?'overdue':''}">${t.effectiveDueDate || '-'}</span></div>
                      <div class="info-block text-end"><span class="info-label">Current Step</span><span class="info-value text-primary">${t.stepName}</span></div>
                  </div>
                  <div class="step-box"><i class="fas fa-info-circle step-icon"></i><span class="step-text text-truncate">${t.stepDetails || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</span></div>
              </div>
              <div class="action-area">${actionBtn}</div>
            </div>
          </div>
        </div>`;
  }

  // ================= 2. BOARD VIEW =================
  function renderBoardView(filterStatus, searchText) {
      const myTasks = getMyActiveWorkflowTasks(filterStatus, searchText);
      const todoTasks = myTasks.filter(t => t.stepStatus === 'pending');
      const doingTasks = myTasks.filter(t => t.stepStatus === 'doing');

      document.getElementById('count-todo').innerText = todoTasks.length;
      document.getElementById('count-doing').innerText = doingTasks.length;

      document.getElementById('board-todo-content').innerHTML = todoTasks.length ? todoTasks.map(t => createBoardCardHtml(t)).join('') : '<div class="text-center text-muted mt-5 small">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>';
      document.getElementById('board-doing-content').innerHTML = doingTasks.length ? doingTasks.map(t => createBoardCardHtml(t)).join('') : '<div class="text-center text-muted mt-5 small">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</div>';
  }

  function createBoardCardHtml(t) {
      const project = globalData.projects.find(p => p[0] === t[1]);
      const clientName = project ? project[1] : '-';
      let showType = t[14] || t[2];
      
      let btn = '';
      if(t.stepStatus === 'doing') btn = `<button class="btn btn-sm btn-primary w-100 rounded-pill mt-2 shadow-sm" onclick="event.stopPropagation(); openSubmitWorkModal('${t[0]}', '${t[1]}', ${t.stepIndex}, '${t.stepName}')">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>`;
      else btn = `<button class="btn btn-sm btn-outline-primary w-100 rounded-pill mt-2" onclick="event.stopPropagation(); startMyStep('${t[0]}', ${t.stepIndex})">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥</button>`;

      return `
        <div class="task-card mb-2" onclick="openMyTaskDetail('${t[0]}')" style="box-shadow:none; border:1px solid #e2e8f0;">
           <div class="p-3">
              <div class="d-flex justify-content-between mb-2">
                  <span class="badge bg-light text-secondary border fw-normal" style="font-size:0.65rem;">${showType}</span>
                  <span class="small text-muted fw-bold text-truncate" style="max-width:100px;">${clientName}</span>
              </div>
              <h6 class="fw-bold mb-2 text-dark" style="font-size:0.9rem; line-height:1.3;">${t[3]}</h6>
              <div class="d-flex align-items-center small text-secondary mb-2">
                 <i class="fas fa-tag me-2 text-primary"></i> ${t.stepName}
              </div>
              ${t.effectiveDueDate ? `<div class="small text-danger fw-bold mb-2"><i class="far fa-calendar me-1"></i> ${t.effectiveDueDate}</div>` : ''}
              ${btn}
           </div>
        </div>`;
  }

  // ================= 3. CALENDAR VIEW (RENAMED FUNCTION) =================
  function renderMyCalendar() {
      // ‚úÖ ‡πÉ‡∏ä‡πâ ID ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô HTML
      const calendarEl = document.getElementById('my-task-calendar');
      if (!calendarEl || typeof FullCalendar === 'undefined') return;
      
      // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡∏°‡πà
      if (myTaskCalendarInstance) myTaskCalendarInstance.destroy();

      const myTasks = getMyActiveWorkflowTasks('All', '');

      myTaskCalendarInstance = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
          height: '100%',
          dayMaxEvents: 3,
          events: myTasks.map(t => {
              let color = '#64748b'; 
              let cls = 'pending';
              if (t.stepStatus === 'doing') { color = '#2563eb'; cls = 'doing'; } 
              if (t[5] === 'Revise') { color = '#dc3545'; cls = 'revise'; }      
              if (t.stepStatus === 'pending' && t[5] !== 'Revise') { color = '#10b981'; cls = 'new'; }

              return {
                  id: t[0],
                  title: t[3],
                  start: t.effectiveDueDate || new Date(),
                  extendedProps: { classType: cls, status: t[5], step: t.stepName }
              };
          }),
          eventClick: function(info) {
              openMyTaskDetail(info.event.id);
          },
          eventContent: function(arg) {
              let props = arg.event.extendedProps;
              return { html: `<div class="fc-event-content-box ${props.classType}">${arg.event.title}</div>` };
          }
      });
      myTaskCalendarInstance.render();
  }

  // ================= 4. CONTENT PLAN VIEW (AGENDA) =================
  function changeContentMonth(offset) {
    currentContentDate.setMonth(currentContentDate.getMonth() + offset);
    renderContentPlan(); 
  }

  function renderContentPlan() {
    const container = document.getElementById('content-plan-container');
    const year = currentContentDate.getFullYear();
    const month = currentContentDate.getMonth();
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    document.getElementById('content-plan-subtitle').innerText = `${monthNames[month]} ${year}`;
    
    const myTasks = getMyActiveWorkflowTasks('All', ''); 
    
    const tasksInMonth = myTasks.filter(t => {
        if(!t.effectiveDueDate) return false;
        let d = new Date(t.effectiveDueDate);
        return d.getMonth() === month && d.getFullYear() === year;
    });

    if (tasksInMonth.length === 0) {
        container.innerHTML = `<div class="text-center py-5 text-muted"><i class="far fa-calendar-times fa-3x mb-3 text-light"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>`;
        return;
    }

    tasksInMonth.sort((a,b) => new Date(a.effectiveDueDate) - new Date(b.effectiveDueDate));
    const grouped = {};
    tasksInMonth.forEach(t => {
        if(!grouped[t.effectiveDueDate]) grouped[t.effectiveDueDate] = [];
        grouped[t.effectiveDueDate].push(t);
    });

    let html = '';
    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

    for (const [dateStr, tasks] of Object.entries(grouped)) {
        let d = new Date(dateStr);
        let dayName = days[d.getDay()];
        let niceDate = d.getDate();
        
        html += `
        <div class="agenda-day-block">
            <div class="agenda-header">
                <span class="agenda-date"><i class="far fa-calendar-check me-2"></i> ${niceDate} ${monthNames[month]}</span>
                <span class="agenda-day-name">${dayName}</span>
            </div>
        `;
        
        tasks.forEach(t => {
             const project = globalData.projects.find(p => p[0] === t[1]);
             const clientName = project ? project[1] : '-';
             let typeBadgeClass = t[14] && t[14].toLowerCase().includes('video') ? 'badge-media-video' : 'badge-media-default';
             
             let statusBadge = '<span class="status-badge status-new">NEW TASK</span>';
             if(t[5] === 'Revise') statusBadge = '<span class="status-badge status-revise">REVISE</span>';
             else if(t.stepStatus === 'doing') statusBadge = '<span class="status-badge status-doing">DOING</span>';

             html += `
             <div class="agenda-row" onclick="openMyTaskDetail('${t[0]}')">
                 <div class="col-project">
                     <span class="project-badge" title="${clientName}">${clientName}</span>
                 </div>
                 <div class="col-task">
                     <div class="task-name-text">${t[3]}</div>
                     <div class="task-meta">
                         <span class="badge ${typeBadgeClass} badge-media">${t[14] || t[2]}</span>
                         <span><i class="fas fa-tag me-1 text-secondary"></i> ${t.stepName}</span>
                     </div>
                 </div>
                 <div class="col-status">${statusBadge}</div>
                 <div class="col-action text-muted"><i class="fas fa-chevron-right"></i></div>
             </div>`;
        });

        html += `</div>`; 
    }
    container.innerHTML = html;
  }

  // ================= UTILS & ACTIONS =================
  function switchView(view) {
      activeView = view;
      document.getElementById('view-list').style.display = view==='list'?'block':'none';
      document.getElementById('view-board').style.display = view==='board'?'block':'none';
      document.getElementById('view-calendar').style.display = view==='calendar'?'block':'none';
      document.getElementById('view-content').style.display = view==='content'?'block':'none';
      
      document.querySelectorAll('.btn-group-nav .btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`btn-view-${view}`).classList.add('active');
      renderMyTasks(); 
      
      // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
      if(view === 'calendar') setTimeout(() => renderMyCalendar(), 200); 
  }
  function changeMonth(step) { currentViewDate.setMonth(currentViewDate.getMonth() + step); renderMyCalendar(); }

  // Action: Start Step
  function startMyStep(taskId, stepIndex) {
      google.script.run.withSuccessHandler(res => {
         const t = globalData.tasks.find(x => x[0] === taskId); 
         if(t) {
             t[12] = res.workflowJson; 
             if (res.newMainStatus) t[5] = res.newMainStatus;
         }
         bootstrap.Modal.getInstance(document.getElementById('myTaskDetailModal'))?.hide();
         renderMyTasks(); 
      }).updateTaskWorkflowStatus(taskId, stepIndex);
  }

  // Action: Open Submit Modal
  function openSubmitWorkModal(taskId, projectId, stepIndex, stepName) {
      document.getElementById('submit-task-id').value = taskId;
      document.getElementById('submit-project-id').value = projectId;
      document.getElementById('submit-step-index').value = stepIndex;
      document.getElementById('submit-step-name').value = stepName;
      document.getElementById('submit-step-display').innerText = stepName;
      document.getElementById('submit-msg').value = ''; 
      document.getElementById('submit-link').value = ''; 
      document.getElementById('submit-file').value = '';
      
      bootstrap.Modal.getInstance(document.getElementById('myTaskDetailModal'))?.hide();
      new bootstrap.Modal(document.getElementById('submitWorkModal')).show();
  }

  // Action: Confirm Submit
  function confirmSubmit() {
      const tid = document.getElementById('submit-task-id').value;
      const pid = document.getElementById('submit-project-id').value;
      const stepIdx = document.getElementById('submit-step-index').value;
      const stepName = document.getElementById('submit-step-name').value;
      const msg = document.getElementById('submit-msg').value;
      const link = document.getElementById('submit-link').value;
      const fileInput = document.getElementById('submit-file').files[0];
      
      if(!msg && !fileInput && !link) return alert('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á');
      
      const btn = event.target; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...'; btn.disabled = true;
      let logMsg = `‚úÖ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô: "${stepName}"`; if(msg) logMsg += `\nüí¨ ${msg}`; if(link) logMsg += `\nüîó ${link}`;
      const me = globalData.currentUser.name;
      const filePayload = fileInput ? {name:fileInput.name, mimeType:fileInput.type} : null;

      const handler = (res) => {
           const t = globalData.tasks.find(x => x[0] === tid); 
           if(t) {
               t[12] = res.workflowJson; 
               if (res.newMainStatus) t[5] = res.newMainStatus;
           }
           bootstrap.Modal.getInstance(document.getElementById('submitWorkModal')).hide();
           renderMyTasks();
           btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô'; btn.disabled = false;
      };

      if(fileInput) {
          const r = new FileReader();
          r.onload = e => { 
              filePayload.data = e.target.result.split(',')[1]; 
              google.script.run.withSuccessHandler(res => {
                  google.script.run.withSuccessHandler(handler).updateTaskWorkflowStatus(tid, stepIdx);
              }).postProjectUpdate(pid, logMsg, me, filePayload); 
          };
          r.readAsDataURL(fileInput);
      } else {
          google.script.run.withSuccessHandler(res => {
              google.script.run.withSuccessHandler(handler).updateTaskWorkflowStatus(tid, stepIdx);
          }).postProjectUpdate(pid, logMsg, me, null);
      }
  }

  // ================= POPUP DETAIL (LOGIC ‡πÅ‡∏¢‡∏Å‡∏™‡∏µ) =================
  function openMyTaskDetail(taskId) {
      const task = globalData.tasks.find(t => t[0] === taskId); 
      if(!task) return;
      
      tempDetailProjectId = task[1];
      const project = globalData.projects.find(p => p[0] === task[1]);
      const myName = globalData.currentUser.name;
      let steps = []; try { steps = JSON.parse(task[12]); } catch(e){ steps=[]; }
      const currentStep = steps.find(s => s.assignee === myName && s.status !== 'done') || {};
      const stepIndex = steps.indexOf(currentStep);

      // --- Logic ‡πÅ‡∏¢‡∏Å‡∏™‡∏µ ---
      let stateText = "ONGOING (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)";
      let headerClass = "bg-primary"; 
      let stateBadgeClass = "text-primary";

      if (task[5] === 'Revise') {
          stateText = "üî• REVISE (‡∏á‡∏≤‡∏ô‡πÅ‡∏Å‡πâ)";
          headerClass = "bg-danger"; 
          stateBadgeClass = "text-danger";
      } else if (task[5] === 'Pending' || task[5] === 'To Do' || currentStep.status === 'pending') {
          stateText = "‚ú® NEW TASK (‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà)";
          headerClass = "bg-success"; 
          stateBadgeClass = "text-success";
      }

      // --- Render Modal ---
      const headerBg = document.getElementById('modal-header-bg');
      headerBg.className = `modal-header text-white ${headerClass}`;
      
      const badge = document.getElementById('modal-task-state');
      badge.innerText = stateText;
      badge.className = `badge bg-white text-dark mb-2 shadow-sm border border-light`;
      if(headerClass === 'bg-danger') badge.className += ' text-danger';
      if(headerClass === 'bg-success') badge.className += ' text-success';
      if(headerClass === 'bg-primary') badge.className += ' text-primary';

      document.getElementById('modal-detail-title').innerText = task[3];
      document.getElementById('modal-detail-project').innerText = project ? project[1] : '-';
      document.getElementById('modal-detail-due').innerText = currentStep.dueDate || task[7] || '-';
      document.getElementById('modal-detail-step-name').innerText = currentStep.name || 'Unknown Step';
      document.getElementById('modal-detail-desc').innerText = currentStep.details || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';

      // Attachments
      const attachDiv = document.getElementById('modal-detail-attachments');
      attachDiv.innerHTML = '';
      let hasAttach = false;
      if (task[8]) { hasAttach = true; attachDiv.innerHTML += `<a href="${task[8]}" target="_blank" class="btn btn-sm btn-outline-primary text-start"><i class="fas fa-link me-2"></i> Brief Link</a>`; }
      if (task[9]) { hasAttach = true; attachDiv.innerHTML += `<a href="${task[9]}" target="_blank" class="btn btn-sm btn-outline-dark text-start"><i class="fas fa-file-download me-2"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö (${task[10] || 'File'})</a>`; }
      if (!hasAttach) attachDiv.innerHTML = '<span class="text-muted small fst-italic ps-2">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö -</span>';

      // Remark
      const remarkBox = document.getElementById('modal-detail-remark-box');
      if (task[15]) { remarkBox.style.display = 'block'; document.getElementById('modal-detail-remark').innerText = task[15]; } else { remarkBox.style.display = 'none'; }

      // Action Button
      const actionDiv = document.getElementById('modal-action-btn');
      if (currentStep.status === 'doing') {
          actionDiv.innerHTML = `<button class="btn btn-primary btn-sm rounded-pill px-4 fw-bold shadow-sm" onclick="openSubmitWorkModal('${task[0]}', '${task[1]}', ${stepIndex}, '${currentStep.name}')"><i class="fas fa-paper-plane me-2"></i> ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (Submit)</button>`;
      } else {
          actionDiv.innerHTML = `<button class="btn btn-success btn-sm rounded-pill px-4 fw-bold shadow-sm" onclick="startMyStep('${task[0]}', ${stepIndex})"><i class="fas fa-play me-2"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥ (Start)</button>`;
      }

      new bootstrap.Modal(document.getElementById('myTaskDetailModal')).show();
  }

  function goToFullProject() {
      if(tempDetailProjectId) {
          bootstrap.Modal.getInstance(document.getElementById('myTaskDetailModal')).hide();
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Index.html (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á)
          if(typeof openProjectDetail === 'function') {
              openProjectDetail(tempDetailProjectId);
          } else {
              alert("Error: Function openProjectDetail not found");
          }
      }
  }
</script>
