<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<style>
  :root {
    --ci-blue: #0d6efd;
    --ci-navy: #2c3e50;
    --ci-bg: #f8f9fa;
    --ci-border: #dee2e6;
    --ci-text: #333333;
    --chat-bg-me: #0d6efd;
    --chat-bg-other: #ffffff;
  }

  body {
    font-family: 'Sarabun', sans-serif;
    background-color: var(--ci-bg);
    color: var(--ci-text);
    height: 100vh;
    overflow: hidden;
    margin: 0;
  }

  /* Layout */
  .card-formal {
    background: #fff;
    border: 1px solid var(--ci-border);
    border-radius: 8px;
    height: 84vh;
    display: flex;
    flex-direction: column;
    margin: 2.5vh auto;
    max-width: 98vw;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }

  .detail-header {
    flex-shrink: 0;
    height: 55px;
    border-bottom: 1px solid var(--ci-border);
    background: #fff;
    display: flex;
    align-items: center;
    padding: 0 15px;
    justify-content: space-between;
  }

  .panel-container {
    flex-grow: 1;
    overflow: hidden;
    display: flex;
    height: 100%;
  }

  .left-panel {
    border-right: 1px solid var(--ci-border);
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    width: 65%;
  }

  .right-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
    background-color: #f8fafc;
    width: 35%;
    min-width: 320px;
    min-height: 0;
  }

  /* Metrics & Info */
  .metrics-bar {
    padding: 10px 15px;
    border-bottom: 1px solid var(--ci-border);
    background: #fff;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .info-grid-basic {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    padding-bottom: 5px;
    border-bottom: 1px solid #f0f0f0;
  }

  .info-item {
    text-align: center;
    border-right: 1px solid #eee;
  }

  .info-item:last-child {
    border-right: none;
  }

  .info-label {
    font-size: 0.6rem;
    color: #888;
    text-transform: uppercase;
    display: block;
    margin-bottom: 2px;
  }

  .info-value {
    font-size: 0.85rem;
    font-weight: bold;
    color: var(--ci-navy);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .target-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .target-tag {
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 4px;
    background: #f8f9fa;
    color: #555;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
    border: 1px solid #e9ecef;
  }

  .remark-section {
    background-color: #fffbeb;
    border: 1px solid #fef3c7;
    border-radius: 6px;
    padding: 6px 10px;
    margin-top: 5px;
    font-size: 0.75rem;
    color: #92400e;
    line-height: 1.4;
    cursor: pointer;
    transition: 0.2s;
    position: relative;
    display: none;
  }

  .remark-section:hover {
    background-color: #fef9c3;
    border-color: #fde68a;
  }

  .remark-edit-icon {
    position: absolute;
    top: 5px;
    right: 5px;
    opacity: 0;
    transition: 0.2s;
    color: #b45309;
  }

  .remark-section:hover .remark-edit-icon {
    opacity: 1;
  }

  /* Workflow Styles */
  .workflow-container {
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 10px 15px;
    margin-bottom: 15px;
  }

  .workflow-step {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
    transition: 0.2s;
  }

  .workflow-step:last-child {
    border-bottom: none;
  }

  .step-status-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 0.7rem;
    cursor: pointer;
    transition: 0.2s;
    flex-shrink: 0;
  }

  .step-pending {
    background: #fff;
    color: #cbd5e1;
    border: 2px solid #cbd5e1;
  }

  .step-doing {
    background: #fff;
    color: #0d6efd;
    border: 2px solid #0d6efd;
    animation: pulse 2s infinite;
  }

  .step-done {
    background: #198754;
    color: #fff;
    border: 2px solid #198754;
  }

  .step-info {
    flex: 1;
    min-width: 0;
  }

  .step-name {
    font-size: 0.85rem;
    font-weight: bold;
    color: var(--ci-navy);
  }

  .step-assignee {
    font-size: 0.75rem;
    color: #64748b;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    border-radius: 4px;
    transition: 0.2s;
  }

  .step-assignee:hover {
    background-color: #e0e7ff;
    color: var(--ci-blue);
  }

  .step-unassigned {
    color: #94a3b8;
    font-style: italic;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4);
    }

    70% {
      box-shadow: 0 0 0 6px rgba(13, 110, 253, 0);
    }

    100% {
      box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
    }
  }

  /* Chat & View */
  .chat-header {
    padding: 12px 15px;
    border-bottom: 1px solid var(--ci-border);
    background: #fff;
    flex-shrink: 0;
    font-weight: bold;
    color: var(--ci-navy);
    display: flex;
    align-items: center;
    gap: 8px;
    height: 50px;
  }

  .chat-box {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 0;
  }

  .chat-input-area {
    padding: 10px 15px;
    background-color: #fff;
    border-top: 1px solid var(--ci-border);
    flex-shrink: 0;
  }

  .chat-row {
    display: flex;
    flex-direction: column;
    width: 100%;
    margin-bottom: 0;
  }

  .chat-row.me {
    align-items: flex-end;
  }

  .chat-row.other {
    align-items: flex-start;
  }

  .chat-meta {
    font-size: 0.65rem;
    color: #888;
    margin-bottom: 2px;
    padding: 0 2px;
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .chat-bubble {
    padding: 8px 12px;
    border-radius: 12px;
    position: relative;
    max-width: 85%;
    font-size: 0.9rem;
    line-height: 1.4;
    white-space: pre-line;
    word-break: break-word;
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
  }

  .chat-row.me .chat-bubble {
    background-color: var(--chat-bg-me);
    color: white;
    border-bottom-right-radius: 2px;
  }

  .chat-row.other .chat-bubble {
    background-color: var(--chat-bg-other);
    color: var(--ci-text);
    border: 1px solid var(--ci-border);
    border-bottom-left-radius: 2px;
  }

  .view-content {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    background-color: #fff;
  }

  .nav-bar {
    padding: 0 15px;
    border-bottom: 1px solid var(--ci-border);
    background: #fff;
    flex-shrink: 0;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .nav-tabs-formal {
    border-bottom: none;
    margin-bottom: 0;
  }

  .nav-tabs-formal .nav-link {
    padding: 8px 12px;
    font-size: 0.85rem;
    color: #666;
    border-bottom: 2px solid transparent;
  }

  .nav-tabs-formal .nav-link.active {
    color: var(--ci-blue);
    border-bottom-color: var(--ci-blue);
    font-weight: 700;
  }

  .kanban-container {
    overflow-x: auto;
    white-space: nowrap;
    padding: 15px;
    height: 100%;
    background: #f8f9fa;
  }

  .kanban-col {
    display: inline-block;
    width: 260px;
    vertical-align: top;
    margin-right: 10px;
    background: #eaeff2;
    border-radius: 6px;
    padding: 8px;
    height: 100%;
    overflow-y: auto;
  }

  .kanban-card {
    background: white;
    border: 1px solid var(--ci-border);
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    white-space: normal;
  }

  .border-status-done {
    border-left-color: #198754;
  }

  .border-status-doing {
    border-left-color: var(--ci-blue);
  }

  .border-status-todo {
    border-left-color: #6c757d;
  }

  .border-status-revise {
    border-left-color: #ffc107;
    background-color: #fffbf0;
  }

  .clickable-row {
    cursor: pointer;
    transition: 0.1s;
  }

  .clickable-row:hover {
    background-color: #f1f8ff !important;
  }

  .btn-custom {
    color: var(--ci-blue);
    background: #fff;
    border: 1px solid var(--ci-blue);
    transition: 0.2s;
  }

  .btn-custom:hover {
    background-color: var(--ci-blue);
    color: white;
  }

  .auto-expand-textarea {
    resize: none;
    overflow-y: hidden;
    min-height: 36px;
    max-height: 100px;
    font-size: 0.9rem;
  }

  .img-container {
    margin-top: 4px;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #ddd;
    max-width: 120px;
  }

  .chat-img {
    width: 100%;
    display: block;
  }

  .toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
  }

  .toast-alert {
    pointer-events: auto;
    background: #fff;
    border-left: 4px solid var(--ci-blue);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-radius: 4px;
    width: 300px;
    overflow: hidden;
    animation: slideIn 0.3s ease-out forwards;
  }

  .toast-header {
    padding: 8px 12px;
    background: #f1f5f9;
    font-weight: bold;
    font-size: 0.85rem;
    color: var(--ci-navy);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .toast-body {
    padding: 12px;
    font-size: 0.9rem;
    color: #555;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(20px);
    }

    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .notification-bell {
    position: relative;
    cursor: pointer;
    color: var(--ci-navy);
    font-size: 1.2rem;
    margin-right: 20px;
    transition: 0.2s;
  }

  .notification-bell:hover {
    color: var(--ci-blue);
  }

  .notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    padding: 2px 5px;
    font-size: 0.6rem;
    font-weight: bold;
    border: 2px solid #fff;
    display: none;
  }

  #assignStepModal {
    z-index: 10600 !important;
  }

  #assignStepModal .modal-content {
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: none;
  }

  #assignStepModal .modal-header {
    background: #fff;
    padding: 15px 20px;
  }

  #assignStepModal .form-select {
    border-radius: 8px;
    border: 1px solid #dee2e6;
    padding: 10px;
    font-size: 0.9rem;
    background-color: #f8fafc;
  }

  #assignStepModal .form-select:focus {
    border-color: var(--ci-blue);
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
  }

  #assignStepModal .btn-primary {
    width: 100%;
    border-radius: 50px;
    font-weight: 600;
    padding: 8px 0;
  }

  /* --- FORMAL CALENDAR STYLES --- */
#task-calendar {
    font-family: 'Sarabun', sans-serif;
    background: #fff;
    padding: 0;
}

/* หัวข้อเดือน (Toolbar) */
#task-calendar .fc-toolbar-title {
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--ci-navy);
    letter-spacing: -0.5px;
}
#task-calendar .fc-button {
    background-color: #fff;
    border: 1px solid #dee2e6;
    color: #495057;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: capitalize;
    box-shadow: none;
    border-radius: 4px;
    padding: 6px 12px;
}
#task-calendar .fc-button:hover, #task-calendar .fc-button-active {
    background-color: #f8f9fa !important;
    border-color: #c1c9d0 !important;
    color: var(--ci-blue) !important;
}

/* ตารางและหัวตาราง (Grid & Header) */
#task-calendar .fc-theme-standard td, 
#task-calendar .fc-theme-standard th {
    border-color: #e9ecef; /* เส้นตารางสีเทาอ่อน */
}
#task-calendar .fc-col-header-cell {
    background-color: #f8f9fa;
    padding: 10px 0;
    border-bottom: 2px solid #dee2e6 !important;
}
#task-calendar .fc-col-header-cell-cushion {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #64748b;
    font-weight: 700;
    text-decoration: none;
}
#task-calendar .fc-daygrid-day-number {
    font-size: 0.8rem;
    color: #94a3b8;
    font-weight: 600;
    padding: 8px 10px;
}
#task-calendar .fc-day-today {
    background-color: #fff !important; /* พื้นหลังขาว */
}
#task-calendar .fc-day-today .fc-daygrid-day-number {
    color: var(--ci-blue);
    font-size: 1rem;
    font-weight: 800;
}

/* อีเวนต์งาน (Events) - ปรับให้ดู Clean & Formal */
.fc-h-event {
    background: transparent;
    border: none;
    margin-bottom: 4px;
    cursor: pointer;
}
.formal-event-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-left-width: 4px; /* แถบสีด้านซ้าย */
    border-radius: 2px; /* มุมเหลี่ยมเล็กน้อย */
    padding: 4px 6px;
    font-size: 0.75rem;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
    line-height: 1.3;
}
.formal-event-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.06);
    border-color: #cbd5e1;
}
.event-title {
    font-weight: 600;
    color: #334155;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}


/* --- CUSTOM CALENDAR STYLE (Like MyTasks) --- */
  .calendar-wrapper { 
      background: white; 
      border-radius: 12px; 
      border: 1px solid var(--ci-border); 
      padding: 20px; 
      height: 100%; 
      display: flex; 
      flex-direction: column;
  }
.calendar-grid { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    /* ✅ บังคับความสูงแถวให้เท่ากัน (100px) ไม่ยืดตามเนื้อหา */
    grid-auto-rows: 100px; 
    gap: 8px; 
    padding: 2px;
}
  .calendar-day-name { 
      text-align: center; 
      font-weight: 700; 
      color: var(--ci-navy); 
      padding-bottom: 10px; 
      text-transform: uppercase; 
      font-size: 0.8rem; 
  }
.calendar-day { 
    background: #fff; 
    border: 1px solid var(--ci-border); 
    border-radius: 8px; 
    padding: 6px; 
    /* ✅ ตัดส่วนเกินทิ้งทันที เพื่อรักษาทรงตาราง */
    overflow: hidden; 
    display: flex;
    flex-direction: column;
    transition: 0.2s;
    cursor: pointer; /* ให้รู้ว่ากดดูรายละเอียดทั้งวันได้ */
}
  .calendar-day:hover { 
      background-color: #f8fafc; 
      border-color: #cbd5e1; 
  }
  .calendar-day.today { 
      border: 2px solid var(--ci-blue); 
      background-color: #eff6ff; 
  }
  .calendar-day.empty { 
      background-color: #f9fafb; 
      border: none; 
  }

.day-number { 
    text-align: right; 
    font-weight: 700; 
    color: #64748b; 
    font-size: 0.85rem;
    margin-bottom: 2px;
}
.task-list-container {
    flex-grow: 1;    /* ✅ ให้กินพื้นที่ที่เหลือทั้งหมด */
    overflow-y: auto; /* ✅ ให้ Scroll ได้เฉพาะส่วนรายการงาน */
    overflow-x: hidden;
    padding-right: 2px;
    /* ปรับ Scrollbar ให้สวยงาม (สำหรับ Chrome/Safari) */
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
}

.day-task-area {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
}

/* ปรับแต่ง Scrollbar ให้เล็กและสวยงาม */
.day-task-area::-webkit-scrollbar { width: 4px; }
.day-task-area::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
.task-list-container::-webkit-scrollbar {
    width: 4px;
}
.task-list-container::-webkit-scrollbar-thumb {
    background-color: #cbd5e1;
    border-radius: 4px;
}
  
  /* Task Event Pill */
  .task-event-pill { 
      font-size: 0.75rem; 
      border-radius: 4px; 
      padding: 3px 6px; 
      margin-bottom: 4px; 
      cursor: pointer; 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      color: white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      transition: transform 0.1s;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .task-event-pill:hover { 
      transform: translateY(-1px); 
      filter: brightness(0.95);
  }

  more-tasks-btn {
    font-size: 0.7rem;
    color: #64748b;
    background-color: #f1f5f9;
    border-radius: 4px;
    padding: 2px 6px;
    text-align: center;
    cursor: pointer;
    font-weight: 600;
}
.more-tasks-btn:hover {
    background-color: #e2e8f0;
    color: var(--ci-navy);
}

  /* Status Icons */
  .pill-icon { font-size: 0.65rem; opacity: 0.8; margin-right: 4px; }
  .pill-status { font-size: 0.7rem; color: rgba(255,255,255,0.8); }

  /* --- Content Calendar Spreadsheet Style --- */
.content-cal-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75rem;
    table-layout: fixed; /* บังคับความกว้างเท่ากัน */
}

.content-cal-table th, 
.content-cal-table td {
    border: 1px solid #000; /* เส้นขอบสีดำเข้มตามภาพ */
    padding: 4px;
    vertical-align: top;
    word-wrap: break-word;
}

/* Header เดือน */
.cal-month-header {
    background-color: #0d47a1; /* สีน้ำเงินเข้ม */
    color: white;
    text-align: center;
    font-weight: bold;
    font-size: 1rem;
    padding: 8px !important;
}

/* Header วัน (Sunday - Saturday) */
.cal-day-header {
    background-color: #000;
    color: white;
    text-align: center;
    font-weight: bold;
    text-transform: uppercase;
}

/* คอลัมน์ซ้ายสุด (Labels) */
.cal-label-col {
    background-color: #212121; /* สีดำ/เทาเข้ม */
    color: white;
    font-weight: bold;
    width: 100px; /* ความกว้างคอลัมน์ Label */
    text-align: center;
    vertical-align: middle !important;
}

/* แถว Date */
.row-date td {
    background-color: #cfd8dc; /* สีเทาอ่อน */
    text-align: center;
    font-weight: bold;
    color: #000;
}

/* พื้นที่ใส่ข้อมูล */
.cell-data {
    background-color: #fff;
    height: 35px; /* ความสูงขั้นต่ำ */
    color: #333;
}

/* Highlight ตาม Pillar (ตัวอย่างตามภาพ) */
.bg-awareness { background-color: #dcedc8 !important; } /* เขียวอ่อน */
.bg-consideration { background-color: #fff9c4 !important; } /* เหลืองอ่อน */
.bg-realtime { background-color: #b3e5fc !important; } /* ฟ้าอ่อน */



/* --- Formal Content Calendar Style --- */
.content-cal-container {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    overflow: hidden;
    margin-bottom: 20px;
    font-family: 'Sarabun', sans-serif;
}

.content-cal-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
    table-layout: fixed;
    border-style: hidden; /* ซ่อนขอบนอกสุดของตาราง */
}

.content-cal-table th, 
.content-cal-table td {
    border: 1px solid #e2e8f0; /* เส้นสีเทาบาง ดูสะอาด */
    padding: 8px 10px;
    vertical-align: middle;
    word-wrap: break-word;
}

/* Header ส่วนหัวเดือน */
.cal-month-header {
    background-color: #1e293b; /* สี Dark Slate (กรมท่าเข้ม) */
    color: white;
    text-align: center;
    font-weight: 700;
    font-size: 1.1rem;
    padding: 12px !important;
    letter-spacing: 1px;
    border-bottom: none !important;
}

/* Header วัน (Sunday - Saturday) */
.cal-day-header {
    background-color: #f8fafc; /* พื้นหลังขาวอมเทา */
    color: #64748b; /* ตัวหนังสือสีเทากลาง */
    text-align: center;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    border-bottom: 2px solid #e2e8f0 !important;
    padding: 10px !important;
}

/* คอลัมน์ซ้ายสุด (Labels) - ดีไซน์ใหม่ */
.cal-label-col {
    background-color: #f1f5f9; /* สีพื้นเทาอ่อนๆ */
    color: #334155; /* ตัวหนังสือสีเข้ม */
    font-weight: 700;
    width: 120px; 
    text-align: right; /* จัดชิดขวาให้ดูเป็น Label */
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-right: 2px solid #e2e8f0 !important; /* เส้นกั้นหนาหน่อย */
}

/* แถว Date */
.row-date td {
    background-color: #fff;
    text-align: right; /* วันที่อยู่มุมขวาบน */
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.9rem;
    height: 30px;
    vertical-align: top;
}
.row-date td.has-date {
    color: #0f172a; /* วันที่มีเลขจะสีเข้ม */
}

/* พื้นที่ใส่ข้อมูล */
.cell-data {
    background-color: #fff;
    height: 40px;
    color: #333;
    vertical-align: top !important;
}

/* Style สำหรับ Badge/Pillar */
.pillar-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: capitalize;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
/* Theme สี Pillar แบบทางการ (Pastel Tone) */
.bg-pillar-blue { background-color: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
.bg-pillar-green { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
.bg-pillar-orange { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
.bg-pillar-gray { background-color: #f5f5f5; color: #616161; border: 1px solid #e0e0e0; }

/* --- Content Pillar Colors (สีตามหมวดหมู่) --- */
.badge-pillar-awareness { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; } /* เขียว */
.badge-pillar-consideration { background-color: #fff7ed; color: #9a3412; border: 1px solid #ffedd5; } /* ส้ม */
.badge-pillar-conversion { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } /* แดง */
.badge-pillar-realtime { background-color: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; } /* น้ำเงิน */
.badge-pillar-engagement { background-color: #f3e8ff; color: #6b21a8; border: 1px solid #e9d5ff; } /* ม่วง */
.badge-pillar-default { background-color: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; } /* เทา */

/* --- Media Type Colors --- */
.badge-media { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }
.badge-media-video { background-color: #fae8ff; color: #86198f; } /* ม่วงชมพู */
.badge-media-single { background-color: #e0f2fe; color: #0369a1; } /* ฟ้า */
.badge-media-album { background-color: #dcfce7; color: #15803d; } /* เขียว */
/* Media Type Icon */
.media-icon {
    font-size: 0.7rem;
    color: #64748b;
    margin-right: 4px;
}

/* เส้นคั่นสัปดาห์ */
.week-divider {
    border-bottom: 2px solid #cbd5e1 !important; /* เส้นหนาขึ้นเล็กน้อยเมื่อจบสัปดาห์ */
}
</style>

<div class="toast-container" id="toast-area"></div>

<div class="card card-formal border-0">
  <div class="detail-header">
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-light btn-sm rounded-circle text-muted" onclick="showPage('page-dashboard')"><i
          class="fas fa-arrow-left"></i></button>
      <div>
        <h6 class="mb-0 fw-bold" style="color: var(--ci-navy);" id="detail-title">Loading...</h6>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-light text-dark border py-0" id="detail-status-badge"
            style="font-size: 0.65rem;">-</span>
          <small class="text-muted" id="detail-subtitle" style="font-size: 0.75rem;">...</small>
        </div>
      </div>
    </div>
    <div class="d-flex align-items-center">
      <div class="notification-bell" onclick="alert('ไม่มีการแจ้งเตือนเพิ่มเติม')">
        <i class="fas fa-bell"></i> <span class="notification-badge" id="noti-badge">0</span>
      </div>
<a id="detail-sheet-link" 
   href="javascript:void(0)" 
   target="_blank" 
   class="btn btn-light text-muted btn-sm rounded-pill px-3" 
   style="font-size:0.8rem;">
    <i class="fas fa-table me-1"></i> Sheet
</a>
    </div>
  </div>

  <div class="panel-container">
    <div class="left-panel">
      <div class="metrics-bar">
        <div class="info-grid-basic">
          <div class="info-item"><span class="info-label">Ad Spend</span>
            <div class="info-value text-success" id="info-budget">-</div>
          </div>
          <div class="info-item"><span class="info-label">Period</span>
            <div class="info-value text-dark" id="info-period">-</div>
          </div>
          <div class="info-item"><span class="info-label">AE Owner</span>
            <div class="info-value text-primary" id="info-ae">-</div>
          </div>
          <div class="info-item"><span class="info-label">Product</span>
            <div class="info-value text-dark" id="info-product">-</div>
          </div>
        </div>
        <div id="target-badges" class="target-container"></div>
        <div id="remark-box" class="remark-section"><i class="fas fa-pen-square remark-edit-icon"></i>
          <div><i class="fas fa-exclamation-circle me-1"></i> <span id="remark-text-content"></span></div>
        </div>
      </div>

      <div class="nav-bar">
        <ul class="nav nav-tabs-formal mb-0" id="detail-tabs">

          <li class="nav-item"><a class="nav-link" onclick="switchDetailTab('summary')"><i
                class="fas fa-chart-pie me-1"></i> Dashboard</a></li>

          <li class="nav-item">
    <a class="nav-link" onclick="switchDetailTab('content')">
        <i class="fas fa-photo-video me-1"></i> Content Plan
    </a>
</li>
          <li class="nav-item"><a class="nav-link active" onclick="switchDetailTab('list')"><i
                class="fas fa-list me-1"></i> List</a></li>
          <li class="nav-item"><a class="nav-link" onclick="switchDetailTab('kanban')"><i
                class="fas fa-columns me-1"></i> Board</a></li>
          <li class="nav-item"><a class="nav-link" onclick="switchDetailTab('calendar')"><i
                class="far fa-calendar-alt me-1"></i> Calendar</a></li>
  

        </ul>
        <!-- <button class="btn btn-primary btn-sm px-3 rounded-pill shadow-sm" style="font-size:0.8rem;"
          onclick="openAddTaskModal()"><i class="fas fa-plus"></i> เพิ่มงาน</button> -->


      </div>

      

      <div class="view-content">
        <div id="detail-view-list" class="view-section h-100 p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 w-100" style="font-size: 0.85rem;">
              <thead class="bg-light sticky-top text-secondary">
                <tr>
                  <th class="ps-4 py-2">Task Name</th>
                  <th>Type</th>
                  <th>Assignee</th>
                  <th>Due Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="detail-task-list-body"></tbody>
            </table>
          </div>
        </div>

        <div id="detail-view-kanban" class="view-section h-100" style="display:none;">
          <div class="kanban-container" id="kanban-board"></div>
        </div>

        <div id="detail-view-calendar" class="view-section h-100 p-3" style="display:none;">
          <div id='task-calendar' style="height: 100%;"></div>
        </div>


<div id="detail-view-content" class="view-section h-100 p-0" style="display:none;">
    
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body d-flex justify-content-between align-items-center py-3">
            <div>
                <h5 class="mb-1 fw-bold text-primary">
                    <i class="fas fa-layer-group me-2"></i>Content Hub
                </h5>
                <small class="text-muted">วางแผนและติดตามสถานะงานคอนเทนต์ (Content / Graphic / VDO / Ads)</small>
            </div>
            <div>
                <span class="badge bg-white text-secondary border px-3 py-2">
                    <i class="fas fa-list me-1"></i> Total: <span id="content-count" class="fw-bold text-dark">0</span>
                </span>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle" style="font-size:0.9rem;">
                    <thead class="bg-light text-secondary border-bottom">
                        <tr>
                            <th class="ps-4" width="12%">Date</th>
                            <th width="15%">Content Pillar</th>
                            <th width="10%">Media Type</th>
                            <th width="35%">Content Ideas / Topic</th>
                            <th width="10%">Status</th>
                            <th width="18%" class="pe-4 text-end">Action / Link</th>
                        </tr>
                    </thead>
                    <tbody id="content-plan-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


        <div id="detail-view-summary" class="view-section h-100 p-4" style="display:none;">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="card h-100 border p-3 shadow-sm">
                <h6 class="fw-bold text-secondary mb-3">Status Overview</h6><canvas id="detailChartStatus"
                  style="max-height:200px;"></canvas>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card h-100 border p-3 shadow-sm">
                <h6 class="fw-bold text-secondary mb-3">Task Types</h6><canvas id="detailChartType"
                  style="max-height:200px;"></canvas>
              </div>
            </div>
            <div class="col-12">
              <div class="card border shadow-sm">
                <div class="bg-light px-3 py-2 fw-bold text-secondary border-bottom">Team Performance</div>
                <table class="table mb-0 table-sm">
                  <tbody id="detail-workload-list"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="chat-header"><i class="fas fa-comments text-primary me-2"></i> Activity Log</div>
      <div class="chat-box" id="timeline-container"></div>
      <div class="chat-input-area">
        <div id="upload-preview"
          class="mb-2 p-2 bg-white border rounded small d-flex justify-content-between align-items-center"
          style="display:none;">
          <span><i class="fas fa-paperclip me-2 text-muted"></i><span id="preview-name"
              class="fw-bold text-dark"></span></span>
          <i class="fas fa-times text-danger" style="cursor:pointer;" onclick="clearFile()"></i>
        </div>
        <div class="d-flex gap-2 align-items-end">
          <input type="file" id="file-input" style="display:none;" onchange="handleFileSelect(this)">
          <button class="btn btn-light border rounded-circle text-muted" style="width:34px;height:34px;"
            onclick="document.getElementById('file-input').click()"><i class="fas fa-paperclip"></i></button>
          <textarea id="new-update-input" class="form-control rounded-3 border auto-expand-textarea" rows="1"
            placeholder="พิมพ์ข้อความ..." style="min-height:38px;" oninput="autoResize(this)"></textarea>
          <button class="btn btn-primary rounded-circle shadow-sm" style="width:34px;height:34px;"
            onclick="sendUpdate()"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addTaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">เพิ่มงานใหม่</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="create-task-form">
          <div class="mb-2">
            <label class="small fw-bold">ชื่องาน *</label>
            <input type="text" class="form-control" name="taskName" required>
          </div>
          
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="small fw-bold">ประเภท</label>
              <select class="form-select" name="taskType" id="task-type-select"></select>
            </div>
            <div class="col-6">
              <label class="small fw-bold">ผู้รับผิดชอบ</label>
              <select class="form-select" name="assignee" id="assignee-select"></select>
            </div>
          </div>

          <div class="row g-2 mb-2">
  <div class="col-6">
    <label class="small fw-bold text-muted">Pillar</label>
    <select class="form-select form-select-sm" id="create-task-pillar">
      <option value="">-- Select Pillar --</option>
      <option value="Awareness">Awareness</option>
      <option value="Consideration">Consideration</option>
      <option value="Conversion">Conversion</option>
      <option value="Real-time">Real-time Content</option>
      <option value="Engagement">Engagement</option>
    </select>
  </div>
  <div class="col-6">
    <label class="small fw-bold text-muted">Media Type</label>
    <select class="form-select form-select-sm" id="create-task-media">
      <option value="">-- Select Type --</option>
      <option value="Single">Single Image</option>
      <option value="Video">Video / Reels</option>
      <option value="Carousel">Carousel</option>
      <option value="Article">Article / Link</option>
    </select>
  </div>
</div>
          <div class="mb-2">
            <label class="small fw-bold">กำหนดส่ง</label>
            <input type="date" class="form-control" name="dueDate">
          </div>
          <hr>
          <div class="mb-2">
            <label class="small">ลิงก์บรีฟ</label>
            <input type="url" class="form-control form-control-sm" name="briefLink">
          </div>
          <div class="mb-2">
            <label class="small">แนบไฟล์</label>
            <input type="file" class="form-control form-control-sm" id="task-file-input">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
        <button type="button" class="btn btn-primary" onclick="submitNewTask()">บันทึก</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="viewTaskModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      
      <div class="modal-header border-bottom-0 pb-0">
          <span class="badge bg-light text-muted border" id="view-task-id">ID</span>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body pt-2">
        <h5 class="fw-bold text-dark mb-2" id="view-task-name-full" style="line-height:1.4;">Task Name</h5>
        
        <div class="d-flex gap-2 mb-4 align-items-center">
            <span class="badge" id="view-task-status-badge">Status</span>
            <span class="badge bg-white text-secondary border fw-normal" id="view-task-type">Type</span>
            <span class="badge bg-light text-dark border fw-normal" id="view-task-pillar" style="display:none;">Pillar</span>
        </div>

        <div class="row g-3 mb-4 p-3 bg-light rounded border mx-0">
          <div class="col-6">
              <small class="text-muted d-block text-uppercase fw-bold" style="font-size:0.65rem;">Assignee</small>
              <div class="fw-bold text-dark mt-1" id="view-task-assignee">-</div>
          </div>
          <div class="col-6 border-start ps-3">
              <small class="text-muted d-block text-uppercase fw-bold" style="font-size:0.65rem;">Due Date</small>
              <div class="fw-bold text-dark mt-1" id="view-task-due">-</div>
          </div>
        </div>

       

     <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="fw-bold small text-muted text-uppercase mb-0">ขั้นตอนการทำงาน (Workflow)</h6>
    
    <!-- <button class="btn btn-outline-primary btn-sm py-0 px-2" style="font-size: 0.7rem;" onclick="event.stopPropagation(); openManageWorkflow()">
        <i class="fas fa-cog me-1"></i> Edit / Add Steps
    </button> -->
</div>

<div id="view-task-workflow" class="workflow-container mb-4"></div>
        
        <h6 class="fw-bold small text-muted text-uppercase mb-2 mt-2">Attachments / Files</h6>
        <div id="view-task-resources" class="d-flex flex-column gap-2 mb-3">
            <div class="text-muted small fst-italic ps-2">- No Attachments -</div>
        </div>

         <div id="view-task-remark-container" class="mb-4" style="display:none;">
             <h6 class="fw-bold small text-muted text-uppercase mb-2"><i class="fas fa-sticky-note me-1"></i> Remark / Note</h6>
             <div class="p-2 bg-light border rounded text-secondary small" id="view-task-remark" style="white-space: pre-wrap;"></div>
        </div>

      </div>
      
      <div class="modal-footer bg-light border-top-0 justify-content-between">
        <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill" data-bs-dismiss="modal">Close</button>
        <div id="view-task-actions"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="manageWorkflowModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h6 class="modal-title fw-bold"><i class="fas fa-stream me-2"></i>Manage Workflow</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <input type="hidden" id="manage-wf-task-id">
                
                <div class="row px-2 mb-2 fw-bold small text-muted text-uppercase">
                    <div class="col-4">Step Name</div>
                    <div class="col-3">Assignee</div>
                    <div class="col-3">Due Date</div>
                    <div class="col-2 text-center">Action</div>
                </div>

                <div id="manage-wf-container" class="d-flex flex-column gap-2"></div>

                <button class="btn btn-outline-primary w-100 mt-3 border-dashed" onclick="addWorkflowRow()">
                    <i class="fas fa-plus me-1"></i> Add New Step
                </button>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="saveWorkflowChanges()">Save Workflow</button>
            </div>
        </div>
    </div>
</div>




<div class="modal fade" id="assignStepModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-white border-bottom-0 pb-2">
        <h6 class="modal-title fw-bold text-secondary text-uppercase" style="font-size:0.85rem;"><i
            class="fas fa-user-tag me-2 text-primary"></i>มอบหมายงาน</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-2">
        <input type="hidden" id="workflow-task-id">
        <input type="hidden" id="workflow-step-index">
        <div class="mb-3">
          <label class="form-label small fw-bold text-muted">ผู้รับผิดชอบ</label>
          <select class="form-select border-primary bg-light" id="workflow-assignee-select" style="font-size:0.9rem;">
            <option value="Unassigned">-- ไม่ระบุ --</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label small fw-bold text-muted">วันที่ต้องการ (Optional)</label>
          <input type="date" class="form-control form-control-sm" id="workflow-step-date">
        </div>
        <div class="mb-3">
          <label class="form-label small fw-bold text-muted">รายละเอียด</label>
          <textarea class="form-control form-control-sm" id="workflow-step-details" rows="2"
            placeholder="ระบุรายละเอียดเพิ่มเติม..."></textarea>
        </div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-primary w-100 rounded-pill shadow-sm"
          onclick="saveStepAssignee()">บันทึก</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="updateRemarkModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark border-0">
        <h6 class="modal-title fw-bold"><i class="fas fa-edit me-2"></i>อัปเดตหมายเหตุ</h6><button type="button"
          class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><input type="hidden" id="remark-project-id"><label
          class="form-label small text-muted">ข้อความเดิม</label>
        <div id="old-remark-text" class="p-2 bg-light border rounded mb-3 text-muted small"></div><label
          class="form-label fw-bold">ข้อความใหม่</label><textarea id="new-remark-text" class="form-control"
          rows="3"></textarea>
      </div>
      <div class="modal-footer border-0 pt-0"><button type="button" class="btn btn-light btn-sm"
          data-bs-dismiss="modal">ปิด</button><button type="button" class="btn btn-warning btn-sm fw-bold"
          onclick="saveRemark()">บันทึก</button></div>
    </div>
  </div>
</div>
<div class="modal fade" id="reviseModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning text-dark border-0">
        <h5 class="modal-title fw-bold"><i class="fas fa-undo-alt me-2"></i>สั่งแก้ไขงาน (Revise)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-3">
    <input type="hidden" id="revise-task-id">
    <input type="hidden" id="revise-task-name">

    <div class="alert alert-light border border-warning d-flex align-items-center mb-3">
        <i class="fas fa-exclamation-triangle text-warning me-3 fs-4"></i>
        <div>
            <div class="small text-muted fw-bold text-uppercase">กำลังสั่งแก้</div>
            <strong class="text-dark" id="revise-task-display-name">-</strong>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label small fw-bold text-muted">ต้องการสั่งแก้ขั้นตอนไหน? (Select Step)</label>
        <select id="revise-step-select" class="form-select border-warning bg-light text-dark fw-bold">
            </select>
    </div>

    <div class="mb-3">
        <label class="form-label small fw-bold text-muted">กำหนดส่งงานแก้ (New Due Date)</label>
        <input type="date" id="revise-due-date" class="form-control">
    </div>

      
        <div class="mb-3">
          <label class="form-label small fw-bold text-muted">เหตุผล / สิ่งที่ต้องแก้ *</label>
          <textarea id="revise-reason" class="form-control" rows="3" placeholder="ระบุสิ่งที่ต้องแก้ไข..."></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label small fw-bold text-muted">แนบไฟล์ตัวอย่าง (Optional)</label>
          <input type="file" id="revise-file" class="form-control form-control-sm">
        </div>

        <div class="mb-2">
          <label class="form-label small fw-bold text-muted">แนบลิงก์ (Optional)</label>
          <input type="url" id="revise-link" class="form-control form-control-sm" placeholder="https://...">
        </div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">ยกเลิก</button>
        <button type="button" class="btn btn-warning btn-sm fw-bold px-4 shadow-sm"
          onclick="submitRevise()">ยืนยันสั่งแก้</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="dailyTasksModal" tabindex="-1" style="z-index: 1070;">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header bg-light">
        <h6 class="modal-title fw-bold text-primary" id="dailyTasksTitle">
          <i class="fas fa-calendar-day me-2"></i>รายละเอียดงาน
        </h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-2" id="dailyTasksBody" style="background: #f8f9fa;">
        </div>
    </div>
  </div>
</div>


<div class="modal fade" id="contentTaskModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-navy text-white" style="background-color: #1e293b;">
        <h6 class="modal-title fw-bold">
          <i class="fas fa-pen-nib me-2"></i>Content Details
        </h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="content-form">
          <input type="hidden" id="content-task-id">
          <input type="hidden" id="content-date">
          
          <div class="mb-3">
            <label class="small fw-bold text-muted">Date</label>
            <div id="content-date-display" class="fw-bold text-primary"></div>
          </div>

          <div class="mb-3">
            <label class="small fw-bold text-muted">Assignee (ผู้รับผิดชอบ)</label>
            <select class="form-select form-select-sm" id="content-assignee">
                <option value="Unassigned">-- Select Assignee --</option>
            </select>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="small fw-bold text-muted">Pillar</label>
              <select class="form-select form-select-sm" id="content-pillar">
                <option value="">-- Select Pillar --</option>
                <option value="Awareness">Awareness</option>
                <option value="Consideration">Consideration</option>
                <option value="Conversion">Conversion</option>
                <option value="Real-time">Real-time Content</option>
                <option value="Engagement">Engagement</option>
              </select>
            </div>
            <div class="col-6">
              <label class="small fw-bold text-muted">Media Type</label>
              <select class="form-select form-select-sm" id="content-media">
                <option value="">-- Select Type --</option>
                <option value="Single">Single Image</option>
                <option value="Video">Video / Reels</option>
                <option value="Carousel">Carousel</option>
                <option value="Article">Article / Link</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="small fw-bold text-muted">Content Ideas / Topic</label>
            <textarea class="form-control" id="content-idea" rows="4" placeholder="พิมพ์รายละเอียดไอเดีย (รองรับการขึ้นบรรทัดใหม่)"></textarea>
          </div>

          <div class="mb-3">
            <label class="small fw-bold text-muted">Remark (Link / Note)</label>
            <div class="input-group">
                <span class="input-group-text bg-light"><i class="fas fa-link small"></i></span>
                <input type="text" class="form-control form-control-sm" id="content-remark" placeholder="วางลิงก์ หรือพิมพ์หมายเหตุ...">
            </div>
          </div>
          
          <div class="mb-3">
             <label class="small fw-bold text-muted">แนบรูปภาพ (Optional)</label>
             
             <div id="content-current-file" class="mb-2"></div>
             
             <input type="file" id="content-file" class="form-control form-control-sm">
          </div>

        </form>
      </div>

      <div class="modal-footer border-0 pt-0 justify-content-between"> 
          <button type="button" id="btn-delete-content" class="btn btn-outline-danger btn-sm rounded-pill" style="display:none;" onclick="deleteContentTask()">
              <i class="fas fa-trash-alt me-1"></i> Delete
          </button>

          <div class="d-flex gap-2">
              <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary btn-sm px-4 rounded-pill" onclick="saveContentTask()">Save Content</button>
          </div>
      </div>
    </div>
  </div>
</div>



<script>
  // ==========================================
  // 1. GLOBAL VARIABLES & CONFIG
  // ==========================================
  let currentProjectId = null;
  let selectedFile = null;
  let calendarInstance = null;
  let chartStatusInstance = null;
  let chartTypeInstance = null;
  let lastUpdateId = null; 
  let pollingInterval = null;
  let currentContentDate = new Date(); 
  
  // ตัวแปรสำหรับ Workflow Manager
  let tempWorkflow = [];

  const ROLE_MAP = {
      'Content': ['Content', 'Editor'], 
      'Graphic': ['Graphic', 'Designer'], 
      'VDO': ['VDO', 'Editor'],
      'Admin': ['Admin'], 
      'Ads': ['AE', 'Ads Specialist'], 
      'Web': ['Programmer', 'Web Developer'], 
      'Other': []
  };

  const WORKFLOW_TEMPLATES = {
      'VDO': [{name:'Script/Storyboard',role:'Content'}, {name:'Shooting',role:'VDO'}, {name:'Editing',role:'Editor'}, {name:'Final QC',role:'Manager'}],
      'Graphic': [{name:'Brief Concept',role:'Content'}, {name:'Draft Design',role:'Graphic'}, {name:'Finalize',role:'Graphic'}],
      'Content': [{name:'Topic/Keyword',role:'Content'}, {name:'Drafting',role:'Content'}, {name:'Proofread',role:'Editor'}],
      'Web': [{name:'Structure/UX',role:'Web'}, {name:'UI Design',role:'Graphic'}, {name:'Coding',role:'Web'}],
      'Default': [{name:'To Do',role:'Any'}, {name:'Doing',role:'Any'}, {name:'Done',role:'Any'}]
  };

  // Helper: Auto resize textarea
  function autoResize(el) { 
      el.style.height = 'auto'; 
      el.style.height = el.scrollHeight + 'px'; 
  }

  // ==========================================
  // 2. MAIN NAVIGATION (OPEN PROJECT)
  // ==========================================
  // ==========================================
// ✅ ฟังก์ชันเปิดหน้า Project Detail (ฉบับสมบูรณ์)
// ==========================================
function openProjectDetail(pid) {
    console.log("Opening Project ID:", pid);

    // 1. บันทึก Project ID ปัจจุบัน
    // (ใช้ window.currentProjectId เพื่อให้เป็น Global จริงๆ)
    window.currentProjectId = pid;
    
    // 2. ค้นหาข้อมูลโปรเจกต์จาก globalData
    if (!globalData || !globalData.projects) return alert("ข้อมูลระบบยังไม่ถูกโหลด");
    const p = globalData.projects.find(x => x[0] === pid);
    
    if (!p) return alert("ไม่พบข้อมูลโปรเจกต์ ID: " + pid);

    // 3. กรองงาน (Tasks) ทั้งหมดของโปรเจกต์นี้รอไว้
    const tasks = globalData.tasks.filter(x => x[1] === pid);

    
    
    // 4.1 Header & Status
    if(document.getElementById('detail-title')) document.getElementById('detail-title').innerText = p[1]; // Project Name
    if(document.getElementById('detail-subtitle')) document.getElementById('detail-subtitle').innerText = p[2]; // Product/Client
    
    const statusBadge = document.getElementById('detail-status-badge');
    if(statusBadge) {
        statusBadge.innerText = p[9];
        statusBadge.className = `badge ${p[9]==='Active'?'bg-success':(p[9]==='Hold'?'bg-warning text-dark':(p[9]==='Completed'?'bg-secondary':'bg-light text-dark border'))}`;
    }


// ✅ วิธีที่ง่ายที่สุด: ยัด URL ใส่ href โดยตรง
const sheetLinkBtn = document.getElementById('detail-sheet-link');
if (sheetLinkBtn) {
    const p = globalData.projects.find(x => x[0] === pid);
    const sheetUrl = p[8]; // ดึงจากคอลัมน์ที่ 9 ของตาราง Projects (Index 8)

    if (sheetUrl && sheetUrl.toString().startsWith('http')) {
        // ถ้ามีลิงก์: เปลี่ยนสีปุ่มและใส่ลิงก์จริง
        sheetLinkBtn.href = sheetUrl.trim();
        sheetLinkBtn.classList.remove('btn-light', 'text-muted');
        sheetLinkBtn.classList.add('btn-custom');
        sheetLinkBtn.onclick = null; // ปล่อยให้เบราว์เซอร์เปิดแท็บใหม่เอง
    } else {
        // ถ้าไม่มีลิงก์: ทำเป็นสีเทาและแจ้งเตือน
        sheetLinkBtn.href = "javascript:void(0)";
        sheetLinkBtn.classList.remove('btn-custom');
        sheetLinkBtn.classList.add('btn-light', 'text-muted');
        sheetLinkBtn.onclick = function() {
            alert("โปรเจกต์นี้ยังไม่ได้ระบุลิงก์ Google Sheet");
            return false;
        };
    }
}
    if(document.getElementById('info-budget')) document.getElementById('info-budget').innerText = p[4] || '-';
    if(document.getElementById('info-period')) document.getElementById('info-period').innerText = p[5] || '-';
    if(document.getElementById('info-ae')) document.getElementById('info-ae').innerText = p[3] || '-';
    if(document.getElementById('info-product')) document.getElementById('info-product').innerText = p[2] || '-';

    // 4.4 Target Badges (เป้าหมายงาน)
    const targetDiv = document.getElementById('target-badges');
    if(targetDiv) {
        targetDiv.innerHTML = '';
        // ฟังก์ชันย่อยสร้าง Badge
        const createTag = (icon, label, value) => { 
            if(value && value != '0' && value != '-') {
                targetDiv.innerHTML += `
                <div class="target-tag">
                    <i class="fas ${icon} text-primary"></i> ${label}: 
                    <span class="fw-bold text-dark ms-1">${value}</span>
                </div>`; 
            }
        };
        // เรียกสร้างตามลำดับ
        createTag('fa-pen-nib', 'Content', p[6]); 
        createTag('fa-palette', 'Graphic', p[15]); 
        createTag('fa-video', 'VDO', p[7]); 
        createTag('fa-comments', 'Admin', p[11]); 
        createTag('fa-ad', 'Ads', p[12]); 
        createTag('fa-globe', 'Web', p[13]);
    }

    // 4.5 Remark Section (แก้ไขให้กดได้แน่นอน)
    // ... (ส่วนอื่นๆ ของ openProjectDetail) ...

    // 4.5 Remark Section (แก้ไขให้กดได้แน่นอน)
    const remarkDiv = document.getElementById('remark-box');
    const remarkContent = document.getElementById('remark-text-content');
    
    if(remarkDiv && remarkContent) {
        // แสดงกล่องเสมอ
        remarkDiv.style.display = 'flex'; 
        
        // เตรียมข้อความ (ถ้าไม่มีใส่ข้อความ Default)
        const remarkText = p[14] || '';
        
        if(remarkText.trim() === '') {
            remarkContent.innerHTML = `<span class="text-muted fst-italic"><i class="fas fa-plus-circle me-1"></i> เพิ่มหมายเหตุ...</span>`;
        } else {
            // แปลง \n เป็น <br> เพื่อการแสดงผลที่สวยงาม
            remarkContent.innerHTML = remarkText.replace(/\n/g, '<br>');
        }

        // ✅ แก้ไขตรงนี้: ล้าง Event เก่าก่อน แล้วใส่ Event ใหม่เข้าไป
        // เพื่อป้องกันการกดซ้ำ หรือ Event หายไป
        remarkDiv.onclick = null; 
        remarkDiv.onclick = function() {
            // เรียกใช้ฟังก์ชันที่มีอยู่แล้วในระบบ
            if(typeof openUpdateRemark === 'function') {
                openUpdateRemark(p[0], p[14] || '');
            } else {
                console.error("Function openUpdateRemark not found!");
            }
        };
    }

  
    // ==========================================
    // 5. Render Views (วาดกราฟและตาราง)
    // ==========================================
    
    // ตรวจสอบว่าฟังก์ชันมีอยู่จริงไหมก่อนเรียกใช้ (กัน Error)
    if(typeof renderListView === 'function') renderListView(tasks);
    if(typeof renderKanbanView === 'function') renderKanbanView(tasks);
    if(typeof renderSummaryView === 'function') renderSummaryView(tasks);
    if(typeof renderTimeline === 'function') renderTimeline(pid); // Chat Log
    
    // Calendar ต้องรอนิดนึงให้ DOM พร้อม หรือเรียกตอนสลับ Tab
    if(typeof renderCalendarView === 'function') {
        setTimeout(() => renderCalendarView(tasks), 200); 
    }

    // ==========================================
    // 6. เปลี่ยนหน้าจอ (Switch Page)
    // ==========================================
    
    // รีเซ็ต Tab ไปที่หน้าแรก (Summary) เสมอเวลาเปิดโปรเจกต์ใหม่
    if(typeof switchDetailTab === 'function') switchDetailTab('summary');

    // เรียกฟังก์ชันสลับหน้าหลัก (ถ้ามี)
    if(typeof showPage === 'function') {
        showPage('page-detail'); 
    } else {
        // Fallback: สลับ CSS display เองถ้าไม่มี function showPage
        document.querySelectorAll('.page-section').forEach(el => el.style.display = 'none');
        const detailPage = document.getElementById('page-detail');
        if(detailPage) detailPage.style.display = 'block';
    }
    
    // เลื่อนหน้าจอไปบนสุด
    window.scrollTo(0, 0);
}

  function switchDetailTab(tabName) {
      // 1. จัดการ Active Class
      document.querySelectorAll('#detail-tabs .nav-link').forEach(el => el.classList.remove('active'));
      const targetLink = document.querySelector(`#detail-tabs .nav-link[onclick*="'${tabName}'"]`);
      if(targetLink) targetLink.classList.add('active');

      // 2. ซ่อนทุกหน้า
      document.querySelectorAll('.view-content > div').forEach(el => el.style.display = 'none');
      const targetView = document.getElementById(`detail-view-${tabName}`);
      if(targetView) targetView.style.display = 'block';

      // 3. ซ่อน Chat (Right Panel) สำหรับ List, Kanban, Calendar, Content
      const rightPanel = document.querySelector('.right-panel');
      const leftPanel = document.querySelector('.left-panel');

      if (['content', 'list', 'kanban', 'calendar'].includes(tabName)) {
          if(rightPanel) rightPanel.style.display = 'none';
          if(leftPanel) leftPanel.style.width = '100%';
      } else {
          if(rightPanel) rightPanel.style.display = 'flex';
          if(leftPanel) leftPanel.style.width = '65%';
      }

      // 4. Render เฉพาะหน้า
      if(tabName === 'calendar') {
          const tasks = globalData.tasks.filter(x => x[1] === currentProjectId);
          setTimeout(() => renderCalendarView(tasks), 50);
      }
      else if (tabName === 'content') {
          renderContentPlanView();
      }
  }

  // ==========================================
  // 3. TASK & CONTENT ACTIONS
  // ==========================================

  function openAddTaskModal() {
      const p = globalData.projects.find(x => x[0] === currentProjectId); if(!p) return;
      const typeSelect = document.getElementById('task-type-select'); typeSelect.innerHTML = ''; 
      
      const checkAndAdd = (val, name) => { if(val && val != '0' && val != '-') { const opt = document.createElement('option'); opt.value = name; opt.text = name; typeSelect.appendChild(opt); } };
      checkAndAdd(p[6],'Content'); checkAndAdd(p[15],'Graphic'); checkAndAdd(p[7],'VDO'); checkAndAdd(p[11],'Admin'); checkAndAdd(p[12],'Ads'); checkAndAdd(p[13],'Web');
      
      if(typeSelect.options.length === 0) ['Content','Graphic','VDO','Admin','Web','Ads'].forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.text = t; typeSelect.appendChild(opt); });
      else { const opt = document.createElement('option'); opt.value = 'Other'; opt.text = 'Other'; typeSelect.appendChild(opt); }

      // Filter Assignee (Optional implementation needed for filterAssignees)
      // if(typeSelect.value) filterAssignees(typeSelect.value); 
      
      new bootstrap.Modal(document.getElementById('addTaskModal')).show();
  }

  function submitNewTask() { 
      const f = document.getElementById('create-task-form'); 
      if(!f.taskName.value) return alert('กรุณาระบุชื่องาน'); 
      
      const d = {
          projectId: currentProjectId, 
          taskName: f.taskName.value, 
          taskType: f.taskType.value, 
          assignee: f.assignee.value, 
          dueDate: f.dueDate.value, 
          briefLink: f.briefLink.value,
          pillar: document.getElementById('create-task-pillar').value,
          mediaType: document.getElementById('create-task-media').value
      }; 
      
      const file = document.getElementById('task-file-input').files[0]; 
      const btn = event.target; btn.innerHTML = 'บันทึก...'; btn.disabled = true;

      const handler = (r) => { 
          globalData.tasks.push(r); 
          
          if (currentProjectId) {
              const currentProjectTasks = globalData.tasks.filter(t => t[1] === currentProjectId);
              renderListView(currentProjectTasks);
              renderKanbanView(currentProjectTasks);
              renderContentPlanView();
              renderSummaryView(currentProjectTasks);
          }

          bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide(); 
          f.reset(); 
          document.getElementById('create-task-pillar').value = "";
          document.getElementById('create-task-media').value = "";
          btn.innerHTML = 'บันทึก'; btn.disabled = false;
      }; 
      
      if(file){ 
          const r = new FileReader(); 
          r.onload = function(e){ 
              d.fileData = {name:file.name, mimeType:file.type, data:e.target.result.split(',')[1]}; 
              google.script.run.withSuccessHandler(handler).createTask(d, d.fileData); 
          }; 
          r.readAsDataURL(file); 
      } else { 
          google.script.run.withSuccessHandler(handler).createTask(d, null); 
      } 
  }

  // --- Content Plan Modal ---
  function openContentModal(dateStr, taskId = null) {
    if(!dateStr) return;
    
    document.getElementById('content-form').reset();
    document.getElementById('content-date').value = dateStr;
    document.getElementById('content-task-id').value = taskId || '';
    
    let d = new Date(dateStr);
    document.getElementById('content-date-display').innerText = d.toLocaleDateString('th-TH', {day:'numeric', month:'long', year:'numeric'});

    const currentFileDiv = document.getElementById('content-current-file');
    if(currentFileDiv) currentFileDiv.innerHTML = ''; 

    const btnDelete = document.getElementById('btn-delete-content');
    if (btnDelete) {
        btnDelete.style.display = taskId ? 'block' : 'none';
    }

    const assigneeSelect = document.getElementById('content-assignee');
    assigneeSelect.innerHTML = '<option value="Unassigned">-- Select Assignee --</option>';
    
    if(globalData.allUsers) {
         globalData.allUsers.forEach(u => {
             if (u.status === 'Inactive') return;
             const userName = u.name || u;
             const userRole = u.role || "";
             const fullText = userRole ? `${userName} (${userRole})` : userName; 
             const opt = document.createElement('option');
             opt.value = fullText; opt.text = fullText;  
             assigneeSelect.appendChild(opt);
         });
    }

    if(taskId) {
        const ideaInput = document.getElementById('content-idea');
        ideaInput.disabled = true; ideaInput.value = "กำลังโหลดข้อมูล...";

        google.script.run.withSuccessHandler(function(task) {
            ideaInput.disabled = false;
            if(task) {
                ideaInput.value = task[3] || ''; 
                let currentAssignee = task[4]; 
                if(currentAssignee && currentAssignee !== 'Unassigned') {
                    let exists = Array.from(assigneeSelect.options).some(opt => opt.value === currentAssignee);
                    if (!exists) {
                        const opt = document.createElement('option');
                        opt.value = currentAssignee; opt.text = currentAssignee; assigneeSelect.appendChild(opt);
                    }
                    assigneeSelect.value = currentAssignee; 
                } else {
                    assigneeSelect.value = "Unassigned";
                }
                
                document.getElementById('content-pillar').value = task[13] || ''; 
                document.getElementById('content-media').value = task[14] || ''; 
                document.getElementById('content-remark').value = task[15] || ''; 

                if (task[9] && currentFileDiv) {
                    currentFileDiv.innerHTML = `<div class="d-flex align-items-center gap-2 p-2 border rounded bg-light small mt-2"><i class="fas fa-file-image text-danger fs-5"></i><div style="overflow:hidden;"><div class="text-muted" style="font-size:0.7rem;">ไฟล์ปัจจุบัน:</div><a href="${task[9]}" target="_blank" class="fw-bold text-decoration-none text-dark d-block text-truncate" style="max-width: 200px;">${task[10] || 'View File'}</a></div></div>`;
                }
            } else {
                ideaInput.value = ""; alert("ไม่พบข้อมูลงานนี้");
            }
        }).getTaskById(taskId);
    }
    new bootstrap.Modal(document.getElementById('contentTaskModal')).show();
  }

  function saveContentTask() {
    const btn = event.target; 
    const taskId = document.getElementById('content-task-id').value;
    const dateStr = document.getElementById('content-date').value;
    
    const data = {
        taskId: taskId,
        projectId: currentProjectId,
        dueDate: dateStr,
        taskName: document.getElementById('content-idea').value, 
        assignee: document.getElementById('content-assignee').value,
        pillar: document.getElementById('content-pillar').value,
        mediaType: document.getElementById('content-media').value,
        remark: document.getElementById('content-remark').value,
        taskType: 'Content', 
        status: 'To Do' 
    };
    
    const fileInput = document.getElementById('content-file');
    const file = fileInput.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            submitToBackend(data, { name: file.name, mimeType: file.type, data: e.target.result.split(',')[1] }, btn);
        };
        reader.readAsDataURL(file);
    } else {
        submitToBackend(data, null, btn);
    }
  }

  function submitToBackend(data, filePayload, btn) {
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    btn.disabled = true;

    google.script.run.withSuccessHandler((res) => {
        if (!data.taskId) { globalData.tasks.push(res); } 
        else {
            const idx = globalData.tasks.findIndex(t => t[0] === res[0]);
            if(idx !== -1) globalData.tasks[idx] = res;
        }
        
        if (currentProjectId) {
            const currentProjectTasks = globalData.tasks.filter(t => t[1] === currentProjectId);
            renderContentPlanView(); 
            renderListView(currentProjectTasks);   
            renderKanbanView(currentProjectTasks); 
            renderSummaryView(currentProjectTasks);
        }

        bootstrap.Modal.getInstance(document.getElementById('contentTaskModal')).hide();
        btn.innerHTML = 'Save Content'; btn.disabled = false;
        
    }).withFailureHandler((err) => {
        alert("เกิดข้อผิดพลาด: " + err.message);
        btn.innerHTML = originalText; btn.disabled = false;
    }).saveContentTaskDB(data, filePayload);
  }

  function deleteContentTask() {
    const taskId = document.getElementById('content-task-id').value;
    if(!taskId) return;

    if(confirm("คุณต้องการลบงานนี้ใช่หรือไม่? \n(การกระทำนี้ไม่สามารถย้อนกลับได้)")) {
        const btn = document.getElementById('btn-delete-content');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...'; btn.disabled = true;

        google.script.run.withSuccessHandler(function(res) {
            if(res.success) {
                const idx = globalData.tasks.findIndex(t => t[0] === taskId);
                if(idx !== -1) globalData.tasks.splice(idx, 1);

                renderContentPlanView(); 
                if (currentProjectId) {
                    const currentProjectTasks = globalData.tasks.filter(t => t[1] === currentProjectId);
                    renderListView(currentProjectTasks);   
                    renderKanbanView(currentProjectTasks); 
                }
                bootstrap.Modal.getInstance(document.getElementById('contentTaskModal')).hide();
            } else {
                alert("เกิดข้อผิดพลาด: " + res.message);
            }
            btn.innerHTML = originalText; btn.disabled = false;
        }).deleteTaskDB(taskId);
    }
  }

  // ==========================================
  // 4. VIEW / RENDER FUNCTIONS
  // ==========================================

  function renderListView(tasks) {
      let html='';
      tasks.forEach(t => {
          let s = t[5]; // Status
          let sClass = 'bg-secondary'; let sIcon = 'fa-clock';
          if(s === 'Done' || s === 'Completed') { sClass = 'bg-success'; sIcon = 'fa-check-circle'; }
          else if(s === 'In Progress' || s === 'Doing') { sClass = 'bg-primary'; sIcon = 'fa-spinner fa-spin'; }
          else if(s === 'Revise') { sClass = 'bg-danger'; sIcon = 'fa-exclamation-triangle'; }
          else if(s === 'To Do') { sClass = 'bg-info text-dark'; sIcon = 'fa-list-ul'; }

          let showType = t[14] || t[2];
          let typeBadgeClass = t[14] ? 'bg-white text-primary border border-primary' : 'bg-light text-secondary border';

          html += `
          <tr class="clickable-row" onclick="openTaskView('${t[0]}')">
              <td class="ps-4">
                  <div class="fw-bold text-dark">${t[3]}</div>
                  ${t[9] ? '<div class="text-muted small"><i class="fas fa-paperclip me-1"></i> มีไฟล์แนบ</div>' : ''}
              </td>
              <td><span class="badge ${typeBadgeClass} fw-normal">${showType}</span></td>
              <td><div class="d-flex align-items-center text-muted small"><i class="fas fa-user-circle me-2 fa-lg"></i>${t[4]}</div></td>
              <td class="${t[7] && new Date(t[7]) < new Date() && s !== 'Done' ? 'text-danger fw-bold' : 'text-muted'}">${t[7] || '-'}</td>
              <td><span class="badge ${sClass}" style="min-width: 80px;"><i class="fas ${sIcon} me-1"></i> ${s}</span></td>
          </tr>`;
      });
      const tbody = document.getElementById('detail-task-list-body');
      if(tbody) tbody.innerHTML = html || '<tr><td colspan="5" class="text-center p-5 text-muted">ไม่พบรายการงาน</td></tr>';
  }

  function renderKanbanView(tasks) {
      const board = document.getElementById('kanban-board');
      const columns = {
          'Pending': { title: 'To Do / Pending', items: [], color: '#6c757d' },
          'In Progress': { title: 'In Progress', items: [], color: '#0d6efd' },
          'Revise': { title: 'Revise', items: [], color: '#dc3545' },
          'Done': { title: 'Done', items: [], color: '#198754' }
      };

      tasks.forEach(t => {
          let s = t[5];
          if(s === 'To Do' || s === 'Pending') columns['Pending'].items.push(t);
          else if(s === 'Revise') columns['Revise'].items.push(t);
          else if(s === 'Done') columns['Done'].items.push(t);
          else columns['In Progress'].items.push(t);
      });

      let html = '';
      for (const [key, col] of Object.entries(columns)) {
          let statusValue = key === 'In Progress' ? 'In Progress' : (key === 'Pending' ? 'Pending' : key);
          let cardsHtml = '';
          col.items.forEach(t => {
              let showType = t[14] || t[2];
              let cardBorderClass = key === 'Revise' ? 'border-danger border-2' : '';
              cardsHtml += `
              <div class="kanban-card ${cardBorderClass}" draggable="true" id="card-${t[0]}" ondragstart="drag(event)" onclick="openTaskView('${t[0]}')">
                  <div class="d-flex justify-content-between mb-2">
                      <span class="badge bg-light text-dark border fw-normal" style="font-size:0.65rem;">${showType}</span>
                      ${t[9] ? '<i class="fas fa-paperclip text-muted small"></i>' : ''}
                  </div>
                  <div class="fw-bold mb-3 text-dark" style="font-size:0.9rem; line-height:1.4;">${t[3]}</div>
                  <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                      <div class="d-flex align-items-center text-muted small"><i class="fas fa-user-circle me-1"></i> ${t[4].split(' ')[0]}</div>
                      <div class="${t[7] && new Date(t[7]) < new Date() ? 'text-danger fw-bold' : 'text-muted'} small">${t[7] || ''}</div>
                  </div>
              </div>`;
          });
          html += `<div class="kanban-col" ondrop="drop(event, '${statusValue}')" ondragover="allowDrop(event)">
              <div class="kanban-header" style="border-top: 3px solid ${col.color};">
                  <span class="fw-bold" style="color:${col.color}">${col.title}</span>
                  <span class="badge rounded-pill bg-secondary ms-1">${col.items.length}</span>
              </div>
              ${cardsHtml}
          </div>`;
      }
      board.innerHTML = html;
  }

  // --- Content Plan Calendar Render ---
  function changeContentMonth(offset) {
    currentContentDate.setMonth(currentContentDate.getMonth() + offset);
    renderContentPlanView(); 
  }

  function renderContentPlanView() {
    const container = document.getElementById('detail-view-content');
    const year = currentContentDate.getFullYear();
    const month = currentContentDate.getMonth();
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const tasks = globalData.tasks.filter(t => t[1] === currentProjectId);

    let html = `
    <div class="p-4" style="background-color: #f1f5f9; min-height: 100vh;">
        <div class="d-flex justify-content-between align-items-center mb-3">
             <h5 class="fw-bold text-navy mb-0"><i class="fas fa-calendar-alt me-2"></i>Content Plan</h5>
             <div>
                <button class="btn btn-white border shadow-sm btn-sm me-1" onclick="changeContentMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <button class="btn btn-white border shadow-sm btn-sm me-1" onclick="currentContentDate = new Date(); renderContentPlanView();">Today</button>
                <button class="btn btn-white border shadow-sm btn-sm" onclick="changeContentMonth(1)"><i class="fas fa-chevron-right"></i></button>
             </div>
        </div>
        <div class="content-cal-container">
            <table class="content-cal-table">
                <thead>
                    <tr><th colspan="8" class="cal-month-header">${monthNames[month]} ${year}</th></tr>
                    <tr>
                        <th class="cal-label-col text-center">Week</th>
                        <th class="cal-day-header">SUN</th><th class="cal-day-header">MON</th><th class="cal-day-header">TUE</th><th class="cal-day-header">WED</th><th class="cal-day-header">THU</th><th class="cal-day-header">FRI</th><th class="cal-day-header">SAT</th>
                    </tr>
                </thead>
                <tbody>
    `;

    const firstDayOfMonth = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    let currentDay = 1;
    let weekCount = 0;
    
    const getTask = (dateStr) => { if(!dateStr) return null; return tasks.find(t => t[7] === dateStr); };
    const createCell = (dateStr, fieldType, task) => {
        if (!dateStr) return ''; 
        let content = '';
        let clickAction = task ? `onclick="openContentModal('${dateStr}', '${task[0]}')"` : `onclick="openContentModal('${dateStr}')"`;
        
        if (task) {
            if (fieldType === 'pillar') {
                let val = task[13] || '-'; let badgeClass = 'badge-pillar-default'; let vLower = val.toString().toLowerCase();
                if(vLower.includes('awareness')) badgeClass = 'badge-pillar-awareness';
                else if(vLower.includes('consideration')) badgeClass = 'badge-pillar-consideration';
                else if(vLower.includes('conversion') || vLower.includes('sale')) badgeClass = 'badge-pillar-conversion';
                else if(vLower.includes('real-time')) badgeClass = 'badge-pillar-realtime';
                else if(vLower.includes('engagement')) badgeClass = 'badge-pillar-engagement';
                content = `<div class="text-center"><span class="pillar-badge ${badgeClass}">${val}</span></div>`;
            }
            else if (fieldType === 'media') {
                let val = task[14] || '-'; let icon = 'fa-image'; let colorClass = 'badge-media-single'; let vLower = val.toString().toLowerCase();
                if(vLower.includes('video') || vLower.includes('reels')) { icon = 'fa-video'; colorClass = 'badge-media-video'; }
                else if(vLower.includes('carousel') || vLower.includes('album')) { icon = 'fa-images'; colorClass = 'badge-media-album'; }
                content = `<div class="text-center"><span class="badge-media ${colorClass}"><i class="fas ${icon}"></i> ${val}</span></div>`;
            }
            else if (fieldType === 'idea') {
                let taskName = task[3] || 'No Title'; let assignee = task[4] || 'Unassigned';
                content = `<div class="text-dark small fw-bold" style="white-space: pre-wrap; line-height:1.3; font-size:0.8rem;">${taskName}</div>`;
                if (task[9]) content += `<div class="mt-1"><a href="${task[9]}" target="_blank" class="badge bg-light text-primary border text-decoration-none" onclick="event.stopPropagation();"><i class="fas fa-paperclip me-1"></i> รูปภาพ/ไฟล์</a></div>`;
                if(assignee !== 'Unassigned') content += `<div class="text-secondary mt-1" style="font-size:0.7rem;"><i class="fas fa-user-circle text-primary me-1"></i>${assignee}</div>`;
            }
            else if (fieldType === 'remark') {
                  let val = task[15] || ''; 
                  if(val.includes('http')) content = `<a href="${val}" target="_blank" class="text-primary text-decoration-none"><i class="fas fa-link me-1"></i>Open Link</a>`;
                  else content = `<span class="text-muted small">${val}</span>`;
            }
        } else {
            content = `<div class="text-light text-center small opacity-25 h-100 d-flex align-items-center justify-content-center"><i class="fas fa-plus"></i></div>`;
        }
        return `<div class="w-100 h-100 p-1" style="cursor:pointer; min-height:100%;" ${clickAction}>${content}</div>`;
    };

    while (currentDay <= daysInMonth) {
        let weekDays = []; let weekDates = []; 
        for (let i = 0; i < 7; i++) {
            if ((weekCount === 0 && i < firstDayOfMonth) || currentDay > daysInMonth) { weekDays.push(null); weekDates.push(null); } 
            else { weekDays.push(currentDay); weekDates.push(year + '-' + String(month+1).padStart(2,'0') + '-' + String(currentDay).padStart(2,'0')); currentDay++; }
        }
        html += `<tr class="row-date"><td class="cal-label-col">DATE</td>`; weekDays.forEach((day, idx) => html += `<td class="${day?'has-date':''}">${day || ''}</td>`); html += `</tr>`;
        html += `<tr><td class="cal-label-col">Pillar</td>`; weekDays.forEach((day, idx) => html += `<td class="cell-data p-0">${createCell(weekDates[idx], 'pillar', getTask(weekDates[idx]))}</td>`); html += `</tr>`;
        html += `<tr><td class="cal-label-col">Media Type</td>`; weekDays.forEach((day, idx) => html += `<td class="cell-data p-0">${createCell(weekDates[idx], 'media', getTask(weekDates[idx]))}</td>`); html += `</tr>`;
        html += `<tr><td class="cal-label-col">Ideas / Assignee</td>`; weekDays.forEach((day, idx) => html += `<td class="cell-data p-0" style="height:80px; vertical-align:top;">${createCell(weekDates[idx], 'idea', getTask(weekDates[idx]))}</td>`); html += `</tr>`;
        html += `<tr class="week-divider"><td class="cal-label-col">Remark</td>`; weekDays.forEach((day, idx) => html += `<td class="cell-data p-0">${createCell(weekDates[idx], 'remark', getTask(weekDates[idx]))}</td>`); html += `</tr>`;
        weekCount++;
    }
    html += `</tbody></table></div></div>`;
    container.innerHTML = html;
  }

  function renderCalendarView(tasks) { 
      const calendarEl = document.getElementById('task-calendar'); 
      if (!calendarEl) return;
      if (typeof FullCalendar === 'undefined') { calendarEl.innerHTML = '<div class="alert alert-danger p-2 small">Calendar Error</div>'; return; }
      if (calendarInstance) calendarInstance.destroy(); 
      
      const typeColors = { 'Content': '#0d6efd', 'Graphic': '#6f42c1', 'VDO': '#dc3545', 'Web': '#198754', 'Ads': '#fd7e14', 'Admin': '#6c757d', 'Other': '#adb5bd' };

      calendarInstance = new FullCalendar.Calendar(calendarEl, { 
          initialView: 'dayGridMonth', themeSystem: 'standard', 
          headerToolbar: { left: 'title', right: 'today prev,next' }, 
          height: '100%', contentHeight: 'auto', dayMaxEvents: 4, editable: false, fixedWeekCount: false, 
          
          events: tasks.map(t => {
              const type = t[2] || 'Other'; const status = t[5]; const isDone = status === 'Done'; const colorCode = typeColors[type] || typeColors['Other'];
              return { id: t[0], title: t[3], start: t[7] || new Date(), extendedProps: { type: type, status: status, color: colorCode, isDone: isDone } };
          }), 
          eventClick: function(info) { openTaskView(info.event.id); }, 
          eventContent: function(arg) { 
              const props = arg.event.extendedProps;
              let statusIcon = ''; let opacityClass = ''; let decorationClass = '';
              if (props.status === 'Done') { statusIcon = '<i class="fas fa-check-circle text-success ms-1" style="font-size:0.7rem;"></i>'; opacityClass = 'opacity-50'; decorationClass = 'text-decoration-line-through text-muted'; } 
              else if (props.status === 'Revise') { statusIcon = '<i class="fas fa-exclamation-circle text-warning ms-1"></i>'; }
              return { html: `<div class="formal-event-card ${opacityClass}" style="border-left-color: ${props.color};"><div class="event-title ${decorationClass}">${arg.event.title}</div><div>${statusIcon}</div></div>` }; 
          } 
      }); 
      setTimeout(() => calendarInstance.render(), 100); 
  }

  function renderSummaryView(tasks) { 
      const statusCounts = {}; const typeCounts = {}; 
      tasks.forEach(t => { statusCounts[t[5]] = (statusCounts[t[5]]||0)+1; typeCounts[t[2]] = (typeCounts[t[2]]||0)+1; }); 
      
      if(chartStatusInstance) chartStatusInstance.destroy(); 
      chartStatusInstance = new Chart(document.getElementById('detailChartStatus'), { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#0d6efd','#198754','#ffc107','#6c757d'] }] }, options: { responsive: true, maintainAspectRatio: false } }); 
      
      if(chartTypeInstance) chartTypeInstance.destroy(); 
      chartTypeInstance = new Chart(document.getElementById('detailChartType'), { type: 'bar', data: { labels: Object.keys(typeCounts), datasets: [{ label: 'Tasks', data: Object.values(typeCounts), backgroundColor: '#0d6efd' }] }, options: { responsive: true, maintainAspectRatio: false } }); 
      
      let w = {}; 
      tasks.forEach(t => { let u = t[4]||'Unassigned'; if(!w[u]) w[u] = {total:0, done:0}; w[u].total++; if(t[5]==='Done') w[u].done++; }); 
      let html = ''; 
      for(let u in w) { let p = Math.round((w[u].done/w[u].total)*100); html += `<tr><td class="ps-2">${u}</td><td class="text-center">${w[u].done}/${w[u].total}</td><td class="pe-2"><div class="progress" style="height:6px"><div class="progress-bar bg-primary" style="width:${p}%"></div></div></td></tr>`; } 
      document.getElementById('detail-workload-list').innerHTML = html; 
  }

  // ==========================================
  // 5. WORKFLOW & REVISE LOGIC
  // ==========================================

  function openTaskView(taskId) {
    const t = globalData.tasks.find(x => x[0] === taskId); if (!t) return;
    
    // ✅ ประกาศตัวแปร taskType ไว้ตรงนี้ (เพื่อแก้ Error)
    let taskType = t[2]; 

    // 1. Basic Info
    document.getElementById('view-task-id').innerText = t[0];
    document.getElementById('view-task-name-full').innerText = t[3];
    document.getElementById('view-task-assignee').innerText = t[4] || 'Unassigned';
    document.getElementById('view-task-due').innerText = t[7] || '-';

    // 2. Status Badge
    const sBadge = document.getElementById('view-task-status-badge');
    sBadge.innerText = t[5]; 
    sBadge.className = `badge ${t[5]==='Done'?'bg-success':(t[5]==='In Progress'?'bg-primary':(t[5]==='Revise'?'bg-danger':'bg-secondary'))}`;

    // 3. Type Logic
    const typeBadge = document.getElementById('view-task-type');
    let showType = t[14] || taskType; // ใช้ taskType ที่ประกาศไว้
    
    typeBadge.innerText = showType;
    if (t[14]) { 
        typeBadge.className = 'badge bg-white text-primary border border-primary fw-normal'; 
        typeBadge.innerHTML = `<i class="fas fa-photo-video me-1"></i> ${t[14]}`; 
    } else { 
        typeBadge.className = 'badge bg-white text-secondary border fw-normal'; 
        typeBadge.innerText = taskType; 
    }

    // 4. Pillar Badge
    const pillarBadge = document.getElementById('view-task-pillar');
    if (t[13]) { pillarBadge.style.display = 'inline-block'; pillarBadge.innerText = t[13]; } else { pillarBadge.style.display = 'none'; }

    // 5. Remark
    const remarkContainer = document.getElementById('view-task-remark-container');
    const remarkContent = document.getElementById('view-task-remark');
    if (t[15]) { 
        remarkContainer.style.display = 'block'; 
        remarkContent.innerHTML = t[15].startsWith('http') ? `<a href="${t[15]}" target="_blank" class="text-break text-decoration-none"><i class="fas fa-external-link-alt me-1"></i> ${t[15]}</a>` : t[15];
    } else { remarkContainer.style.display = 'none'; }

    // 6. Attachments (File Upload) - แก้ไข position-relative แล้ว
    const resDiv = document.getElementById('view-task-resources');
    resDiv.innerHTML = ''; 

    if (t[9]) { 
        resDiv.innerHTML = `
        <div class="d-flex align-items-center p-2 border rounded bg-white position-relative">
            <div class="me-3 bg-light rounded-circle d-flex align-items-center justify-content-center" style="width:40px; height:40px;">
                <i class="fas fa-file-download text-primary"></i>
            </div>
            <div style="overflow:hidden;">
                <div class="fw-bold text-dark text-truncate" style="max-width:200px;">
                    ${t[10] || 'Attached File'}
                </div>
                <a href="${t[9]}" target="_blank" class="small text-primary text-decoration-none stretched-link">
                    Click to View/Download
                </a>
            </div>
        </div>`;
    } else {
        resDiv.innerHTML = '<div class="text-muted small fst-italic ps-2">- No Attachments -</div>';
    }

    // 7. Workflow
    renderWorkflowInModal(taskId);

    // 8. Actions Button (Revise & Edit Content)
    // 8. Actions Button (จัดการปุ่มกดด้านล่าง)
    const actionsDiv = document.getElementById('view-task-actions');
    let buttonsHtml = '';

    // ✅ เช็คเงื่อนไข: แสดงปุ่ม "สั่งแก้" เฉพาะเมื่อสถานะเป็น "Done" เท่านั้น
    if (t[5] === 'Done') {
        buttonsHtml += `
            <button class="btn btn-warning btn-sm rounded-pill px-3 me-2 text-dark fw-bold shadow-sm" 
                onclick="bootstrap.Modal.getInstance(document.getElementById('viewTaskModal')).hide(); openReviseModal('${t[0]}', '${t[3]}')">
                <i class="fas fa-undo-alt me-1"></i> สั่งแก้ (Revise)
            </button>
        `;
    }

    // ปุ่มแก้ไข Content (แสดงเฉพาะ Type Content และไม่ใช่สถานะ Done หรือ Revise ก็ได้ แล้วแต่ Workflow)
    if (taskType === 'Content') {
        buttonsHtml += `
            <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" 
                onclick="bootstrap.Modal.getInstance(document.getElementById('viewTaskModal')).hide(); openContentModal('${t[7]}', '${taskId}')">
                <i class="fas fa-edit me-1"></i> Edit Content
            </button>
        `;
    }

    actionsDiv.innerHTML = buttonsHtml;

    new bootstrap.Modal(document.getElementById('viewTaskModal')).show();
}

// --- ฟังก์ชันสำหรับระบบ Revise (ที่หายไป) ---

function openReviseModal(taskId, taskName) { 
      document.getElementById('revise-task-id').value = taskId; 
      document.getElementById('revise-task-name').value = taskName; 
      document.getElementById('revise-task-display-name').innerText = taskName;

      // สร้างตัวเลือกขั้นตอน (Step) ลงใน Dropdown
      const t = globalData.tasks.find(x => x[0] === taskId);
      const stepSelect = document.getElementById('revise-step-select');
      stepSelect.innerHTML = '';
      
      let steps = [];
      try { steps = t[12] ? JSON.parse(t[12]) : []; } catch(e) {}
      
      if(steps.length > 0) {
          steps.forEach((step, index) => {
              const opt = document.createElement('option');
              opt.value = index;
              opt.text = `${index+1}. ${step.name} (${step.assignee || 'Unassigned'})`;
              stepSelect.appendChild(opt);
          });
          // เลือกขั้นตอนล่าสุดที่ทำเสร็จไปแล้ว
          const lastDone = steps.map(s => s.status).lastIndexOf('done');
          if(lastDone !== -1) stepSelect.value = lastDone;
      } else {
          stepSelect.innerHTML = '<option value="-1">-- ไม่มีขั้นตอนระบุ --</option>';
      }

      // Reset Form
      document.getElementById('revise-reason').value = '';
      document.getElementById('revise-link').value = '';
      document.getElementById('revise-file').value = '';

      const today = new Date(); today.setDate(today.getDate()+1); 
      document.getElementById('revise-due-date').value = today.toISOString().split('T')[0]; 
      
      new bootstrap.Modal(document.getElementById('reviseModal')).show(); 
  }

  function submitRevise() { 
      const tid = document.getElementById('revise-task-id').value; 
      const tName = document.getElementById('revise-task-name').value; 
      const stepIndex = document.getElementById('revise-step-select').value;
      const reason = document.getElementById('revise-reason').value; 
      const link = document.getElementById('revise-link').value; 
      const newDueDate = document.getElementById('revise-due-date').value; 
      const fileInput = document.getElementById('revise-file').files[0]; 
      
      if(!reason) return alert('กรุณาระบุเหตุผลการแก้ไข'); 
      
      const btn = event.target; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> บันทึก...'; btn.disabled = true; 
      
      let msg = `🔥 สั่งแก้: "${tName}"\n📌 ขั้นตอน: ${document.getElementById('revise-step-select').options[document.getElementById('revise-step-select').selectedIndex].text}\n📅 ส่งภายใน: ${newDueDate}\n📝 เหตุผล: ${reason}`; 
      if(link) msg += `\n🔗 ลิงก์: ${link}`; 
      
      const me = globalData.currentUser.name; 
      const fileData = fileInput ? {name:fileInput.name, mimeType:fileInput.type} : null; 
      
      const exec = (fData) => { 
          google.script.run.withSuccessHandler((res) => { 
              if(res.fileUrl) msg += `\n📂 ไฟล์แนบ: ${res.fileName}`; 
              
              google.script.run.withSuccessHandler(() => { 
                  const t = globalData.tasks.find(x => x[0] === tid); 
                  if(t){ 
                      t[5] = 'Revise'; 
                      if(newDueDate) t[7] = newDueDate; 
                      if(link) t[8] = link;
                      if(res.fileUrl){ t[9] = res.fileUrl; t[10] = res.fileName; } 
                      if(res.updatedWorkflow) t[12] = res.updatedWorkflow;
                      if(res.newAssignee) t[4] = res.newAssignee;
                  } 
                  
                  if (currentProjectId) {
                      const projectTasks = globalData.tasks.filter(t => t[1] === currentProjectId);
                      renderListView(projectTasks); 
                      renderKanbanView(projectTasks); 
                      renderTimeline(currentProjectId); 
                  }
                  
                  bootstrap.Modal.getInstance(document.getElementById('reviseModal')).hide(); 
                  alert('สั่งแก้ไขงานเรียบร้อยแล้ว'); 
                  btn.innerHTML = 'ยืนยันสั่งแก้'; btn.disabled = false; 
              }).postProjectUpdate(currentProjectId, msg, me, null); 
          }).updateTaskRevision(tid, newDueDate, link, fData, stepIndex); 
      }; 
      
      if(fileInput){ 
          const r = new FileReader(); 
          r.onload = (e) => { fileData.data = e.target.result.split(',')[1]; exec(fileData); }; 
          r.readAsDataURL(fileInput); 
      } else { 
          exec(null); 
      } 
  }

function renderWorkflowInModal(taskId) {
    const container = document.getElementById('view-task-workflow');
    if(!container) return;
    
    container.innerHTML = ''; 

    const t = globalData.tasks.find(x => x[0] === taskId);
    if (!t) return;

    let steps = [];
    try { steps = t[12] ? JSON.parse(t[12]) : []; } catch(e) {}

    if (steps.length === 0) {
        container.innerHTML = '<div class="text-muted small fst-italic ps-2">- No Workflow defined -</div>';
        return;
    }

    let html = '<div class="workflow-timeline ps-3 border-start border-2 ms-2">';

    steps.forEach((step, index) => {
        let statusColor = 'bg-secondary';
        let icon = 'fa-circle';
        let statusText = 'Pending';
        let opacity = 'opacity-50'; 

        // ตรวจสอบสถานะ
        if (step.status === 'done') {
            statusColor = 'bg-success'; icon = 'fa-check'; statusText = 'Completed'; opacity = 'opacity-100';
        } else if (step.status === 'doing') {
            statusColor = 'bg-primary'; icon = 'fa-spinner fa-spin'; statusText = 'In Progress'; opacity = 'opacity-100';
        }

        // ✅ แก้ไขจุดนี้: ตรวจสอบชื่อผู้รับผิดชอบให้แม่นยำขึ้น
        const hasAssignee = step.assignee && step.assignee !== 'Unassigned' && step.assignee.trim() !== '';
        const assigneeName = hasAssignee ? step.assignee : 'ระบุผู้รับผิดชอบ (Click)';
        
        // ถ้ามีคนรับผิดชอบ ให้ตัวหนาสีเข้ม / ถ้าไม่มี ให้ตัวเอียงสีฟ้า
        const assigneeStyle = hasAssignee 
            ? 'text-dark fw-bold bg-light border px-2 py-1 rounded' 
            : 'text-primary fst-italic px-1';

        const assigneeIcon = hasAssignee ? 'text-success' : 'text-secondary';

        html += `
        <div class="d-flex align-items-start mb-3 position-relative ${opacity}" style="margin-left: -24px;">
            
            <div class="rounded-circle ${statusColor} text-white d-flex align-items-center justify-content-center border border-white border-2 shadow-sm" 
                 style="width: 32px; height: 32px; min-width: 32px; z-index:1; cursor:pointer;"
                 onclick="toggleStepStatus('${taskId}', ${index})">
                 <i class="fas ${icon} small"></i>
            </div>
            
            <div class="ms-3 pt-1 w-100 bg-white rounded p-2 border shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold text-dark" style="font-size:0.85rem;">${step.name}</span>
                    <span class="badge ${statusColor} fw-normal rounded-pill" style="font-size:0.6rem;">${statusText}</span>
                </div>
                
                <div class="d-flex align-items-center small mt-2" 
                     style="cursor:pointer; width:fit-content;"
                     onclick="openAssignStepModal('${taskId}', ${index})">
                    
                    <i class="fas fa-user-circle me-2 ${assigneeIcon}"></i> 
                    <span class="${assigneeStyle}" style="font-size: 0.8rem;">
                        ${assigneeName}
                    </span>
                    ${!hasAssignee ? '<i class="fas fa-hand-pointer ms-2 text-warning fa-bounce" style="font-size:0.7rem;"></i>' : ''}
                </div>

                ${step.dueDate ? `<div class="text-danger x-small mt-2 ps-1 border-top pt-1"><i class="far fa-clock me-1"></i> Due: ${step.dueDate}</div>` : ''}
                
                ${step.details ? `<div class="p-2 bg-light rounded mt-2 text-secondary fst-italic border-start border-3 border-primary" style="font-size:0.75rem;">"${step.details}"</div>` : ''}
            </div>
        </div>`;
    });

    html += '</div>';
    container.innerHTML = html;
}

  // Manage Workflow (Edit/Add/Delete)
  function openManageWorkflow() {
    const taskId = document.getElementById('view-task-id').innerText;
    document.getElementById('manage-wf-task-id').value = taskId;
    const t = globalData.tasks.find(x => x[0] === taskId);
    tempWorkflow = t && t[12] ? JSON.parse(t[12]) : [];
    if(tempWorkflow.length === 0) tempWorkflow = [];
    renderManageWorkflowRows();
    bootstrap.Modal.getInstance(document.getElementById('viewTaskModal')).hide();
    new bootstrap.Modal(document.getElementById('manageWorkflowModal')).show();
  }

  function renderManageWorkflowRows() {
    const container = document.getElementById('manage-wf-container'); container.innerHTML = '';
    tempWorkflow.forEach((step, index) => {
        let userOptions = '<option value="Unassigned">Unassigned</option>';
        globalData.allUsers.forEach(u => { if (u.status !== 'Inactive') { const name = u.name || u; userOptions += `<option value="${name}" ${step.assignee === name ? 'selected' : ''}>${name}</option>`; } });

        const row = document.createElement('div');
        row.className = 'row px-2 align-items-center bg-white p-2 rounded shadow-sm border';
        row.innerHTML = `
            <div class="col-4"><input type="text" class="form-control form-control-sm fw-bold" value="${step.name}" onchange="updateTempWF(${index}, 'name', this.value)" placeholder="ชื่อขั้นตอน..."></div>
            <div class="col-3"><select class="form-select form-select-sm" onchange="updateTempWF(${index}, 'assignee', this.value)">${userOptions}</select></div>
            <div class="col-3"><input type="date" class="form-control form-control-sm" value="${step.dueDate || ''}" onchange="updateTempWF(${index}, 'dueDate', this.value)"></div>
            <div class="col-2 text-center"><button class="btn btn-outline-danger btn-sm border-0" onclick="removeWorkflowRow(${index})"><i class="fas fa-trash-alt"></i></button></div>`;
        container.appendChild(row);
    });
  }

  function updateTempWF(index, field, value) { tempWorkflow[index][field] = value; }
  function addWorkflowRow() { tempWorkflow.push({ name: 'ขั้นตอนใหม่ (New Step)', role: 'Any', status: 'pending', assignee: 'Unassigned', dueDate: '' }); renderManageWorkflowRows(); }
  function removeWorkflowRow(index) { if(confirm("ต้องการลบขั้นตอนนี้ใช่หรือไม่?")) { tempWorkflow.splice(index, 1); renderManageWorkflowRows(); } }

  // ฟังก์ชันบันทึก Workflow (ฉบับแก้ไข: อัปเดตหน้าจอทันที)
// ฟังก์ชันบันทึก Workflow (ฉบับแก้ไข: อัปเดตหน้าจอทันที ไม่ต้องปิดเปิดใหม่)
// ฟังก์ชันบันทึกการเปลี่ยนแปลง Workflow
function saveWorkflowChanges() {
    const taskId = document.getElementById('manage-wf-task-id').value;
    const btn = event.target;
    
    // 1. เปลี่ยนสถานะปุ่มเป็นกำลังบันทึก
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    btn.disabled = true;

    const newJson = JSON.stringify(tempWorkflow);

    google.script.run.withSuccessHandler((res) => {
        if(res.success) {
            // 2. อัปเดตข้อมูลในตัวแปร globalData ทันที (เพื่อให้ข้อมูลใหม่ล่าสุดอยู่ในหน่วยความจำ)
            const tIndex = globalData.tasks.findIndex(t => t[0] === taskId);
            if(tIndex !== -1) {
                globalData.tasks[tIndex][12] = newJson; // อัปเดต Column M
            }

            // 3. ปิดหน้าต่างจัดการ (Manage Modal)
            const manageModal = bootstrap.Modal.getInstance(document.getElementById('manageWorkflowModal'));
            if (manageModal) manageModal.hide();

            // 4. เปิดหน้าต่างดูงาน (View Task Modal) กลับมา
            const viewModalElement = document.getElementById('viewTaskModal');
            const viewModal = new bootstrap.Modal(viewModalElement);
            viewModal.show();

            // ✅✅ 5. หัวใจสำคัญ: สั่งวาดข้อมูลใหม่ลงไปใน div ทันที! ✅✅
            // เรียกฟังก์ชันนี้เพื่อให้ข้อมูลใน <div id="view-task-workflow"> อัปเดตเดี๋ยวนั้นเลย
            setTimeout(() => {
                 renderWorkflowInModal(taskId); 
            }, 200); // หน่วงเวลานิดนึงเพื่อให้ Modal เปิดเสร็จก่อน (กันพลาด)

        } else {
            alert("Error: " + res.message);
        }
        
        // คืนค่าปุ่ม
        btn.innerHTML = 'Save Workflow';
        btn.disabled = false;

    }).saveWorkflowDB(taskId, newJson);
}
  // --- Utility: Drag & Drop ---
  function allowDrop(ev) { ev.preventDefault(); } 
  function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); } 
  function drop(ev, newStatus) { 
      ev.preventDefault(); var data = ev.dataTransfer.getData("text"); var taskId = data.replace("card-", ""); 
      google.script.run.withSuccessHandler(() => { 
          const t = globalData.tasks.find(x => x[0] === taskId); if(t) t[5] = newStatus; 
          const tasks = globalData.tasks.filter(x => x[1] === currentProjectId); 
          renderKanbanView(tasks); renderListView(tasks); renderSummaryView(tasks); renderCalendarView(tasks); 
          sendSystemMessage(`🔄 Status Updated: "${t[3]}" → ${newStatus}`); 
      }).updateTaskProgress(taskId, newStatus, 0); 
  }

  // --- Utility: Chat & Polling ---
  function sendSystemMessage(msg) { /* Optional: Send auto msg to chat */ }
  function startPolling() { 
      if(pollingInterval) clearInterval(pollingInterval); 
      pollingInterval = setInterval(() => { 
          if(!currentProjectId) return; 
          google.script.run.withSuccessHandler((allData) => { 
              if(!allData.updates) return; 
              const updates = allData.updates.filter(u => u[1] === currentProjectId); 
              const newMsgs = []; 
              if(lastUpdateId) { 
                  const lastIdx = updates.findIndex(u => u[0] === lastUpdateId); 
                  if(lastIdx !== -1 && lastIdx < updates.length - 1) { for(let i=lastIdx+1; i<updates.length; i++) newMsgs.push(updates[i]); } 
              } else if(updates.length > 0 && !lastUpdateId) { } 
              
              if(newMsgs.length > 0) { 
                  newMsgs.forEach(msg => { if(msg[3] !== globalData.currentUser.name) { showToast(`New msg from ${msg[3]}`, msg[4]); updateBadge(1); } }); 
                  globalData.updates = allData.updates; renderTimeline(currentProjectId); lastUpdateId = updates[updates.length-1][0]; 
              } 
          }).getSystemData(); 
      }, 10000); 
  }
  function showToast(title, message) { 
      const container = document.getElementById('toast-area'); const toast = document.createElement('div'); toast.className = 'toast-alert'; 
      toast.innerHTML = `<div class="toast-header"><span><i class="fas fa-comment-dots text-primary me-2"></i> ${title}</span><button type="button" class="btn-close" style="font-size:0.7rem;" onclick="this.parentElement.parentElement.remove()"></button></div><div class="toast-body text-truncate">${message}</div>`; 
      container.appendChild(toast); setTimeout(() => { toast.style.opacity='0'; setTimeout(()=>toast.remove(),300); }, 5000); 
  }
  function updateBadge(count) { const badge = document.getElementById('noti-badge'); let current = parseInt(badge.innerText)||0; let next = current+count; badge.innerText = next; badge.style.display = next>0?'block':'none'; }
  function renderTimeline(pid) {
     const container = document.getElementById('timeline-container');
     const updates = (globalData.updates || []).filter(r => r[1] === pid);
     
     if(updates.length === 0) { 
         container.innerHTML = '<div class="text-center text-muted mt-5 small opacity-50"><i class="far fa-comments fa-3x mb-2"></i><br>เริ่มการสนทนา...</div>'; 
         return; 
     }
     
     let html = '';
     updates.forEach(m => {
        const isMe = m[3] === globalData.currentUser.name;
        let timeDisplay = m[2]; 
        try { let parts = m[2].split(' '); if (parts.length > 1) timeDisplay = parts[1]; } catch(e) {}
        
        let f = ''; 
        if(m[6]) { 
            if(m[5].match(/\.(jpg|png|jpeg|gif)$/i)) f = `<div class="img-container mt-2"><a href="${m[6]}" target="_blank"><img src="${m[6]}" class="chat-img"></a></div>`; 
            else f = `<a href="${m[6]}" target="_blank" class="btn btn-sm btn-light border mt-2 text-truncate" style="max-width:150px; font-size:0.8rem;"><i class="fas fa-file-download me-1"></i> ${m[5]}</a>`; 
        }
        html += `<div class="chat-row ${isMe ? 'me' : 'other'}"><div class="chat-meta">${isMe ? '' : `<span class="fw-bold text-dark">${m[3]}</span>`} <span>${timeDisplay}</span></div><div class="chat-bubble"><div>${m[4]}</div>${f}</div></div>`;
     });
     
     container.innerHTML = html;
     
     // ✅ แก้ไขตรงนี้: สั่งเลื่อนลงล่างสุด (Scroll to Bottom)
     setTimeout(() => {
        container.scrollTop = container.scrollHeight;
     }, 100);
  }
  function sendUpdate() {
     const txt = document.getElementById('new-update-input'); const msg = txt.value.trim(); 
     if(!msg && !selectedFile) return;
     const me = globalData.currentUser.name;
     document.getElementById('timeline-container').insertAdjacentHTML('beforeend', `<div class="chat-row me"><div class="chat-bubble" style="background-color:var(--ci-blue);color:white;">Sending...</div></div>`);
     let filePayload = null; 
     if (selectedFile) { filePayload = { name: selectedFile.name, mimeType: selectedFile.type, data: selectedFile.base64 }; }
     google.script.run.withSuccessHandler(res => { 
         if(!globalData.updates) globalData.updates = []; 
         globalData.updates.push([res.id, currentProjectId, res.date, me, msg, res.fileName, res.fileUrl]); 
         renderTimeline(currentProjectId); txt.value = ''; txt.style.height = 'auto'; clearFile(); 
     }).postProjectUpdate(currentProjectId, msg, me, filePayload);
  }
  function handleFileSelect(input) { 
      if(input.files && input.files[0]) { 
          selectedFile = input.files[0]; 
          const r = new FileReader(); 
          r.onload = function(e){ selectedFile.base64 = e.target.result.split(',')[1]; }; 
          r.readAsDataURL(selectedFile); 
          document.getElementById('upload-preview').style.display = 'flex'; 
          document.getElementById('preview-name').innerText = selectedFile.name; 
      } 
  }
  function clearFile() { selectedFile = null; document.getElementById('file-input').value = ''; document.getElementById('upload-preview').style.display = 'none'; }
 function openUpdateRemark(projectId, oldText) {
    document.getElementById('remark-project-id').value = projectId;
    document.getElementById('old-remark-text').innerText = oldText || '- ไม่มีข้อความเดิม -';
    document.getElementById('new-remark-text').value = oldText || ''; // ใส่ข้อความเดิมลงไปให้แก้เลย
    new bootstrap.Modal(document.getElementById('updateRemarkModal')).show();
}
  function saveRemark() {
    const pid = document.getElementById('remark-project-id').value;
    const newText = document.getElementById('new-remark-text').value;
    
    if(!newText.trim()) return alert('กรุณาระบุข้อความ');

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> บันทึก...';
    btn.disabled = true;

    const user = globalData.currentUser.name || 'User';
    const time = new Date().toLocaleString('th-TH', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'});
    // Format ข้อความใหม่ (ถ้าอยากให้มีชื่อคนแก้ต่อท้าย)
    const fullText = `${newText} (แก้ไขโดย ${user} ${time})`; 

    google.script.run.withSuccessHandler(() => {
        // 1. อัปเดตข้อมูลในตัวแปร globalData
        const p = globalData.projects.find(x => x[0] === pid);
        if(p) p[14] = fullText;

        // 2. อัปเดตหน้าจอทันที (ไม่ต้องโหลดใหม่)
        document.getElementById('remark-text-content').innerHTML = `<i class="fas fa-exclamation-circle me-1"></i> ${fullText}`;
        
        // ถ้าอยู่ในหน้า Dashboard ก็อัปเดตการ์ดด้วย (ถ้าเปิดอยู่)
        if(typeof renderProjects === 'function') renderProjects();

        // 3. ปิด Modal
        bootstrap.Modal.getInstance(document.getElementById('updateRemarkModal')).hide();
        
        // คืนค่าปุ่ม
        btn.innerHTML = originalText;
        btn.disabled = false;

    }).updateProjectRemark(pid, fullText); 
}
  function openAssignStepModal(taskId, stepIndex) {
    document.getElementById('workflow-task-id').value = taskId;
    document.getElementById('workflow-step-index').value = stepIndex;
    const t = globalData.tasks.find(x => x[0] === taskId);
    let steps = []; try { steps = JSON.parse(t[12] || '[]'); } catch(e){}
    const stepData = steps[stepIndex] || {};
    document.getElementById('workflow-step-date').value = stepData.dueDate || '';
    document.getElementById('workflow-step-details').value = stepData.details || '';
    const select = document.getElementById('workflow-assignee-select'); select.innerHTML = '<option value="Unassigned">-- ไม่ระบุ --</option>';
    if (globalData.allUsers) {
        const grouped = {}; globalData.allUsers.forEach(u => { if (u.status === 'Inactive') return; const role = u.role || 'Other'; if (!grouped[role]) grouped[role] = []; grouped[role].push(u.name || u); });
        for (const [role, names] of Object.entries(grouped)) { const group = document.createElement('optgroup'); group.label = role; names.forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.text = name; group.appendChild(opt); }); select.appendChild(group); }
    }
    if(stepData.assignee) select.value = stepData.assignee;
    new bootstrap.Modal(document.getElementById('assignStepModal')).show();
  }
  function saveStepAssignee() {
      const taskId = document.getElementById('workflow-task-id').value; const stepIndex = document.getElementById('workflow-step-index').value; const newName = document.getElementById('workflow-assignee-select').value; const newDate = document.getElementById('workflow-step-date').value; const newDetails = document.getElementById('workflow-step-details').value;
      const btn = event.target; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> บันทึก...'; btn.disabled = true;
      google.script.run.withSuccessHandler((res) => { renderWorkflowInModal(taskId); const t = globalData.tasks.find(x => x[0] === taskId); if (t) t[12] = res.workflowJson; bootstrap.Modal.getInstance(document.getElementById('assignStepModal')).hide(); btn.innerHTML = 'บันทึก'; btn.disabled = false; }).updateTaskWorkflowAssignee(taskId, stepIndex, newName, newDate, newDetails);
  }
  function toggleStepStatus(taskId, stepIndex) { 
      google.script.run.withSuccessHandler((res) => { 
          renderWorkflowInModal(taskId); 
          const t = globalData.tasks.find(x => x[0] === taskId); 
          if (t) { 
              t[12] = res.workflowJson; 
              if (res.newMainStatus) { 
                  t[5] = res.newMainStatus; 
                  const badge = document.getElementById('view-task-status-badge'); 
                  if (badge) { badge.innerText = res.newMainStatus; badge.className = `badge ${res.newMainStatus==='Done'?'bg-success':(res.newMainStatus==='Revise'?'bg-warning text-dark':'bg-primary')}`; } 
                  if (currentProjectId) { const projectTasks = globalData.tasks.filter(x => x[1] === currentProjectId); renderListView(projectTasks); renderKanbanView(projectTasks); renderSummaryView(projectTasks); } 
              } 
          } 
      }).updateTaskWorkflowStatus(taskId, stepIndex); 
  }
</script>
